<!doctype html><html lang=en><head><script async defer data-website-id=08a754c4-6690-46d7-bb80-8ff93cfa232f src=https://umami.oldwinter.top/umami.js></script><meta charset=utf-8><meta name=description content="Vue2 æºç é˜…è¯» å‡†å¤‡å·¥ä½œ vue ä¸­ä½¿ç”¨çš„ç±»å‹æ£€æŸ¥å·¥å…·æ˜¯ Flow.js æœ‰ç‚¹ç±»ä¼¼ TypeScript ã€‚
ç›®å½• 1 2 3 4 5 6 7  src â”œâ”€â”€ compiler # ç¼–è¯‘ç›¸å…³ åŒ…æ‹¬æŠŠæ¨¡æ¿è§£ææˆ ast è¯­æ³•æ ‘ï¼Œast è¯­æ³•æ ‘ä¼˜åŒ–ï¼Œä»£ç â½£æˆç­‰åŠŸèƒ½ã€‚ â”œâ”€â”€ core # æ ¸â¼¼ä»£ç  åŒ…æ‹¬å†…ç½®ç»„ä»¶ã€å…¨å±€ API å°è£…ï¼ŒVue å®ä¾‹åŒ–ã€è§‚å¯Ÿè€…ã€è™šæ‹Ÿ DOMã€â¼¯å…·å‡½æ•°ç­‰ç­‰ã€‚ â”œâ”€â”€ platforms # ä¸åŒå¹³å°çš„â½€æŒ webå’Œ weexå…¥å£ï¼Œ â”œâ”€â”€ server # æœåŠ¡ç«¯æ¸²æŸ“ â”œâ”€â”€ sfc # ."><title>Vue2 æºç é˜…è¯»</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://note.xiaopang.fun//icon.png><link href=https://note.xiaopang.fun/styles.b3e1e36b0403ac565c9392b3e23ef3b6.min.css rel=stylesheet><link href=https://note.xiaopang.fun/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://note.xiaopang.fun/js/darkmode.660407930f154820c5998c99422c74bb.min.js></script>
<script src=https://note.xiaopang.fun/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://note.xiaopang.fun/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js></script>
<script src=https://note.xiaopang.fun/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://note.xiaopang.fun/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://note.xiaopang.fun/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://note.xiaopang.fun/",fetchData=Promise.all([fetch("https://note.xiaopang.fun/indices/linkIndex.5d34c18cb5802c12304f1330c8df0edd.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://note.xiaopang.fun/indices/contentIndex.80062824eb006684aa96e829bc6f3dba.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://note.xiaopang.fun",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://note.xiaopang.fun",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-11MD77L81V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-11MD77L81V",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=search placeholder=æ”¯æŒæ ‡é¢˜åŠå…¨æ–‡æœç´¢...><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://note.xiaopang.fun/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://note.xiaopang.fun/>ğŸŒ¿æ•°å­—èŠ±å›­ğŸŒ¸</a></h1><div class=spacer></div><div id=search-icon><p>search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Vue2 æºç é˜…è¯»</h1><p class=meta>æœ€è¿‘ç¼–è¾‘äº
Jul 14, 2023</p><ul class=tags></ul><aside class=mainTOC><details><summary>ç›®å½•</summary><nav id=TableOfContents><ol><li><a href=#å‡†å¤‡å·¥ä½œ>å‡†å¤‡å·¥ä½œ</a><ol><li><a href=#ç›®å½•>ç›®å½•</a></li><li><a href=#é€‰æ‹©ç‰ˆæœ¬>é€‰æ‹©ç‰ˆæœ¬</a></li></ol></li><li><a href=#ä»å…¥å£å¼€å§‹>ä»å…¥å£å¼€å§‹</a><ol><li><a href=#init>init</a></li><li><a href=#mount>$mount</a></li><li><a href=#æ€»ç»“>æ€»ç»“</a></li></ol></li><li><a href=#ç»„ä»¶åŒ–>ç»„ä»¶åŒ–</a><ol><li><a href=#createelement><strong>createElement</strong></a></li><li><a href=#createcomponent>createComponent</a></li><li><a href=#patch>patch</a></li><li><a href=#æ€»ç»“-1>æ€»ç»“</a></li></ol></li><li><a href=#æ·±å…¥å“åº”å¼åŸç†>æ·±å…¥å“åº”å¼åŸç†</a><ol><li><a href=#å“åº”å¼å¯¹è±¡>å“åº”å¼å¯¹è±¡</a></li><li><a href=#nexttick>nextTick</a></li><li><a href=#ç‰¹æ®Šæƒ…å†µ>ç‰¹æ®Šæƒ…å†µ</a></li><li><a href=#è®¡ç®—å±æ€§-vs-ä¾¦å¬å±æ€§>è®¡ç®—å±æ€§ VS ä¾¦å¬å±æ€§</a></li><li><a href=#ç»„ä»¶æ›´æ–°>ç»„ä»¶æ›´æ–°</a></li></ol></li><li><a href=#ç¼–è¯‘>ç¼–è¯‘</a><ol><li><a href=#parse>parse</a></li><li><a href=#optimization>optimization</a></li><li><a href=#codegen>codegen</a></li></ol></li><li><a href=#æ‰©å±•>æ‰©å±•</a><ol><li><a href=#event>event</a></li><li><a href=#è‡ªå®šä¹‰äº‹ä»¶>è‡ªå®šä¹‰äº‹ä»¶</a></li><li><a href=#v-model>V-model</a></li><li><a href=#slot>Slot</a></li><li><a href=#keep-alive>keep-alive</a></li><li><a href=#transition>transition</a></li></ol></li><li><a href=#vue-route>Vue-Route</a><ol><li><a href=#vueuse>Vue.use</a></li></ol></li><li><a href=#vuex>[[Vuex]]</a></li><li><a href=#æ€»ç»“-2>æ€»ç»“</a></li></ol></nav></details></aside><a href=#vue2-æºç é˜…è¯»><h1 id=vue2-æºç é˜…è¯»><span class=hanchor arialabel=Anchor># </span>Vue2 æºç é˜…è¯»</h1></a><a href=#å‡†å¤‡å·¥ä½œ><h2 id=å‡†å¤‡å·¥ä½œ><span class=hanchor arialabel=Anchor># </span>å‡†å¤‡å·¥ä½œ</h2></a><p>vue ä¸­ä½¿ç”¨çš„ç±»å‹æ£€æŸ¥å·¥å…·æ˜¯ Flow.js æœ‰ç‚¹ç±»ä¼¼ TypeScript ã€‚</p><a href=#ç›®å½•><h3 id=ç›®å½•><span class=hanchor arialabel=Anchor># </span>ç›®å½•</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=nx>src</span>
</span></span><span class=line><span class=cl><span class=err>â”œâ”€â”€</span> <span class=nx>compiler</span> <span class=err>#</span> <span class=nx>ç¼–è¯‘ç›¸å…³</span> <span class=nx>åŒ…æ‹¬æŠŠæ¨¡æ¿è§£ææˆ</span> <span class=nx>ast</span> <span class=nx>è¯­æ³•æ ‘</span><span class=err>ï¼Œ</span><span class=nx>ast</span> <span class=nx>è¯­æ³•æ ‘ä¼˜åŒ–</span><span class=err>ï¼Œ</span><span class=nx>ä»£ç </span><span class=err>â½£</span><span class=nx>æˆç­‰åŠŸèƒ½</span><span class=err>ã€‚</span>
</span></span><span class=line><span class=cl><span class=err>â”œâ”€â”€</span> <span class=nx>core</span> <span class=err>#</span> <span class=nx>æ ¸</span><span class=err>â¼¼</span><span class=nx>ä»£ç </span>  <span class=nx>åŒ…æ‹¬å†…ç½®ç»„ä»¶</span><span class=err>ã€</span><span class=nx>å…¨å±€</span> <span class=nx>API</span> <span class=nx>å°è£…</span><span class=err>ï¼Œ</span><span class=nx>Vue</span> <span class=nx>å®ä¾‹åŒ–</span><span class=err>ã€</span><span class=nx>è§‚å¯Ÿè€…</span><span class=err>ã€</span><span class=nx>è™šæ‹Ÿ</span> <span class=nx>DOM</span><span class=err>ã€â¼¯</span><span class=nx>å…·å‡½æ•°ç­‰ç­‰</span><span class=err>ã€‚</span>
</span></span><span class=line><span class=cl><span class=err>â”œâ”€â”€</span> <span class=nx>platforms</span> <span class=err>#</span> <span class=nx>ä¸åŒå¹³å°çš„</span><span class=err>â½€</span><span class=nx>æŒ</span> <span class=nx>webå’Œ</span> <span class=nx>weexå…¥å£</span><span class=err>ï¼Œ</span>
</span></span><span class=line><span class=cl><span class=err>â”œâ”€â”€</span> <span class=nx>server</span> <span class=err>#</span> <span class=nx>æœåŠ¡ç«¯æ¸²æŸ“</span>
</span></span><span class=line><span class=cl><span class=err>â”œâ”€â”€</span> <span class=nx>sfc</span> <span class=err>#</span> <span class=p>.</span><span class=nx>vue</span> <span class=err>â½‚</span><span class=nx>ä»¶è§£æ</span>
</span></span><span class=line><span class=cl><span class=err>â”œâ”€â”€</span> <span class=nx>shared</span> <span class=err>#</span> <span class=nx>å…±äº«ä»£ç </span>
</span></span></code></pre></td></tr></table></div></div><a href=#é€‰æ‹©ç‰ˆæœ¬><h3 id=é€‰æ‹©ç‰ˆæœ¬><span class=hanchor arialabel=Anchor># </span>é€‰æ‹©ç‰ˆæœ¬</h3></a><ul><li><p>Runtime Only</p><p>æˆ‘ä»¬åœ¨ä½¿ç”¨ Runtime Only ç‰ˆæœ¬çš„ Vue.js çš„æ—¶å€™ï¼Œé€šå¸¸éœ€è¦å€ŸåŠ©å¦‚ webpack çš„ vue-loader â¼¯å…·æŠŠ .vue â½‚ ä»¶ç¼–è¯‘æˆ JavaScriptï¼Œå› ä¸ºæ˜¯åœ¨ç¼–è¯‘é˜¶æ®µåšçš„ï¼Œæ‰€ä»¥å®ƒåªåŒ…å«è¿è¡Œæ—¶çš„ Vue.js ä»£ç ï¼Œå› æ­¤ä»£ç ä½“ç§¯ä¹Ÿä¼š æ›´è½»é‡ã€‚</p></li><li><p>Runtime+Compiler</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// éœ€è¦ç¼–è¯‘å™¨çš„ç‰ˆæœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>new</span> <span class=nx>Vue</span><span class=p>({</span>
</span></span><span class=line><span class=cl><span class=nx>template</span><span class=o>:</span> <span class=s1>&#39;&lt;div&gt;{{ hi }}&lt;/div&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><a href=#ä»å…¥å£å¼€å§‹><h2 id=ä»å…¥å£å¼€å§‹><span class=hanchor arialabel=Anchor># </span>ä»å…¥å£å¼€å§‹</h2></a><p>åˆå§‹åŒ–å…¨å±€ api</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=nx>initGlobalAPI</span><span class=p>(</span><span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>initGlobalAPI</span> <span class=p>(</span><span class=nx>Vue</span><span class=o>:</span> <span class=nx>GlobalAPI</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Vue</span><span class=p>.</span><span class=nx>util</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>warn</span><span class=p>,</span> <span class=nx>extend</span><span class=p>,</span> <span class=nx>mergeOptions</span><span class=p>,</span> <span class=nx>defineReactive</span><span class=p>,</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>Vue</span><span class=p>.</span><span class=nx>set</span> <span class=o>=</span> <span class=nx>set</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>Vue</span><span class=p>.</span><span class=k>delete</span> <span class=o>=</span> <span class=nx>del</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>Vue</span><span class=p>.</span><span class=nx>nextTick</span> <span class=o>=</span> <span class=nx>nextTick</span><span class=p>;</span> <span class=c1>// TODOï¼šnnextTick
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>Vue</span><span class=p>.</span><span class=nx>options</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>ASSET_TYPES</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>type</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Vue</span><span class=p>.</span><span class=nx>options</span><span class=p>[</span><span class=nx>type</span> <span class=o>+</span> <span class=s2>&#34;s&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>Vue</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>_base</span> <span class=o>=</span> <span class=nx>Vue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>extend</span><span class=p>(</span><span class=nx>Vue</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>components</span><span class=p>,</span> <span class=nx>builtInComponents</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>initUse</span><span class=p>(</span><span class=nx>Vue</span><span class=p>);</span> <span class=c1>// TODOï¼šinitUse
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>);</span> <span class=c1>// TODOï¼šinitMixin
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initExtend</span><span class=p>(</span><span class=nx>Vue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>initAssetRegisters</span><span class=p>(</span><span class=nx>Vue</span><span class=p>);</span> <span class=c1>// æ³¨å†Œå®ç°Vue.component/directive/filter
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä¼ å…¥çš„ Vue å°†ç”Ÿå‘½å‘¨æœŸç­‰æ··å…¥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src\core\instance\index.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>Vue</span> <span class=p>(</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=o>!</span><span class=p>(</span><span class=k>this</span> <span class=k>instanceof</span> <span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;Vue is a constructor and should be called with the `new` keyword&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_init</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>initMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>stateMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>eventsMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>lifecycleMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>renderMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>Vue</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>æ‰€ä»¥ Vue æœ¬è´¨ä¸Šå°±æ˜¯â¼€ä¸ªç”¨ Function å®ç°çš„ Classï¼Œç„¶åå®ƒçš„åŸå‹ prototype ä»¥åŠå®ƒæœ¬â¾éƒ½æ‰©å±•äº†â¼€ç³»åˆ—çš„ æ–¹æ³•å’Œå±æ€§ï¼Œ</strong></p><a href=#init><h3 id=init><span class=hanchor arialabel=Anchor># </span>init</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/core/instance/init.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>initMixin</span> <span class=p>(</span><span class=nx>Vue</span><span class=o>:</span> <span class=nx>Class</span><span class=o>&lt;</span><span class=nx>Component</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_init</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>options</span><span class=o>?:</span> <span class=nb>Object</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=c1>// a uid
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_uid</span> <span class=o>=</span> <span class=nx>uid</span><span class=o>++</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>options</span> <span class=o>&amp;&amp;</span> <span class=nx>options</span><span class=p>.</span><span class=nx>_isComponent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>initInternalComponent</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span> <span class=o>=</span> <span class=nx>mergeOptions</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>resolveConstructorOptions</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>constructor</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>options</span> <span class=o>||</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// expose real self
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_self</span> <span class=o>=</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=nx>initLifecycle</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span> <span class=c1>// $parent,$root,$children,$refs
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initEvents</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span> <span class=c1>// å¤„ç†çˆ¶ç»„ä»¶ä¼ é€’çš„äº‹ä»¶å’Œå›è°ƒ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initRender</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span> <span class=c1>// $slots,$scopedSlots,_c,$createElement
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeCreate&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>initInjections</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span> <span class=c1>// è·å–æ³¨å…¥æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initState</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span> <span class=c1>// åˆå§‹åŒ–propsï¼Œmethodsï¼Œdataï¼Œcomputedï¼Œwatch
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initProvide</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span> <span class=c1>// æä¾›æ•°æ®æ³¨å…¥
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;created&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>el</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$mount</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>el</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Vue åˆå§‹åŒ–ä¸»è¦å°±å¹²äº†å‡ ä»¶äº‹æƒ…ï¼Œåˆå¹¶é…ç½®ï¼Œåˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸï¼Œåˆå§‹åŒ–äº‹ä»¶ä¸­å¿ƒï¼Œåˆå§‹åŒ–æ¸²æŸ“ï¼Œåˆå§‹ åŒ– dataã€propsã€computedã€watcher ç­‰ç­‰ã€‚</p><a href=#mount><h3 id=mount><span class=hanchor arialabel=Anchor># </span>$mount</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>mount</span> <span class=o>=</span> <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$mount</span>
</span></span><span class=line><span class=cl><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$mount</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>el</span><span class=o>?:</span> <span class=nx>string</span> <span class=o>|</span> <span class=nx>Element</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hydrating</span><span class=o>?:</span> <span class=kr>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>el</span> <span class=o>=</span> <span class=nx>el</span> <span class=o>&amp;&amp;</span> <span class=nx>query</span><span class=p>(</span><span class=nx>el</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* istanbul ignore if */</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>el</span> <span class=o>===</span> <span class=nb>document</span><span class=p>.</span><span class=nx>body</span> <span class=o>||</span> <span class=nx>el</span> <span class=o>===</span> <span class=nb>document</span><span class=p>.</span><span class=nx>documentElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=sb>`Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.`</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>$options</span>
</span></span><span class=line><span class=cl>  <span class=c1>// resolve template/el and convert to render function
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>options</span><span class=p>.</span><span class=nx>render</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>template</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>template</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>template</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>template</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>template</span><span class=p>.</span><span class=nx>charAt</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>===</span> <span class=s1>&#39;#&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>template</span> <span class=o>=</span> <span class=nx>idToTemplate</span><span class=p>(</span><span class=nx>template</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>template</span><span class=p>.</span><span class=nx>nodeType</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>template</span> <span class=o>=</span> <span class=nx>template</span><span class=p>.</span><span class=nx>innerHTML</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>template</span> <span class=o>=</span> <span class=nx>getOuterHTML</span><span class=p>(</span><span class=nx>el</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>template</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>options</span><span class=p>.</span><span class=nx>render</span> <span class=o>=</span> <span class=nx>render</span>
</span></span><span class=line><span class=cl>      <span class=nx>options</span><span class=p>.</span><span class=nx>staticRenderFns</span> <span class=o>=</span> <span class=nx>staticRenderFns</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>mount</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>el</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é¦–å…ˆï¼Œå®ƒ å¯¹ el åšäº†é™åˆ¶ï¼ŒVue ä¸èƒ½æŒ‚è½½åœ¨ body ã€ html è¿™æ ·çš„æ ¹èŠ‚ç‚¹ä¸Šã€‚</p><p>æ¥ä¸‹æ¥çš„æ˜¯å¾ˆå…³é”®çš„é€»è¾‘ â€”â€” å¦‚æœæ²¡æœ‰å®šä¹‰ render æ–¹æ³•ï¼Œåˆ™ä¼šæŠŠ el æˆ–è€… template å­—ç¬¦ä¸²<strong>è½¬æ¢æˆ render æ–¹æ³•</strong>ã€‚</p><a href=#mountcomponent><h4 id=mountcomponent><span class=hanchor arialabel=Anchor># </span>mountComponent</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/core/instance/lifecycle.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>mountComponent</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>el</span><span class=o>:</span> <span class=o>?</span><span class=nx>Element</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hydrating</span><span class=o>?:</span> <span class=kr>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>el</span>
</span></span><span class=line><span class=cl>  <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeMount&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>updateComponent</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* istanbul ignore if */</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>config</span><span class=p>.</span><span class=nx>performance</span> <span class=o>&amp;&amp;</span> <span class=nx>mark</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateComponent</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_name</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>id</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_uid</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>startTag</span> <span class=o>=</span> <span class=sb>`vue-perf-start:</span><span class=si>${</span><span class=nx>id</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>endTag</span> <span class=o>=</span> <span class=sb>`vue-perf-end:</span><span class=si>${</span><span class=nx>id</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>mark</span><span class=p>(</span><span class=nx>startTag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_render</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=nx>mark</span><span class=p>(</span><span class=nx>endTag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>measure</span><span class=p>(</span><span class=sb>`vue </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb> render`</span><span class=p>,</span> <span class=nx>startTag</span><span class=p>,</span> <span class=nx>endTag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>mark</span><span class=p>(</span><span class=nx>startTag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>_update</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>mark</span><span class=p>(</span><span class=nx>endTag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>measure</span><span class=p>(</span><span class=sb>`vue </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb> patch`</span><span class=p>,</span> <span class=nx>startTag</span><span class=p>,</span> <span class=nx>endTag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateComponent</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>_update</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_render</span><span class=p>(),</span> <span class=nx>hydrating</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>new</span> <span class=nx>Watcher</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>updateComponent</span><span class=p>,</span> <span class=nx>noop</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>before</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isMounted</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isDestroyed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeUpdate&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=kc>true</span> <span class=cm>/* isRenderWatcher */</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>hydrating</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_isMounted</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;mounted&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ä»ä¸Šâ¾¯çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œ mountComponent æ ¸â¼¼å°±æ˜¯å…ˆè°ƒç”¨ vm._render æ–¹æ³•å…ˆâ½£æˆè™šæ‹Ÿ Nodeï¼Œå†å®ä¾‹åŒ–â¼€ä¸ªæ¸²æŸ“ Watcher ï¼Œåœ¨å®ƒçš„å›è°ƒå‡½æ•°ä¸­ä¼šè°ƒç”¨ updateComponent æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨ vm._update æ›´æ–° DOMã€‚</p><p>Watcher åœ¨è¿™é‡Œèµ·åˆ°ä¸¤ä¸ªä½œç”¨ï¼Œâ¼€ä¸ªæ˜¯åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œå¦â¼€ä¸ªæ˜¯å½“ vm å®ä¾‹ä¸­çš„ç›‘æµ‹ çš„æ•°æ®å‘â½£å˜åŒ–çš„æ—¶å€™æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚</p><p>å‡½æ•°æœ€ååˆ¤æ–­ä¸ºæ ¹èŠ‚ç‚¹çš„æ—¶å€™è®¾ç½® vm._isMounted ä¸º true ï¼Œ è¡¨ç¤ºè¿™ä¸ªå®ä¾‹å·²ç»æŒ‚è½½äº†ï¼ŒåŒæ—¶æ‰§è¡Œ mounted é’©å­å‡½æ•°ã€‚ è¿™é‡Œæ³¨æ„ vm.$vnode è¡¨ç¤º Vue å®ä¾‹çš„çˆ¶è™šæ‹Ÿ Nodeï¼Œæ‰€ä»¥å®ƒä¸º Null åˆ™è¡¨ç¤º å½“å‰æ˜¯æ ¹ Vue çš„å®ä¾‹ã€‚</p><a href=#render><h4 id=render><span class=hanchor arialabel=Anchor># </span>render</h4></a><p>Vue çš„ _render æ–¹æ³•æ˜¯å®ä¾‹çš„â¼€ä¸ªç§æœ‰æ–¹æ³•ï¼Œå®ƒç”¨æ¥æŠŠå®ä¾‹æ¸²æŸ“æˆâ¼€ä¸ªè™šæ‹Ÿ Nodeã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>div</span> <span class=nx>id</span><span class=o>=</span><span class=s2>&#34;app&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>{{</span> <span class=nx>message</span> <span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>è½¬åŒ–æˆ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=nx>render</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>createElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;div&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>attrs</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>id</span><span class=o>:</span> <span class=s1>&#39;app&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=k>this</span><span class=p>.</span><span class=nx>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#virtual-dom><h4 id=virtual-dom><span class=hanchor arialabel=Anchor># </span>Virtual DOM</h4></a><p>Virtual DOM å°±æ˜¯ç”¨â¼€ä¸ªåŸâ½£çš„ JS å¯¹è±¡å»æè¿°â¼€ä¸ª DOM èŠ‚ç‚¹ï¼Œæ‰€ä»¥å®ƒæ¯”åˆ›å»ºâ¼€ä¸ª DOM çš„ä»£ä»·è¦ â¼©å¾ˆå¤šã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>class</span> <span class=nx>VNode</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>tag</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// æ ‡ç­¾
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>data</span><span class=o>:</span> <span class=nx>VNodeData</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// æ•°æ®
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>children</span><span class=o>:</span> <span class=o>?</span><span class=nb>Array</span><span class=o>&lt;</span><span class=nx>VNode</span><span class=o>&gt;</span><span class=p>;</span> <span class=c1>// å­èŠ‚ç‚¹
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>text</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// æ–‡æœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>elm</span><span class=o>:</span> <span class=nx>Node</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>ns</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>context</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// rendered in this component&#39;s scope
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>key</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=nx>number</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>componentOptions</span><span class=o>:</span> <span class=nx>VNodeComponentOptions</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>componentInstance</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// component instance
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>parent</span><span class=o>:</span> <span class=nx>VNode</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// component placeholder node
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// strictly internal
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>raw</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span> <span class=c1>// åŒ…å«åŸå§‹HTMLï¼Ÿ(ä»…é™æœåŠ¡å™¨)ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>isStatic</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span> <span class=c1>// æ˜¯é™æ€èŠ‚ç‚¹å—
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>isRootInsert</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span> <span class=c1>// è¿›å…¥Rootå¿…é¡»å—
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>isComment</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span> <span class=c1>// ç©ºæ³¨é‡Šå ä½ç¬¦?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>isCloned</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span> <span class=c1>// æ˜¯å…‹éš†èŠ‚ç‚¹å—?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>isOnce</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span> <span class=c1>// æ˜¯v-onceèŠ‚ç‚¹å—?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>asyncFactory</span><span class=o>:</span> <span class=nb>Function</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// å¼‚æ­¥ç»„ä»¶å·¥å‚å‡½æ•°ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>asyncMeta</span><span class=o>:</span> <span class=nb>Object</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>isAsyncPlaceholder</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>ssrContext</span><span class=o>:</span> <span class=nb>Object</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>fnContext</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// åŠŸèƒ½èŠ‚ç‚¹çš„çœŸå®ä¸Šä¸‹æ–‡è™šæ‹Ÿæœº
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>fnOptions</span><span class=o>:</span> <span class=o>?</span><span class=nx>ComponentOptions</span><span class=p>;</span> <span class=c1>// for SSR caching
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>devtoolsMeta</span><span class=o>:</span> <span class=o>?</span><span class=nb>Object</span><span class=p>;</span> <span class=c1>// ç”¨äºå­˜å‚¨DevToolsçš„åŠŸèƒ½æ¸²æŸ“ä¸Šä¸‹æ–‡
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>fnScopeId</span><span class=o>:</span> <span class=o>?</span><span class=nx>string</span><span class=p>;</span> <span class=c1>// functional scope id support
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>tag</span><span class=o>?:</span> <span class=nx>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=o>?:</span> <span class=nx>VNodeData</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>children</span><span class=o>?:</span> <span class=o>?</span><span class=nb>Array</span><span class=o>&lt;</span><span class=nx>VNode</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span><span class=o>?:</span> <span class=nx>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>elm</span><span class=o>?:</span> <span class=nx>Node</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span><span class=o>?:</span> <span class=nx>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>componentOptions</span><span class=o>?:</span> <span class=nx>VNodeComponentOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>asyncFactory</span><span class=o>?:</span> <span class=nb>Function</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// DEPRECATED: alias for componentInstance for backwards compat.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/* istanbul ignore next */</span>
</span></span><span class=line><span class=cl>  <span class=nx>get</span> <span class=nx>child</span> <span class=p>()</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>|</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>componentInstance</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¶å® VNode æ˜¯å¯¹çœŸå® DOM çš„â¼€ç§æŠ½è±¡æè¿°ï¼Œå®ƒçš„æ ¸å¿ƒå®šä¹‰æ— éå°±å‡ ä¸ªå…³é”®å±æ€§ï¼Œ<strong>æ ‡ç­¾åã€æ•°æ®ã€å­èŠ‚ç‚¹ã€é”®å€¼ç­‰</strong>ï¼Œå…¶å®ƒå±æ€§éƒ½æ˜¯éƒ½æ˜¯ç”¨æ¥æ‰©å±• VNode çš„çµæ´»æ€§ä»¥åŠå®ç°â¼€äº›ç‰¹æ®Š feature çš„ã€‚ç”±äº VNode åªæ˜¯ç”¨æ¥æ˜ å°„åˆ°çœŸå® DOM çš„æ¸²æŸ“ï¼Œä¸éœ€è¦åŒ…å«æ“ä½œ DOM çš„æ–¹æ³•ï¼Œå› æ­¤å®ƒæ˜¯éå¸¸è½»é‡å’Œç®€å•çš„ã€‚</p><a href=#update><h4 id=update><span class=hanchor arialabel=Anchor># </span>update</h4></a><p>Vue çš„ _update æ˜¯å®ä¾‹çš„â¼€ä¸ªç§æœ‰æ–¹æ³•ï¼Œ<strong>å®ƒè¢«è°ƒç”¨çš„æ—¶æœºæœ‰ 2 ä¸ªï¼Œâ¼€ä¸ªæ˜¯é¦–æ¬¡æ¸²æŸ“ï¼Œâ¼€ä¸ªæ˜¯æ•°æ®æ›´æ–°çš„æ—¶å€™ï¼›</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src/core/instance/lifecycle.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_update</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>vnode</span><span class=o>:</span> <span class=nx>VNode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=o>?:</span> <span class=kr>boolean</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>prevEl</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>prevVnode</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_vnode</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>restoreActiveInstance</span> <span class=o>=</span> <span class=nx>setActiveInstance</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_vnode</span> <span class=o>=</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Vue.prototype.__patch__ is injected in entry points
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// based on the rendering backend used.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>prevVnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// initial render
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* removeOnly */</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// updates
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>prevVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>restoreActiveInstance</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// update __vue__ reference
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>prevEl</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>prevEl</span><span class=p>.</span><span class=nx>__vue__</span> <span class=o>=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>.</span><span class=nx>__vue__</span> <span class=o>=</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// if parent is an HOC, update its $el as well
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>&amp;&amp;</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span> <span class=o>&amp;&amp;</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>===</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// updated hook is called by the scheduler to ensure that children are
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// updated in a parent&#39;s updated hook.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œé€»è¾‘ä¸ç”¨çœ‹ï¼Œä¸‹é¢ä¼šè¯¦ç»†è¯´ï¼Œæˆ‘ä»¬çŸ¥é“æœ€åä¼šè¿›å…¥<code>__patch__</code> å³å¯</p><p>æ ¸å¿ƒæ–¹æ³•<code>__patch__</code> åŒºåˆ†æœåŠ¡ç«¯æ¸²æŸ“</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/platforms/web/runtime/index.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>__patch__</span> <span class=o>=</span> <span class=nx>inBrowser</span> <span class=o>?</span> <span class=nx>patch</span> <span class=o>:</span> <span class=nx>noop</span>
</span></span><span class=line><span class=cl><span class=c1>// src\platforms\web\runtime\patch.js
</span></span></span><span class=line><span class=cl><span class=c1>//æ¯ä¸ªå¹³å°éƒ½æœ‰å„â¾ƒçš„ nodeOps å’Œ modules
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>patch</span><span class=o>:</span> <span class=nb>Function</span> <span class=o>=</span> <span class=nx>createPatchFunction</span><span class=p>({</span> <span class=nx>nodeOps</span><span class=p>,</span> <span class=nx>modules</span> <span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>VDom è¿›è¡Œ diff çš„åœ°æ–¹ ï¼Œåé¢å†æ¥åˆ†æ</p><p>// TODO:diff</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/core/vdom/patch.js
</span></span></span></code></pre></td></tr></table></div></div><a href=#æ€»ç»“><h3 id=æ€»ç»“><span class=hanchor arialabel=Anchor># </span>æ€»ç»“</h3></a><ul><li>é¦–å…ˆ new Vue()</li><li>=> init() è¿›è¡Œå…¨å±€å±æ€§å’Œç”Ÿå‘½å‘¨æœŸç­‰æ³¨å…¥<ul><li>beforeMount</li></ul></li><li>=> å°†$mount æŒ‚è½½</li><li>=> <code>_render</code> å‡½æ•°å°† temlate è½¬åŒ–æˆ Vdom</li><li>=> <code>_patch</code>å°† Vdom è½¬åŒ–æˆçœŸå® DOM<ul><li>åˆæ¬¡æ¸²æŸ“ï¼Œä¸ç”¨ diff</li><li>Dom å˜åŒ–ï¼Œdiff ç®—æ³•å å¼‚æ­¥æ›´æ–°</li></ul></li><li>æ¸²æŸ“å®Œæˆï¼Œç­‰å¾…æ›´æ–°<ul><li>Mounted</li></ul></li></ul><a href=#ç»„ä»¶åŒ–><h2 id=ç»„ä»¶åŒ–><span class=hanchor arialabel=Anchor># </span>ç»„ä»¶åŒ–</h2></a><a href=#createelement><h3 id=createelement><span class=hanchor arialabel=Anchor># </span><strong>createElement</strong></h3></a><p>createElement æœ‰ä¸‰ä¸ªåˆ†æ”¯é€»è¾‘</p><ol><li>å‡å¦‚æ˜¯æ™®é€šçš„ html æ ‡ç­¾ï¼Œæ¸²æŸ“ä¸€ä¸ª VNode</li><li>å‡å¦‚æ˜¯ componen ä¸” options ä¸­æ³¨å†Œäº† ï¼Œå°±è¿›å…¥ createComponent é€»è¾‘</li><li>ä¸å‘½å tagï¼Œä¹Ÿåˆ›å»ºä¸€ä¸ª VNode</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src\core\vdom\create-element.js  function _createElement
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>tag</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>Ctor</span>
</span></span><span class=line><span class=cl>    <span class=nx>ns</span> <span class=o>=</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>&amp;&amp;</span> <span class=nx>context</span><span class=p>.</span><span class=nx>$vnode</span><span class=p>.</span><span class=nx>ns</span><span class=p>)</span> <span class=o>||</span> <span class=nx>config</span><span class=p>.</span><span class=nx>getTagNamespace</span><span class=p>(</span><span class=nx>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>isReservedTag</span><span class=p>(</span><span class=nx>tag</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// platform built-in elements
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vnode</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>VNode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>config</span><span class=p>.</span><span class=nx>parsePlatformTagName</span><span class=p>(</span><span class=nx>tag</span><span class=p>),</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>undefined</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>context</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=o>!</span><span class=nx>data</span> <span class=o>||</span> <span class=o>!</span><span class=nx>data</span><span class=p>.</span><span class=nx>pre</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>Ctor</span> <span class=o>=</span> <span class=nx>resolveAsset</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>$options</span><span class=p>,</span> <span class=s1>&#39;components&#39;</span><span class=p>,</span> <span class=nx>tag</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// component
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>createComponent</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span> <span class=nx>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// unknown or unlisted namespaced elements
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// check at runtime because it may get assigned a namespace when its
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// parent normalizes children
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vnode</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>VNode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>tag</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>undefined</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>context</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ç»„ä»¶çš„æ„é€ å‡½æ•°
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>createComponent</span><span class=p>(</span><span class=nx>tag</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>children</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#createcomponent><h3 id=createcomponent><span class=hanchor arialabel=Anchor># </span>createComponent</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>createComponent</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>Ctor</span><span class=o>:</span> <span class=nx>Class</span><span class=o>&lt;</span><span class=nx>Component</span><span class=o>&gt;</span> <span class=o>|</span> <span class=nb>Function</span> <span class=o>|</span> <span class=nb>Object</span> <span class=o>|</span> <span class=k>void</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span><span class=o>:</span> <span class=o>?</span><span class=nx>VNodeData</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>context</span><span class=o>:</span> <span class=nx>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span><span class=o>:</span> <span class=o>?</span><span class=nb>Array</span><span class=o>&lt;</span><span class=nx>VNode</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>tag</span><span class=o>?:</span> <span class=nx>string</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>VNode</span> <span class=o>|</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>VNode</span><span class=o>&gt;</span> <span class=o>|</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// plain options object: turn it into a constructor
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Ctor</span> <span class=o>=</span> <span class=nx>baseCtor</span><span class=p>.</span><span class=nx>extend</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// async component
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>asyncFactory</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>cid</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>asyncFactory</span> <span class=o>=</span> <span class=nx>Ctor</span>
</span></span><span class=line><span class=cl>    <span class=nx>Ctor</span> <span class=o>=</span> <span class=nx>resolveAsyncComponent</span><span class=p>(</span><span class=nx>asyncFactory</span><span class=p>,</span> <span class=nx>baseCtor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>Ctor</span> <span class=o>===</span> <span class=kc>undefined</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// return a placeholder node for async component, which is rendered
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// as a comment node but preserves all the raw information for the node.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// the information will be used for async server-rendering and hydration.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=nx>createAsyncPlaceholder</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>asyncFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>tag</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>data</span> <span class=o>=</span> <span class=nx>data</span> <span class=o>||</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// resolve constructor options in case global mixins are applied after
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// component constructor creation
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>resolveConstructorOptions</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// transform component v-model data into props &amp; events
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>model</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>transformModel</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// extract props
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>propsData</span> <span class=o>=</span> <span class=nx>extractPropsFromVNodeData</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>Ctor</span><span class=p>,</span> <span class=nx>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// functional component
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>functional</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>createFunctionalComponent</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>,</span> <span class=nx>propsData</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>children</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>listeners</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>on</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span><span class=p>.</span><span class=nx>on</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>nativeOn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=kr>abstract</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// abstract components do not keep anything
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// other than props &amp; listeners &amp; slot
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// work around flow
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>slot</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>slot</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>slot</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span><span class=p>.</span><span class=nx>slot</span> <span class=o>=</span> <span class=nx>slot</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// install component management hooks onto the placeholder node
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>installComponentHooks</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// return a placeholder vnode
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>name</span> <span class=o>||</span> <span class=nx>tag</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>vnode</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>VNode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=sb>`vue-component-</span><span class=si>${</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>cid</span><span class=si>}${</span><span class=nx>name</span> <span class=o>?</span> <span class=sb>`-</span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb>`</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nx>Ctor</span><span class=p>,</span> <span class=nx>propsData</span><span class=p>,</span> <span class=nx>listeners</span><span class=p>,</span> <span class=nx>tag</span><span class=p>,</span> <span class=nx>children</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>asyncFactory</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å»æ‰å¤šä½™çš„åˆ¤æ–­ï¼Œå¯ä»¥æ•´ç†å‡ºä»–åšäº†ä¸‰ä»¶äº‹</p><a href=#æ„é€ å­ç±»æ„é€ å‡½æ•°><h4 id=æ„é€ å­ç±»æ„é€ å‡½æ•°><span class=hanchor arialabel=Anchor># </span>æ„é€ å­ç±»æ„é€ å‡½æ•°</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;app&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>components</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>HelloWorld</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// æˆ‘ä»¬å¹³æ—¶ä¼ å…¥çš„éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Ctor</span> <span class=o>=</span> <span class=nx>baseCtor</span><span class=p>.</span><span class=nx>extend</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>//src/core/global-api/extend.js
</span></span></span></code></pre></td></tr></table></div></div><p>Vue.extend çš„ä½œç”¨å°±æ˜¯æ„é€ â¼€ä¸ª Vue çš„å­ç±»ï¼Œå®ƒä½¿ç”¨â¼€ç§éå¸¸ç»å…¸çš„åŸå‹ç»§æ‰¿çš„æ–¹å¼æŠŠâ¼€ä¸ªçº¯å¯¹ è±¡è½¬æ¢â¼€ä¸ªç»§æ‰¿äº Vue çš„æ„é€ å™¨ Sub å¹¶è¿”å›ï¼Œç„¶åå¯¹ Sub è¿™ä¸ªå¯¹è±¡æœ¬â¾æ‰©å±•äº†â¼€äº›å±æ€§ï¼Œå¦‚æ‰© å±• options ã€æ·»åŠ å…¨å±€ API ç­‰ï¼›å¹¶ä¸”å¯¹é…ç½®ä¸­çš„ props å’Œ computed åšäº†åˆå§‹åŒ–â¼¯ä½œï¼›æœ€åå¯¹äº è¿™ä¸ª Sub æ„é€ å‡½æ•°åšäº†ç¼“å­˜ï¼Œé¿å…å¤šæ¬¡æ‰§è¡Œ Vue.extend çš„æ—¶å€™å¯¹åŒâ¼€ä¸ªå­ç»„ä»¶é‡å¤æ„é€ ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=nx>Vue</span><span class=p>.</span><span class=nx>extend</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>extendOptions</span><span class=o>:</span> <span class=nb>Object</span><span class=p>)</span><span class=o>:</span> <span class=nb>Function</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>extendOptions</span> <span class=o>=</span> <span class=nx>extendOptions</span> <span class=o>||</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>Super</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>SuperId</span> <span class=o>=</span> <span class=nx>Super</span><span class=p>.</span><span class=nx>cid</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>cachedCtors</span> <span class=o>=</span> <span class=nx>extendOptions</span><span class=p>.</span><span class=nx>_Ctor</span> <span class=o>||</span> <span class=p>(</span><span class=nx>extendOptions</span><span class=p>.</span><span class=nx>_Ctor</span> <span class=o>=</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cachedCtors</span><span class=p>[</span><span class=nx>SuperId</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>cachedCtors</span><span class=p>[</span><span class=nx>SuperId</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>extendOptions</span><span class=p>.</span><span class=nx>name</span> <span class=o>||</span> <span class=nx>Super</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>validateComponentName</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>Sub</span> <span class=o>=</span> <span class=kd>function</span> <span class=nx>VueComponent</span> <span class=p>(</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>_init</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>prototype</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>Super</span><span class=p>.</span><span class=nx>prototype</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>constructor</span> <span class=o>=</span> <span class=nx>Sub</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>cid</span> <span class=o>=</span> <span class=nx>cid</span><span class=o>++</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>options</span> <span class=o>=</span> <span class=nx>mergeOptions</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>Super</span><span class=p>.</span><span class=nx>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>extendOptions</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>[</span><span class=s1>&#39;super&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>Super</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// For props and computed properties, we define the proxy getters on
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// the Vue instances at extension time, on the extended prototype. This
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// avoids Object.defineProperty calls for each instance created.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>Sub</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>props</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>initProps</span><span class=p>(</span><span class=nx>Sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>Sub</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>computed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>initComputed</span><span class=p>(</span><span class=nx>Sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// allow further extension/mixin/plugin usage
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>extend</span> <span class=o>=</span> <span class=nx>Super</span><span class=p>.</span><span class=nx>extend</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>mixin</span> <span class=o>=</span> <span class=nx>Super</span><span class=p>.</span><span class=nx>mixin</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>use</span> <span class=o>=</span> <span class=nx>Super</span><span class=p>.</span><span class=nx>use</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// create asset registers, so extended classes
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// can have their private assets too.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ASSET_TYPES</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Sub</span><span class=p>[</span><span class=nx>type</span><span class=p>]</span> <span class=o>=</span> <span class=nx>Super</span><span class=p>[</span><span class=nx>type</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=c1>// enable recursive self-lookup
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Sub</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>components</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>Sub</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// keep a reference to the super options at extension time.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// later at instantiation we can check if Super&#39;s options have
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// been updated.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>superOptions</span> <span class=o>=</span> <span class=nx>Super</span><span class=p>.</span><span class=nx>options</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>extendOptions</span> <span class=o>=</span> <span class=nx>extendOptions</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>sealedOptions</span> <span class=o>=</span> <span class=nx>extend</span><span class=p>({},</span> <span class=nx>Sub</span><span class=p>.</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// cache constructor
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>cachedCtors</span><span class=p>[</span><span class=nx>SuperId</span><span class=p>]</span> <span class=o>=</span> <span class=nx>Sub</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>Sub</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#å®‰è£…ç»„ä»¶é’©å­å‡½æ•°><h4 id=å®‰è£…ç»„ä»¶é’©å­å‡½æ•°><span class=hanchor arialabel=Anchor># </span>å®‰è£…ç»„ä»¶é’©å­å‡½æ•°</h4></a><p>æ•´ä¸ª <strong>installComponentHooks</strong> çš„è¿‡ç¨‹å°±æ˜¯æŠŠ componentVNodeHooks çš„é’©å­å‡½æ•°åˆå¹¶åˆ° <strong>data.hook</strong> ä¸­ï¼Œåœ¨ VNode æ‰§è¡Œ patch çš„è¿‡ç¨‹ä¸­æ‰§è¡Œç›¸å…³çš„é’©å­å‡½æ•°,ä½†ä»–çš„ Marge ä¸æ˜¯è¦†ç›–ï¼Œè€Œæ˜¯æŒ‰é¡ºåºæ‰§è¡Œã€‚</p><a href=#å®ä¾‹åŒ–-vnode><h4 id=å®ä¾‹åŒ–-vnode><span class=hanchor arialabel=Anchor># </span>å®ä¾‹åŒ– VNode</h4></a><p>æœ€åâ¼€æ­¥éå¸¸ç®€å•ï¼Œé€šè¿‡ new VNode å®ä¾‹åŒ–â¼€ä¸ª vnode å¹¶è¿”å›ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å’Œæ™®é€šå…ƒç´ èŠ‚ç‚¹çš„ vnode ä¸åŒï¼Œç»„ä»¶çš„ vnode æ˜¯æ²¡æœ‰ children çš„ï¼Œè¿™ç‚¹å¾ˆå…³é”®ã€‚</p><a href=#patch><h3 id=patch><span class=hanchor arialabel=Anchor># </span>patch</h3></a><p><strong>æ‰§è¡Œ vm.patch å»æŠŠ VNode è½¬æ¢æˆçœŸæ­£çš„ DOM èŠ‚ç‚¹ã€‚</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src/core/vdom/patch.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>createElm</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>refElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>nested</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ownerArray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>index</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>createComponent</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>parentElm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#createcomponent-1><h4 id=createcomponent-1><span class=hanchor arialabel=Anchor># </span>createComponent</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl>	<span class=kd>function</span> <span class=nx>createComponent</span> <span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>parentElm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>i</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kr>const</span> <span class=nx>isReactivated</span> <span class=o>=</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>i</span><span class=p>.</span><span class=nx>keepAlive</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>i</span><span class=p>.</span><span class=nx>hook</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>i</span><span class=p>.</span><span class=nx>init</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>i</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* hydrating */</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>//è°ƒç”¨inité’©å­åï¼Œå¦‚æœvnodeä¸ºå­ç»„ä»¶ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>//å®ƒåº”è¯¥å·²ç»åˆ›å»ºå­å®ä¾‹å¹¶æŒ‚è½½å®ƒã€‚è¿™å­©å­ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>//ç»„ä»¶è¿˜è®¾ç½®äº†å ä½ç¬¦vnodeçš„elmã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>//åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¿”å›å…ƒç´ å³å¯å®Œæˆã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>//å±æ€§å›è°ƒæ‰§è¡Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>initComponent</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=c1>//è¿½åŠ åˆ°çˆ¶ç»„ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>insert</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>isReactivated</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>reactivateComponent</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>parentElm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å¦‚æœ vnode æ˜¯â¼€ä¸ªç»„ä»¶ VNodeï¼Œé‚£ä¹ˆæ¡ä»¶ä¼šæ»¡â¾œï¼Œå¹¶ä¸”å¾—åˆ° i å°±æ˜¯ init é’©å­å‡½æ•°ï¼Œæ‰§è¡Œ<code>_init</code></p><p>å­ç»„ä»¶çš„å®ä¾‹åŒ–å®é™…ä¸Šå°±æ˜¯åœ¨è¿™ä¸ªæ—¶æœºæ‰§è¡Œçš„ï¼Œå¹¶ä¸”å®ƒä¼šæ‰§è¡Œå®ä¾‹çš„ _init æ–¹æ³•ï¼Œ</p><a href=#_render><h4 id=_render><span class=hanchor arialabel=Anchor># </span>_render()</h4></a><p>ç„¶åè¿›è¡Œ_render()</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/core/instance/render.js
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_render</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span><span class=o>:</span> <span class=nx>VNode</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>render</span><span class=p>,</span> <span class=nx>_parentVnode</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>_parentVnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$scopedSlots</span> <span class=o>=</span> <span class=nx>normalizeScopedSlots</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>_parentVnode</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>scopedSlots</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span><span class=p>.</span><span class=nx>$slots</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span><span class=p>.</span><span class=nx>$scopedSlots</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>=</span> <span class=nx>_parentVnode</span>
</span></span><span class=line><span class=cl>    <span class=c1>// render self
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>currentRenderingInstance</span> <span class=o>=</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>render</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_renderProxy</span><span class=p>,</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$createElement</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœè¿”å›çš„æ•°ç»„åªåŒ…å«ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™å…è®¸å®ƒ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>vnode</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>createEmptyVNode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// set parent
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>parent</span> <span class=o>=</span> <span class=nx>_parentVnode</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æˆ‘ä»¬åªä¿ç•™å…³é”®éƒ¨åˆ†çš„ä»£ç ï¼Œè¿™é‡Œçš„ _parentVnode å°±æ˜¯å½“å‰ç»„ä»¶çš„çˆ¶ VNodeï¼Œâ½½ render å‡½æ•°â½£ æˆçš„ vnode å½“å‰ç»„ä»¶çš„æ¸²æŸ“ vnode ï¼Œ vnode çš„ parent æŒ‡å‘äº† _parentVnode ï¼Œä¹Ÿå°±æ˜¯ vm.$vnode ï¼Œå®ƒä»¬æ˜¯â¼€ç§çˆ¶å­çš„å…³ç³»ã€‚</p><a href=#_update><h4 id=_update><span class=hanchor arialabel=Anchor># </span>_update</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src/core/instance/lifecycle.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_update</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>vnode</span><span class=o>:</span> <span class=nx>VNode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=o>?:</span> <span class=kr>boolean</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>prevEl</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>prevVnode</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_vnode</span>
</span></span><span class=line><span class=cl>    <span class=c1>//æ˜¯ä¿æŒå½“å‰ä¸Šä¸‹â½‚çš„ Vue å®ä¾‹ï¼Œå®ƒæ˜¯åœ¨ lifecycle æ¨¡å—çš„å…¨å±€å˜é‡
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>restoreActiveInstance</span> <span class=o>=</span> <span class=nx>setActiveInstance</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_vnode</span> <span class=o>=</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Vue.prototype.__patch__ is injected in entry points
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// based on the rendering backend used.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>prevVnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// initial render
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* removeOnly */</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// updates
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>prevVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>restoreActiveInstance</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// update __vue__ reference
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>prevEl</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>prevEl</span><span class=p>.</span><span class=nx>__vue__</span> <span class=o>=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>.</span><span class=nx>__vue__</span> <span class=o>=</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// if parent is an HOC, update its $el as well
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>&amp;&amp;</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span> <span class=o>&amp;&amp;</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>===</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// updated hook is called by the scheduler to ensure that children are
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// updated in a parent&#39;s updated hook.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œè¦ç†æ¸…ï¼Œvm._vnode å’Œ vm.$vnode çš„å…³ç³»å°±æ˜¯â¼€ç§çˆ¶å­å…³ç³»ï¼Œç”¨ä»£ç è¡¨ç¤ºå°±æ˜¯ **vm.<code>vnode.parent </code>=== vm.$vnode**</p><p>restoreActiveInstance æ˜¯ç”¨æ¥ä¿æŒé€’å½’è¿‡ç¨‹ä¸­è®°å½•å½“å‰ vm çš„ parentï¼Œå½“â¼€ä¸ª vm å®ä¾‹å®Œæˆå®ƒçš„æ‰€æœ‰å­æ ‘çš„ patch æˆ–è€… update è¿‡ç¨‹åï¼Œ</p><p>restoreActiveInstance å›åˆ°ä»–çš„çˆ¶å®ä¾‹åï¼Œä¼ å…¥çš„ Vue å®ä¾‹å’Œ vm.$parent ä¾ç„¶èƒ½ä¿ç•™</p><a href=#__patch_><h4 id=__patch_><span class=hanchor arialabel=Anchor># </span><code>__patch_</code></h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* removeOnly */</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>patch</span> <span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>,</span> <span class=nx>removeOnly</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>isInitialPatch</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>insertedVnodeQueue</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=c1>// é¦–æ¬¡æ¸²æŸ“
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// empty mount (likely as component), create new root element
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>isInitialPatch</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=nx>createElm</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#createelm><h5 id=createelm><span class=hanchor arialabel=Anchor># </span>createElm</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl>	<span class=kd>function</span> <span class=nx>createElm</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>parentElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>refElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>nested</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ownerArray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>index</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>ownerArray</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// This vnode was used in a previous render!
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// now it&#39;s used as a new node, overwriting its elm would cause
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// potential patch errors down the road when it&#39;s used as an insertion
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// reference node. Instead, we clone the node on-demand before creating
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// associated DOM element for it.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>vnode</span> <span class=o>=</span> <span class=nx>ownerArray</span><span class=p>[</span><span class=nx>index</span><span class=p>]</span> <span class=o>=</span> <span class=nx>cloneVNode</span><span class=p>(</span><span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>vnode</span><span class=p>.</span><span class=nx>isRootInsert</span> <span class=o>=</span> <span class=o>!</span><span class=nx>nested</span> <span class=c1>// for transition enter check
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=p>(</span><span class=nx>createComponent</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>parentElm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>		<span class=kr>const</span> <span class=nx>children</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>children</span>
</span></span><span class=line><span class=cl>		<span class=kr>const</span> <span class=nx>tag</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>tag</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>tag</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>data</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>pre</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>creatingElmInVPre</span><span class=o>++</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>isUnknownElement</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>creatingElmInVPre</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>						<span class=s1>&#39;Unknown custom element: &lt;&#39;</span> <span class=o>+</span> <span class=nx>tag</span> <span class=o>+</span> <span class=s1>&#39;&gt; - did you &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>						<span class=s1>&#39;register the component correctly? For recursive components, &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>						<span class=s1>&#39;make sure to provide the &#34;name&#34; option.&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=nx>vnode</span><span class=p>.</span><span class=nx>context</span>
</span></span><span class=line><span class=cl>					<span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>ns</span>
</span></span><span class=line><span class=cl>				<span class=o>?</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>createElementNS</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>ns</span><span class=p>,</span> <span class=nx>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=o>:</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=nx>tag</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>setScope</span><span class=p>(</span><span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=cm>/* istanbul ignore if */</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>__WEEX__</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// in Weex, the default insertion order is parent-first.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// List items can be optimized to use children-first insertion
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// with append=&#34;tree&#34;.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=kr>const</span> <span class=nx>appendAsTree</span> <span class=o>=</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isTrue</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>appendAsTree</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>appendAsTree</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>invokeCreateHooks</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>insert</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>createChildren</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>appendAsTree</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>invokeCreateHooks</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>insert</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>createChildren</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>invokeCreateHooks</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>insert</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>pre</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>creatingElmInVPre</span><span class=o>--</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>isComment</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span> <span class=o>=</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>createComment</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>insert</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span> <span class=o>=</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>createTextNode</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>insert</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åˆå›åˆ°äº†è¿™é‡Œï¼Œå½“é‡åˆ°æ™®é€šçš„ VNode createComponent å°±ä¼šè¿”å› falseï¼Œç„¶åé‡æ–°ä¸Šé¢åˆ›å»ºçˆ¶å ä½ç¬¦ï¼Œå¹¶éå†æ‰€æœ‰å­ VNode è°ƒç”¨<strong>createElm</strong> å½“é‡åˆ°ç»„ä»¶ VNode åˆ™è¿›è¡Œæ·±å…¥çš„é€’å½’</p><p>åœ¨å®Œæˆç»„ä»¶çš„æ•´ä¸ª patch è¿‡ç¨‹åï¼Œæœ€åæ‰§è¡Œ <strong>insert(parentElm, vnode.elm, refElm)</strong> å®Œæˆç»„ä»¶çš„ DOM æ’å…¥ï¼Œ<strong>å¦‚æœç»„ä»¶ patch è¿‡ç¨‹ä¸­åˆåˆ›å»ºäº†å­ç»„ä»¶ï¼Œé‚£ä¹ˆ DOM çš„æ’å…¥é¡ºåºæ˜¯å…ˆå­åçˆ¶ã€‚</strong></p><a href=#æ€»ç»“-1><h3 id=æ€»ç»“-1><span class=hanchor arialabel=Anchor># </span>æ€»ç»“</h3></a><p>ç¬¬ä¸€æ¬¡æ¸²æŸ“ï¼Œæ²¡æœ‰ oldVodeTreeï¼Œå°±æ˜¯åˆ›å»ºå ä½ç¬¦ => éå†å­ VNode => é‡åˆ°ç»„ä»¶ VNode => å‘ä¸‹é€’å½’ ç„¶åå¼€å§‹ DOM æ“ä½œ ç›´åˆ°å›åˆ°å ä½ç¬¦çš„ä½ç½®ã€‚</p><p>è¿™ä¸€åœˆä¸‹æ¥ï¼ŒåŸºæœ¬çš„æ‰§è¡Œæµç¨‹å’Œä»£ç éƒ½æœ‰äº†çœ¼ç¼˜äº†ï¼Œæˆ‘ä»¬å¼€å§‹æ·±å…¥ä¸€äº›ç»†èŠ‚è¿›è¡Œå­¦ä¹ ã€‚</p><a href=#æ·±å…¥å“åº”å¼åŸç†><h2 id=æ·±å…¥å“åº”å¼åŸç†><span class=hanchor arialabel=Anchor># </span>æ·±å…¥å“åº”å¼åŸç†</h2></a><p>Vue çš„æ•°æ®é©±åŠ¨é™¤äº†æ•°æ®æ¸²æŸ“ DOM ä¹‹å¤–ï¼Œè¿˜æœ‰â¼€ä¸ªå¾ˆé‡è¦çš„ä½“ç°å°±æ˜¯<strong>æ•°æ®çš„å˜æ›´ä¼šè§¦å‘ DOM çš„å˜åŒ–</strong></p><a href=#å“åº”å¼å¯¹è±¡><h3 id=å“åº”å¼å¯¹è±¡><span class=hanchor arialabel=Anchor># </span>å“åº”å¼å¯¹è±¡</h3></a><p>è¿‡ Vue.js å®ç°å“åº”å¼çš„æ ¸â¼¼æ˜¯åˆ©ç”¨äº† ES5 çš„ <strong>Object.defineProperty</strong> ï¼Œ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Vue.js ä¸èƒ½å…¼å®¹ IE8 åŠä»¥ä¸‹æµè§ˆå™¨çš„åŸå› ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src\core\instance\state.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>initState</span> <span class=p>(</span><span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span><span class=p>.</span><span class=nx>_watchers</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>opts</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>props</span><span class=p>)</span> <span class=nx>initProps</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>props</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>methods</span><span class=p>)</span> <span class=nx>initMethods</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>methods</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>initData</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>observe</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_data</span> <span class=o>=</span> <span class=p>{},</span> <span class=kc>true</span> <span class=cm>/* asRootData */</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>computed</span><span class=p>)</span> <span class=nx>initComputed</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>computed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>watch</span> <span class=o>&amp;&amp;</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>watch</span> <span class=o>!==</span> <span class=nx>nativeWatch</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>initWatch</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>watch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>å…¶ä»–æš‚ä¸”ä¸ç®¡ï¼Œæˆ‘ä»¬å…ˆçœ‹åˆ°æœ‰ data æƒ…å†µä¸‹çš„ initData åšäº†ä»€ä¹ˆ</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯åˆå§‹åŒ–é¡ºåºæ˜¯ prop => methods => data => computed => watch</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>initData</span> <span class=p>(</span><span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_data</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>data</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=nx>getData</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>vm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=nx>data</span> <span class=o>||</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isPlainObject</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;data functions should return an object:\n&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// proxy data on instance
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>keys</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>props</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>props</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>methods</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>methods</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>keys</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>key</span> <span class=o>=</span> <span class=nx>keys</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>methods</span> <span class=o>&amp;&amp;</span> <span class=nx>hasOwn</span><span class=p>(</span><span class=nx>methods</span><span class=p>,</span> <span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=sb>`Method &#34;</span><span class=si>${</span><span class=nx>key</span><span class=si>}</span><span class=sb>&#34; has already been defined as a data property.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>vm</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>hasOwn</span><span class=p>(</span><span class=nx>props</span><span class=p>,</span> <span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sb>`The data property &#34;</span><span class=si>${</span><span class=nx>key</span><span class=si>}</span><span class=sb>&#34; is already declared as a prop. `</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=sb>`Use prop default value instead.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isReserved</span><span class=p>(</span><span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>proxy</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=sb>`_data`</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// observe data
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>observe</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=kc>true</span> <span class=cm>/* asRootData */</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>é¦–å…ˆæ˜¯æ¨èäº† function å†™æ³•ï¼Œobject è™½ç„¶æ”¯æŒä½†æ˜¯ä¼šç»™ä¸ª warn</li><li>å°†æ¯ä¸€ä¸ª data éƒ½ä» vm._data.xxx ä»£ç†åˆ° vm.xxx ä¸Š</li><li>å¦å¤–ä¸€ä¸ªå°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„ å°†éå†æ¯ä¸ª key è½¬å˜æˆå“åº”å¼</li></ol><p>proxy çš„å®ç° æ˜¯é€šè¿‡ defineProperty å°† vm._data çš„ get å’Œ set æ”¹æˆ nullï¼ŒåŒæ—¶å°† vm.xxx çš„è¯»å–éƒ½ç»‘å®šåˆ° vm._data è¯¦ç»†ä»£ç å°±ä¸è´´äº†</p><p>æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹ä¸‹æ ¸å¿ƒ observe çš„å®ç°</p><a href=#observe><h4 id=observe><span class=hanchor arialabel=Anchor># </span>observe</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>observe</span> <span class=p>(</span><span class=nx>value</span><span class=o>:</span> <span class=nx>any</span><span class=p>,</span> <span class=nx>asRootData</span><span class=o>:</span> <span class=o>?</span><span class=kr>boolean</span><span class=p>)</span><span class=o>:</span> <span class=nx>Observer</span> <span class=o>|</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=o>||</span> <span class=nx>value</span> <span class=k>instanceof</span> <span class=nx>VNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>ob</span><span class=o>:</span> <span class=nx>Observer</span> <span class=o>|</span> <span class=k>void</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>hasOwn</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=s1>&#39;__ob__&#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>value</span><span class=p>.</span><span class=nx>__ob__</span> <span class=k>instanceof</span> <span class=nx>Observer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ob</span> <span class=o>=</span> <span class=nx>value</span><span class=p>.</span><span class=nx>__ob__</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>shouldObserve</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=o>!</span><span class=nx>isServerRendering</span><span class=p>()</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=o>||</span> <span class=nx>isPlainObject</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Object</span><span class=p>.</span><span class=nx>isExtensible</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=o>!</span><span class=nx>value</span><span class=p>.</span><span class=nx>_isVue</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ob</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Observer</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>asRootData</span> <span class=o>&amp;&amp;</span> <span class=nx>ob</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ob</span><span class=p>.</span><span class=nx>vmCount</span><span class=o>++</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>ob</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™æ®µå¾ˆæ— è¶£ï¼Œå°±æ˜¯åˆ¤æ–­ VNode ä¸Šæ˜¯å¦å·²æœ‰ï¼Œæ²¡æœ‰å°±ç»‘ä¸Šä¸ª new Observer(value) ï¼Œ</p><a href=#observer><h4 id=observer><span class=hanchor arialabel=Anchor># </span>Observer</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Observer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>value</span><span class=o>:</span> <span class=nx>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>dep</span><span class=o>:</span> <span class=nx>Dep</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>vmCount</span><span class=o>:</span> <span class=nx>number</span><span class=p>;</span> <span class=c1>// number of vms that have this object as root $data
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span> <span class=p>(</span><span class=nx>value</span><span class=o>:</span> <span class=nx>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>dep</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Dep</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>vmCount</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=nx>def</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=s1>&#39;__ob__&#39;</span><span class=p>,</span> <span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>hasProto</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>protoAugment</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>arrayMethods</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>copyAugment</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>arrayMethods</span><span class=p>,</span> <span class=nx>arrayKeys</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>observeArray</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>walk</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Walk through all properties and convert them into
</span></span></span><span class=line><span class=cl><span class=cm>   * getter/setters. This method should only be called when
</span></span></span><span class=line><span class=cl><span class=cm>   * value type is Object.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>walk</span> <span class=p>(</span><span class=nx>obj</span><span class=o>:</span> <span class=nb>Object</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>keys</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>keys</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>defineReactive</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>keys</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>observeArray</span> <span class=p>(</span><span class=nx>items</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>any</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>items</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>observe</span><span class=p>(</span><span class=nx>items</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Observer çš„æ„é€ å‡½æ•°é€»è¾‘å¾ˆç®€å•ï¼Œé¦–å…ˆ<strong>å®ä¾‹åŒ– Dep å¯¹è±¡</strong>ï¼Œæ¥ç€é€šè¿‡æ‰§è¡Œ def å‡½æ•°æŠŠâ¾ƒâ¾å®ä¾‹æ·»åŠ åˆ°æ•°æ®å¯¹è±¡ value çš„ <strong>ob</strong> å±æ€§ä¸Šï¼Œåé¢å°±æ˜¯å¯¹å¯¹è±¡å’Œæ•°ç»„åŒºåˆ†éå†ï¼Œè¿›è¡Œå¯¹æ¯ä¸ª key å€¼çš„å“åº”å¼è½¬åŒ–ã€‚</p><a href=#definereactive><h4 id=definereactive><span class=hanchor arialabel=Anchor># </span>defineReactive</h4></a><p>defineReactive å‡½æ•°æœ€å¼€å§‹åˆå§‹åŒ– Dep å¯¹è±¡çš„å®ä¾‹ï¼Œæ¥ç€æ‹¿åˆ° obj çš„å±æ€§æè¿°ç¬¦ï¼Œç„¶åå¯¹å­å¯¹ è±¡é€’å½’è°ƒç”¨ observe æ–¹æ³•ï¼Œè¿™æ ·å°±ä¿è¯äº†æ— è®º obj çš„ç»“æ„å¤šå¤æ‚ï¼Œå®ƒçš„æ‰€æœ‰å­å±æ€§ä¹Ÿèƒ½å˜æˆå“åº”å¼çš„å¯¹è±¡ï¼Œè¿™æ ·æˆ‘ä»¬è®¿é—®æˆ–ä¿®æ”¹ obj ä¸­â¼€ä¸ªåµŒå¥—è¾ƒæ·±çš„å±æ€§ï¼Œä¹Ÿèƒ½è§¦å‘ getter å’Œ setterã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>defineReactive</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>obj</span><span class=o>:</span> <span class=nb>Object</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>val</span><span class=o>:</span> <span class=nx>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>customSetter</span><span class=o>?:</span> <span class=o>?</span><span class=nb>Function</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>shallow</span><span class=o>?:</span> <span class=kr>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>dep</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Dep</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>property</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>getOwnPropertyDescriptor</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>property</span> <span class=o>&amp;&amp;</span> <span class=nx>property</span><span class=p>.</span><span class=nx>configurable</span> <span class=o>===</span> <span class=kc>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// cater for pre-defined getter/setters
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>getter</span> <span class=o>=</span> <span class=nx>property</span> <span class=o>&amp;&amp;</span> <span class=nx>property</span><span class=p>.</span><span class=nx>get</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>setter</span> <span class=o>=</span> <span class=nx>property</span> <span class=o>&amp;&amp;</span> <span class=nx>property</span><span class=p>.</span><span class=nx>set</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=o>!</span><span class=nx>getter</span> <span class=o>||</span> <span class=nx>setter</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>arguments</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>val</span> <span class=o>=</span> <span class=nx>obj</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>childOb</span> <span class=o>=</span> <span class=o>!</span><span class=nx>shallow</span> <span class=o>&amp;&amp;</span> <span class=nx>observe</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>Object</span><span class=p>.</span><span class=nx>defineProperty</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>enumerable</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>configurable</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>get</span><span class=o>:</span> <span class=kd>function</span> <span class=nx>reactiveGetter</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>value</span> <span class=o>=</span> <span class=nx>getter</span> <span class=o>?</span> <span class=nx>getter</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=o>:</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>dep</span><span class=p>.</span><span class=nx>depend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>childOb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>childOb</span><span class=p>.</span><span class=nx>dep</span><span class=p>.</span><span class=nx>depend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>dependArray</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>set</span><span class=o>:</span> <span class=kd>function</span> <span class=nx>reactiveSetter</span> <span class=p>(</span><span class=nx>newVal</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>value</span> <span class=o>=</span> <span class=nx>getter</span> <span class=o>?</span> <span class=nx>getter</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=o>:</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>      <span class=cm>/* eslint-disable no-self-compare */</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>newVal</span> <span class=o>===</span> <span class=nx>value</span> <span class=o>||</span> <span class=p>(</span><span class=nx>newVal</span> <span class=o>!==</span> <span class=nx>newVal</span> <span class=o>&amp;&amp;</span> <span class=nx>value</span> <span class=o>!==</span> <span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=cm>/* eslint-enable no-self-compare */</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>customSetter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>customSetter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// #7981: for accessor properties without setter
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>getter</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>setter</span><span class=p>)</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>setter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setter</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>newVal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>val</span> <span class=o>=</span> <span class=nx>newVal</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>childOb</span> <span class=o>=</span> <span class=o>!</span><span class=nx>shallow</span> <span class=o>&amp;&amp;</span> <span class=nx>observe</span><span class=p>(</span><span class=nx>newVal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>dep</span><span class=p>.</span><span class=nx>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#ä¾èµ–æ”¶é›†><h4 id=ä¾èµ–æ”¶é›†><span class=hanchor arialabel=Anchor># </span>ä¾èµ–æ”¶é›†</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kd>let</span> <span class=nx>uid</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>class</span> <span class=nx>Dep</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>target</span><span class=o>:</span> <span class=o>?</span><span class=nx>Watcher</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>id</span><span class=o>:</span> <span class=nx>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>subs</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>Watcher</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=nx>uid</span><span class=o>++</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>subs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>addSub</span> <span class=p>(</span><span class=nx>sub</span><span class=o>:</span> <span class=nx>Watcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>subs</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>removeSub</span> <span class=p>(</span><span class=nx>sub</span><span class=o>:</span> <span class=nx>Watcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>remove</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>subs</span><span class=p>,</span> <span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>depend</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>addDep</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>notify</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// stabilize the subscriber list first
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>subs</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>subs</span><span class=p>.</span><span class=nx>slice</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>config</span><span class=p>.</span><span class=kr>async</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// subs aren&#39;t sorted in scheduler if not running async
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// we need to sort them now to make sure they fire in correct
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// order
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>subs</span><span class=p>.</span><span class=nx>sort</span><span class=p>((</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>a</span><span class=p>.</span><span class=nx>id</span> <span class=o>-</span> <span class=nx>b</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>subs</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>subs</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>update</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Dep æ˜¯â¼€ä¸ª Classï¼Œå®ƒå®šä¹‰äº†â¼€äº›å±æ€§å’Œæ–¹æ³•ï¼Œè¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯å®ƒæœ‰â¼€ä¸ªé™æ€å±æ€§ target ï¼Œ è¿™æ˜¯â¼€ä¸ªå…¨å±€å”¯â¼€ Watcher ï¼Œè¿™æ˜¯â¼€ä¸ªéå¸¸å·§å¦™çš„è®¾è®¡ï¼Œå› ä¸ºåœ¨åŒâ¼€æ—¶é—´åªèƒ½æœ‰â¼€ä¸ªå…¨å±€çš„ Watcher è¢«è®¡ç®—ï¼Œå¦å¤–å®ƒçš„è‡ªèº«å±æ€§ subs ä¹Ÿæ˜¯ Watcher çš„æ•°ç»„ã€‚</p><p>Vue çš„ mount è¿‡ç¨‹æ˜¯é€šè¿‡ mountComponent å‡½æ•°ï¼Œå…¶ä¸­æœ‰â¼€æ®µæ¯”è¾ƒé‡è¦çš„é€»è¾‘ï¼Œå¤§è‡´å¦‚ä¸‹</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl>  <span class=nx>updateComponent</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>_update</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_render</span><span class=p>(),</span> <span class=nx>hydrating</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>new</span> <span class=nx>Watcher</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>updateComponent</span><span class=p>,</span> <span class=nx>noop</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>before</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isMounted</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isDestroyed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeUpdate&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=kc>true</span> <span class=cm>/* isRenderWatcher */</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>æ¯ä¸€ä¸ªç»„ä»¶éƒ½ä¼šç”Ÿæˆä¸€ä¸ª Watcher é‡Œé¢ç”Ÿæˆä¸€ä¸ª Dep(),é‡Œé¢æ¯ä¸ªå¯¹è±¡å€¼éƒ½æŒæœ‰ä¸€ä¸ª depï¼Œå½“ render æ—¶ï¼Œä¼šè§¦å‘æ‰€æœ‰æ•°æ®çš„ getter è¿›è¡Œ dep.append() æ–¹æ³•ï¼ˆè¿™é‡Œä¼šåšé€»è¾‘åˆ¤æ–­ï¼Œé˜²æ­¢åŒæ ·çš„æ•°æ®é‡å¤æ·»åŠ ï¼‰ã€‚å°±å®Œæˆäº†ä¾èµ–æ”¶é›†ï¼Œ</strong></p><p>æ¥ä¸‹æ¥å› ä¸º Vue æ˜¯æ•°æ®é©±åŠ¨çš„ï¼Œæ‰€ä»¥æ¯æ¬¡æ•°æ®å˜åŒ–éƒ½ä¼šé‡æ–° renderï¼Œé‚£ä¹ˆ vm._render() æ–¹æ³•åˆä¼šå†æ¬¡æ‰§è¡Œï¼Œå¹¶å†æ¬¡è§¦å‘æ•°æ®çš„ gettersï¼Œ<strong>æ‰€ä»¥ Wathcer åœ¨æ„é€ å‡½æ•°ä¸­ä¼šåˆå§‹åŒ– 2 ä¸ª Dep å®ä¾‹æ•°ç»„ï¼Œ newDeps è¡¨ç¤ºæ–°æ·»åŠ çš„ Dep å®ä¾‹æ•°ç»„ï¼Œè€Œ deps è¡¨ç¤ºä¸Šâ¼€æ¬¡æ·»åŠ çš„ Dep å®ä¾‹æ•°ç»„ã€‚</strong> åœ¨æ‰§è¡Œ cleanupDeps å‡½æ•°çš„æ—¶å€™ï¼Œä¼šé¦–å…ˆéå† deps ï¼Œç§»é™¤å¯¹ dep çš„è®¢é˜…ï¼Œç„¶åæŠŠ newDepIds å’Œ depIds äº¤æ¢ï¼Œ newDeps å’Œ deps äº¤æ¢ï¼Œå¹¶æŠŠ newDepIds å’Œ newDeps æ¸…ç©ºã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src\core\observer\watcher.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span> <span class=nx>uid</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * A watcher parses an expression, collects dependencies,
</span></span></span><span class=line><span class=cl><span class=cm> * and fires callback when the expression value changes.
</span></span></span><span class=line><span class=cl><span class=cm> * This is used for both the $watch() api and directives.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>class</span> <span class=nx>Watcher</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>expression</span><span class=o>:</span> <span class=nx>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cb</span><span class=o>:</span> <span class=nb>Function</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>id</span><span class=o>:</span> <span class=nx>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>deep</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>user</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>lazy</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>sync</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>dirty</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>active</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>deps</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>Dep</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>newDeps</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>Dep</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>depIds</span><span class=o>:</span> <span class=nx>SimpleSet</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>newDepIds</span><span class=o>:</span> <span class=nx>SimpleSet</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>before</span><span class=o>:</span> <span class=o>?</span><span class=nb>Function</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>getter</span><span class=o>:</span> <span class=nb>Function</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>value</span><span class=o>:</span> <span class=nx>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>expOrFn</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=nb>Function</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>cb</span><span class=o>:</span> <span class=nb>Function</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span><span class=o>?:</span> <span class=o>?</span><span class=nb>Object</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isRenderWatcher</span><span class=o>?:</span> <span class=kr>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>vm</span> <span class=o>=</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isRenderWatcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>_watcher</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_watchers</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// options
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>deep</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>deep</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>user</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>user</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>lazy</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>lazy</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>sync</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>sync</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>before</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>before</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>deep</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>user</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>lazy</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>sync</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>cb</span> <span class=o>=</span> <span class=nx>cb</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=o>++</span><span class=nx>uid</span> <span class=c1>// uid for batching
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>active</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>dirty</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>lazy</span> <span class=c1>// for lazy watchers
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>deps</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>depIds</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>expression</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span>
</span></span><span class=line><span class=cl>      <span class=o>?</span> <span class=nx>expOrFn</span><span class=p>.</span><span class=nx>toString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=o>:</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// parse expression for getter
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>expOrFn</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>getter</span> <span class=o>=</span> <span class=nx>expOrFn</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>getter</span> <span class=o>=</span> <span class=nx>parsePath</span><span class=p>(</span><span class=nx>expOrFn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>getter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>getter</span> <span class=o>=</span> <span class=nx>noop</span>
</span></span><span class=line><span class=cl>        <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=sb>`Failed watching path: &#34;</span><span class=si>${</span><span class=nx>expOrFn</span><span class=si>}</span><span class=sb>&#34; `</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;Watcher only accepts simple dot-delimited paths. &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;For full control, use a function instead.&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>vm</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>lazy</span>
</span></span><span class=line><span class=cl>      <span class=o>?</span> <span class=kc>undefined</span>
</span></span><span class=line><span class=cl>      <span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Evaluate the getter, and re-collect dependencies.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>get</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pushTarget</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>getter</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>vm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>handleError</span><span class=p>(</span><span class=nx>e</span><span class=p>,</span> <span class=nx>vm</span><span class=p>,</span> <span class=sb>`getter for watcher &#34;</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>expression</span><span class=si>}</span><span class=sb>&#34;`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=nx>e</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// &#34;touch&#34; every property so they are all tracked as
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// dependencies for deep watching
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>deep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>traverse</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>popTarget</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>cleanupDeps</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Add a dependency to this directive.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>addDep</span> <span class=p>(</span><span class=nx>dep</span><span class=o>:</span> <span class=nx>Dep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>id</span> <span class=o>=</span> <span class=nx>dep</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>dep</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>depIds</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>dep</span><span class=p>.</span><span class=nx>addSub</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Clean up for dependency collection.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>cleanupDeps</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>dep</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>dep</span><span class=p>.</span><span class=nx>id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>dep</span><span class=p>.</span><span class=nx>removeSub</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>tmp</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>depIds</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>depIds</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span> <span class=o>=</span> <span class=nx>tmp</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span><span class=p>.</span><span class=nx>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>tmp</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>deps</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span> <span class=o>=</span> <span class=nx>tmp</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span><span class=p>.</span><span class=nx>length</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Subscriber interface.
</span></span></span><span class=line><span class=cl><span class=cm>   * Will be called when a dependency changes.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>update</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* istanbul ignore else */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>lazy</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>dirty</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sync</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>queueWatcher</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Scheduler job interface.
</span></span></span><span class=line><span class=cl><span class=cm>   * Will be called by the scheduler.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>run</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>active</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>value</span> <span class=o>!==</span> <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Deep watchers and watchers on Object/Arrays should fire even
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// when the value is the same, because the value may
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// have mutated.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>isObject</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>deep</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// set new value
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>oldValue</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>value</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>cb</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>oldValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>handleError</span><span class=p>(</span><span class=nx>e</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>,</span> <span class=sb>`callback for watcher &#34;</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>expression</span><span class=si>}</span><span class=sb>&#34;`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>cb</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>oldValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Evaluate the value of the watcher.
</span></span></span><span class=line><span class=cl><span class=cm>   * This only gets called for lazy watchers.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>evaluate</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>dirty</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Depend on all deps collected by this watcher.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>depend</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>depend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Remove self from all dependencies&#39; subscriber list.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>teardown</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>active</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// remove self from vm&#39;s watcher list
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// this is a somewhat expensive operation so we skip it
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// if the vm is being destroyed.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isBeingDestroyed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>remove</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_watchers</span><span class=p>,</span> <span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>      <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>removeSub</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>active</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#æ´¾å‘æ›´æ–°><h4 id=æ´¾å‘æ›´æ–°><span class=hanchor arialabel=Anchor># </span>æ´¾å‘æ›´æ–°</h4></a><p>setter çš„é€»è¾‘æœ‰ 2 ä¸ªå…³é”®çš„ç‚¹ï¼Œâ¼€ä¸ªæ˜¯ <strong>childOb = !shallow && observe(newVal)</strong> ï¼Œå¦‚æœ shallow ä¸º false çš„æƒ…å†µï¼Œä¼šå¯¹æ–°è®¾ç½®çš„å€¼å˜æˆâ¼€ä¸ªå“åº”å¼å¯¹è±¡ï¼›å¦â¼€ä¸ªæ˜¯ dep.notify() ï¼Œé€šçŸ¥æ‰€æœ‰çš„è®¢é˜…è€….</p><p><strong>Vue æ´¾å‘æ›´æ–°çš„æ—¶å€™åšäº†â¼€ä¸ªä¼˜åŒ–ç‚¹ï¼Œå®ƒå¹¶ä¸ä¼šæ¯æ¬¡æ•°æ®æ”¹å˜éƒ½è§¦å‘ watcher çš„å›è°ƒï¼Œè€Œæ˜¯æŠŠè¿™äº› watcher å…ˆæ·»åŠ åˆ°â¼€ä¸ªé˜Ÿåˆ—é‡Œï¼Œç„¶ååœ¨ nextTick åæ‰§è¡Œ flushSchedulerQueue ã€‚</strong></p><a href=#nexttick><h3 id=nexttick><span class=hanchor arialabel=Anchor># </span>nextTick</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl> <span class=c1>//src/core/util/next-tick.js
</span></span></span><span class=line><span class=cl><span class=c1>// ä»£ç åœ¨ä¸Šé¢ï¼Œå°±æ˜¯æµè§ˆå™¨å…¼å®¹æ€§ä»å¾®ä»»åŠ¡é™çº§åˆ°å®ä»»åŠ¡çš„è¿‡ç¨‹
</span></span></span></code></pre></td></tr></table></div></div><a href=#ç‰¹æ®Šæƒ…å†µ><h3 id=ç‰¹æ®Šæƒ…å†µ><span class=hanchor arialabel=Anchor># </span>ç‰¹æ®Šæƒ…å†µ</h3></a><a href=#set><h4 id=set><span class=hanchor arialabel=Anchor># </span>$set</h4></a><p>Vue è€ƒè™‘åˆ°åˆå§‹åŒ–æ—¶æœªå£°æ˜æƒ…å†µï¼Œæä¾›äº†$set æ–¹æ³•</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>set</span> <span class=p>(</span><span class=nx>target</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>any</span><span class=o>&gt;</span> <span class=o>|</span> <span class=nb>Object</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=nx>any</span><span class=p>,</span> <span class=nx>val</span><span class=o>:</span> <span class=nx>any</span><span class=p>)</span><span class=o>:</span> <span class=nx>any</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span> <span class=o>||</span> <span class=nx>isPrimitive</span><span class=p>(</span><span class=nx>target</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>warn</span><span class=p>(</span><span class=sb>`Cannot set reactive property on undefined, null, or primitive value: </span><span class=si>${</span><span class=p>(</span><span class=nx>target</span><span class=o>:</span> <span class=nx>any</span><span class=p>)</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isValidArrayIndex</span><span class=p>(</span><span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span><span class=p>.</span><span class=nx>length</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>max</span><span class=p>(</span><span class=nx>target</span><span class=p>.</span><span class=nx>length</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span><span class=p>.</span><span class=nx>splice</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=k>in</span> <span class=nx>target</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=nx>key</span> <span class=k>in</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>prototype</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>ob</span> <span class=o>=</span> <span class=p>(</span><span class=nx>target</span><span class=o>:</span> <span class=nx>any</span><span class=p>).</span><span class=nx>__ob__</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>target</span><span class=p>.</span><span class=nx>_isVue</span> <span class=o>||</span> <span class=p>(</span><span class=nx>ob</span> <span class=o>&amp;&amp;</span> <span class=nx>ob</span><span class=p>.</span><span class=nx>vmCount</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;Avoid adding reactive properties to a Vue instance or its root $data &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;at runtime - declare it upfront in the data option.&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>ob</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>defineReactive</span><span class=p>(</span><span class=nx>ob</span><span class=p>.</span><span class=nx>value</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>ob</span><span class=p>.</span><span class=nx>dep</span><span class=p>.</span><span class=nx>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>set</code>æ–¹æ³•æ¥æ”¶ 3 ä¸ªå‚æ•°ï¼Œ target å¯èƒ½æ˜¯æ•°ç»„æˆ–è€…æ˜¯æ™®é€šå¯¹è±¡ï¼Œ key ä»£è¡¨çš„æ˜¯æ•°ç»„çš„ä¸‹æ ‡æˆ–è€…æ˜¯å¯¹è±¡çš„é”®å€¼ï¼Œ val ä»£è¡¨æ·»åŠ çš„å€¼ã€‚</p><a href=#array><h4 id=array><span class=hanchor arialabel=Anchor># </span>Array</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src\core\observer\array.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>methodsToPatch</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>method</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// cache original method
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>original</span> <span class=o>=</span> <span class=nx>arrayProto</span><span class=p>[</span><span class=nx>method</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>def</span><span class=p>(</span><span class=nx>arrayMethods</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=kd>function</span> <span class=nx>mutator</span> <span class=p>(...</span><span class=nx>args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>original</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ob</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>__ob__</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>inserted</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=nx>method</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;push&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;unshift&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>inserted</span> <span class=o>=</span> <span class=nx>args</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;splice&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>inserted</span> <span class=o>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>inserted</span><span class=p>)</span> <span class=nx>ob</span><span class=p>.</span><span class=nx>observeArray</span><span class=p>(</span><span class=nx>inserted</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// notify change
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ob</span><span class=p>.</span><span class=nx>dep</span><span class=p>.</span><span class=nx>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>result</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>æ•°ç»„é€šè¿‡åŸç”Ÿæ–¹æ³•å¢åŠ çš„ Key éƒ½æ˜¯æ²¡æœ‰ç»è¿‡å“åº”å¼è½¬æ¢çš„ï¼Œæ‰€ä»¥ Vue æŠŠ pushï¼Œunshiftï¼Œsplice æ–¹æ³•é‡æ–°åŠ«æŒäº†ï¼Œå½“è°ƒç”¨è¿™äº›æ–¹æ³•æ—¶ï¼Œä¼šé‡æ–°éå†è½¬åŒ–ä¸€éã€‚</p><a href=#è®¡ç®—å±æ€§-vs-ä¾¦å¬å±æ€§><h3 id=è®¡ç®—å±æ€§-vs-ä¾¦å¬å±æ€§><span class=hanchor arialabel=Anchor># </span>è®¡ç®—å±æ€§ VS ä¾¦å¬å±æ€§</h3></a><a href=#initcomputed><h4 id=initcomputed><span class=hanchor arialabel=Anchor># </span>initComputed</h4></a><p>æˆ‘ä»¬åœ¨ initComputed ä¸­æ‰¾åˆ°äº†è¿™ä¸²ä»£ç </p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src/core/instance/state.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>createComputedGetter</span> <span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kd>function</span> <span class=nx>computedGetter</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>watcher</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>_computedWatchers</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>_computedWatchers</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>watcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>watcher</span><span class=p>.</span><span class=nx>dirty</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>watcher</span><span class=p>.</span><span class=nx>evaluate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>watcher</span><span class=p>.</span><span class=nx>depend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>watcher</span><span class=p>.</span><span class=nx>value</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl>  <span class=nx>evaluate</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>dirty</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è®¡ç®—å±æ€§æœ¬è´¨ä¸Šå°±æ˜¯â¼€ä¸ª<code>computed watcher</code> ï¼Œä¹Ÿäº†è§£äº†å®ƒçš„åˆ›å»ºè¿‡ç¨‹å’Œ è¢«è®¿é—®è§¦å‘ getter ä»¥åŠä¾èµ–æ›´æ–°çš„è¿‡ç¨‹ï¼Œå…¶å®è¿™æ˜¯æœ€æ–°çš„è®¡ç®—å±æ€§çš„å®ç°ï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆè®¾è®¡æ˜¯å› ä¸º Vue æƒ³ç¡®ä¿ä¸ä»…ä»…æ˜¯è®¡ç®—å±æ€§ä¾èµ–çš„å€¼å‘â½£å˜åŒ–ï¼Œè€Œæ˜¯<strong>å½“è®¡ç®—å±æ€§æœ€ç»ˆè®¡ç®—çš„å€¼å‘ç”Ÿå˜åŒ–æ‰ä¼šè§¦å‘</strong>æ¸²æŸ“ watcher é‡æ–°æ¸²æŸ“ï¼Œæœ¬è´¨ä¸Šæ˜¯â¼€ç§ä¼˜åŒ–ã€‚</p><a href=#initwatch><h4 id=initwatch><span class=hanchor arialabel=Anchor># </span>initWatch</h4></a><p>ä¾¦å¬å±æ€§ä¹Ÿæ˜¯åŸºäº Watcher å®ç°çš„ï¼Œå®ƒæ˜¯â¼€ä¸ª <code>user watcher</code> ã€‚å…¶å® Watcher â½€æŒäº† ä¸åŒçš„ç±»å‹ï¼Œä¸‹â¾¯æˆ‘ä»¬æ¢³ç†â¼€ä¸‹å®ƒæœ‰å“ªäº›ç±»å‹ä»¥åŠå®ƒä»¬çš„ä½œç”¨ã€‚</p><a href=#deep><h5 id=deep><span class=hanchor arialabel=Anchor># </span>deep</h5></a><p>æ™®é€šçš„ watch å€¼åªä¼šè§¦å‘æœ€å¤–å±‚å¯¹è±¡çš„ getterï¼Œæ‰€ä»¥æ— æ³•è®¢é˜…å…¶å˜åŒ–</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>deep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>traverse</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>//src/core/observer/traverse.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>_traverse</span> <span class=p>(</span><span class=nx>val</span><span class=o>:</span> <span class=nx>any</span><span class=p>,</span> <span class=nx>seen</span><span class=o>:</span> <span class=nx>SimpleSet</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>keys</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>isA</span> <span class=o>=</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=o>!</span><span class=nx>isA</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>val</span><span class=p>))</span> <span class=o>||</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>isFrozen</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span> <span class=o>||</span> <span class=nx>val</span> <span class=k>instanceof</span> <span class=nx>VNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>val</span><span class=p>.</span><span class=nx>__ob__</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>depId</span> <span class=o>=</span> <span class=nx>val</span><span class=p>.</span><span class=nx>__ob__</span><span class=p>.</span><span class=nx>dep</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>seen</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>depId</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>seen</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>depId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isA</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>i</span> <span class=o>=</span> <span class=nx>val</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=nx>_traverse</span><span class=p>(</span><span class=nx>val</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>seen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>keys</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>i</span> <span class=o>=</span> <span class=nx>keys</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=nx>_traverse</span><span class=p>(</span><span class=nx>val</span><span class=p>[</span><span class=nx>keys</span><span class=p>[</span><span class=nx>i</span><span class=p>]],</span> <span class=nx>seen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>traverse çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå®ƒå®é™…ä¸Šå°±æ˜¯å¯¹â¼€ä¸ªå¯¹è±¡åšæ·±å±‚é€’å½’éå†ï¼Œå› ä¸ºéå†è¿‡ç¨‹ä¸­å°±æ˜¯<strong>å¯¹â¼€ä¸ªå­å¯¹è±¡çš„è®¿é—®ï¼Œä¼šè§¦å‘å®ƒä»¬çš„ getter è¿‡ç¨‹</strong>ï¼Œè¿™æ ·å°±å¯ä»¥æ”¶é›†åˆ°ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯è®¢é˜…å®ƒä»¬å˜åŒ–çš„ watcher ï¼Œè¿™ä¸ªå‡½æ•°å®ç°è¿˜æœ‰â¼€ä¸ªå°çš„ä¼˜åŒ–ï¼Œéå†è¿‡ç¨‹ä¸­ä¼šæŠŠå­å“åº”å¼å¯¹è±¡é€šè¿‡å®ƒä»¬çš„ dep id è®° å½•åˆ° seenObjects ï¼Œé¿å…ä»¥åé‡å¤è®¿é—®ã€‚</p><a href=#sync><h5 id=sync><span class=hanchor arialabel=Anchor># </span>sync</h5></a><p>å½“å“åº”å¼æ•°æ®å‘é€å˜åŒ–åï¼Œè§¦å‘äº† watcher.update() ï¼Œ åªæ˜¯æŠŠè¿™ä¸ª watcher æ¨é€åˆ°â¼€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œåœ¨ nextTick åæ‰ä¼šçœŸæ­£æ‰§è¡Œ watcher çš„å›è°ƒå‡½æ•°ã€‚ä½†æ˜¯â¼€æ—¦æˆ‘ä»¬è®¾ç½®äº† sync ï¼Œå°±å¯ä»¥åœ¨å½“å‰ Tick ä¸­åŒæ­¥æ‰§è¡Œ watcher çš„å›è°ƒå‡½æ•°ã€‚</p><a href=#ç»„ä»¶æ›´æ–°><h3 id=ç»„ä»¶æ›´æ–°><span class=hanchor arialabel=Anchor># </span>ç»„ä»¶æ›´æ–°</h3></a><p>è¿™é‡Œå’Œåˆæ¬¡æ¸²æŸ“èµ°äº†ä¸åŒçš„ patch æ–¹å¼</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src\core\instance\lifecycle.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>prevVnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// initial render
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* removeOnly */</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// updates
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>prevVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>è¿™é‡Œæ‰§è¡Œ patch çš„é€»è¾‘å’Œé¦–æ¬¡æ¸²æŸ“æ˜¯ä¸â¼€æ ·çš„ï¼Œå› ä¸º oldVnode ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å®ƒå’Œ vnode éƒ½æ˜¯ VNode ç±»å‹ï¼Œæ¥ä¸‹æ¥ä¼šé€šè¿‡ <strong>sameVNode(oldVnode, vnode)</strong> åˆ¤æ–­å®ƒä»¬æ˜¯å¦æ˜¯ç›¸åŒçš„ VNode æ¥å†³å®šâ¾› ä¸åŒçš„æ›´æ–°é€»è¾‘ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span><span class=lnt>98
</span><span class=lnt>99
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl>   <span class=k>return</span> <span class=kd>function</span> <span class=nx>patch</span> <span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>,</span> <span class=nx>removeOnly</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>))</span> <span class=nx>invokeDestroyHook</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>isInitialPatch</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>insertedVnodeQueue</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// empty mount (likely as component), create new root element
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>isInitialPatch</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>            <span class=nx>createElm</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>isRealElement</span> <span class=o>=</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>nodeType</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isRealElement</span> <span class=o>&amp;&amp;</span> <span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// patch existing root node
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>patchVnode</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>removeOnly</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>isRealElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// mounting to a real element
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// check if this is server-rendered content and if we can perform
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// a successful hydration.
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>nodeType</span> <span class=o>===</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=nx>oldVnode</span><span class=p>.</span><span class=nx>hasAttribute</span><span class=p>(</span><span class=nx>SSR_ATTR</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>oldVnode</span><span class=p>.</span><span class=nx>removeAttribute</span><span class=p>(</span><span class=nx>SSR_ATTR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=nx>hydrating</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>hydrating</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=nx>hydrate</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nx>invokeInsertHook</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=k>return</span> <span class=nx>oldVnode</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                                <span class=s1>&#39;The client-side rendered virtual DOM tree is not matching &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                                <span class=s1>&#39;server-rendered content. This is likely caused by incorrect &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                                <span class=s1>&#39;HTML markup, for example nesting block-level elements inside &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                                <span class=s1>&#39;&lt;p&gt;, or missing &lt;tbody&gt;. Bailing hydration and performing &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                                <span class=s1>&#39;full client-side render.&#39;</span>
</span></span><span class=line><span class=cl>                            <span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// either not server-rendered, or hydration failed.
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// create an empty node and replace it
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=nx>oldVnode</span> <span class=o>=</span> <span class=nx>emptyNodeAt</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// replacing existing element
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kr>const</span> <span class=nx>oldElm</span> <span class=o>=</span> <span class=nx>oldVnode</span><span class=p>.</span><span class=nx>elm</span>
</span></span><span class=line><span class=cl>                <span class=kr>const</span> <span class=nx>parentElm</span> <span class=o>=</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>parentNode</span><span class=p>(</span><span class=nx>oldElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// create new node
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>createElm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// extremely rare edge case: do not insert if old element is in a
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// leaving transition. Only happens when combining transition +
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// keep-alive + HOCs. (#4590)
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=nx>oldElm</span><span class=p>.</span><span class=nx>_leaveCb</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=nx>parentElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>nextSibling</span><span class=p>(</span><span class=nx>oldElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// update parent placeholder node element, recursively
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>parent</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kd>let</span> <span class=nx>ancestor</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>parent</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>patchable</span> <span class=o>=</span> <span class=nx>isPatchable</span><span class=p>(</span><span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>while</span> <span class=p>(</span><span class=nx>ancestor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>destroy</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=o>++</span><span class=nx>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nx>cbs</span><span class=p>.</span><span class=nx>destroy</span><span class=p>[</span><span class=nx>i</span><span class=p>](</span><span class=nx>ancestor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=nx>ancestor</span><span class=p>.</span><span class=nx>elm</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=nx>patchable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>create</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=o>++</span><span class=nx>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nx>cbs</span><span class=p>.</span><span class=nx>create</span><span class=p>[</span><span class=nx>i</span><span class=p>](</span><span class=nx>emptyNode</span><span class=p>,</span> <span class=nx>ancestor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// #6513
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=c1>// invoke insert hooks that may have been merged by create hooks.
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=c1>// e.g. for directives that uses the &#34;inserted&#34; hook.
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=kr>const</span> <span class=nx>insert</span> <span class=o>=</span> <span class=nx>ancestor</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>hook</span><span class=p>.</span><span class=nx>insert</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=p>(</span><span class=nx>insert</span><span class=p>.</span><span class=nx>merged</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// start at index 1 to avoid re-invoking component mounted hook
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>insert</span><span class=p>.</span><span class=nx>fns</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                    <span class=nx>insert</span><span class=p>.</span><span class=nx>fns</span><span class=p>[</span><span class=nx>i</span><span class=p>]()</span>
</span></span><span class=line><span class=cl>                                <span class=p>}</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nx>registerRef</span><span class=p>(</span><span class=nx>ancestor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=nx>ancestor</span> <span class=o>=</span> <span class=nx>ancestor</span><span class=p>.</span><span class=nx>parent</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// destroy old node
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>removeVnodes</span><span class=p>([</span><span class=nx>oldVnode</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>tag</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>invokeDestroyHook</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>patchVnode çš„è§„åˆ™æ˜¯è¿™æ ·çš„ï¼š</p><p>1.å¦‚æœæ–°æ—§ VNode éƒ½æ˜¯é™æ€çš„ï¼ŒåŒæ—¶å®ƒä»¬çš„ key ç›¸åŒï¼ˆä»£è¡¨åŒä¸€èŠ‚ç‚¹ï¼‰ï¼Œå¹¶ä¸”æ–°çš„ VNode æ˜¯ clone æˆ–è€…æ˜¯æ ‡è®°äº† onceï¼ˆæ ‡è®° v-once å±æ€§ï¼Œåªæ¸²æŸ“ä¸€æ¬¡ï¼‰ï¼Œé‚£ä¹ˆåªéœ€è¦æ›¿æ¢ elm ä»¥åŠ componentInstance å³å¯ã€‚</p><p>2.æ–°è€èŠ‚ç‚¹å‡æœ‰ children å­èŠ‚ç‚¹ï¼Œåˆ™å¯¹å­èŠ‚ç‚¹è¿›è¡Œ diff æ“ä½œï¼Œè°ƒç”¨ updateChildrenï¼Œè¿™ä¸ª updateChildren ä¹Ÿæ˜¯ diff çš„æ ¸å¿ƒã€‚</p><p>3.å¦‚æœè€èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹è€Œæ–°èŠ‚ç‚¹å­˜åœ¨å­èŠ‚ç‚¹ï¼Œå…ˆæ¸…ç©ºè€èŠ‚ç‚¹ DOM çš„æ–‡æœ¬å†…å®¹ï¼Œç„¶åä¸ºå½“å‰ DOM èŠ‚ç‚¹åŠ å…¥å­èŠ‚ç‚¹ã€‚</p><p>4.å½“æ–°èŠ‚ç‚¹æ²¡æœ‰å­èŠ‚ç‚¹è€Œè€èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œåˆ™ç§»é™¤è¯¥ DOM èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹ã€‚</p><p>5.å½“æ–°è€èŠ‚ç‚¹éƒ½æ— å­èŠ‚ç‚¹çš„æ—¶å€™ï¼Œåªæ˜¯æ–‡æœ¬çš„æ›¿æ¢ã€‚</p><a href=#samenode><h4 id=samenode><span class=hanchor arialabel=Anchor># </span>samenode</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>sameVnode</span> <span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>a</span><span class=p>.</span><span class=nx>key</span> <span class=o>===</span> <span class=nx>b</span><span class=p>.</span><span class=nx>key</span> <span class=o>&amp;&amp;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>a</span><span class=p>.</span><span class=nx>tag</span> <span class=o>===</span> <span class=nx>b</span><span class=p>.</span><span class=nx>tag</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=nx>a</span><span class=p>.</span><span class=nx>isComment</span> <span class=o>===</span> <span class=nx>b</span><span class=p>.</span><span class=nx>isComment</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=nx>isDef</span><span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span> <span class=o>===</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=nx>sameInputType</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span> <span class=o>||</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>isTrue</span><span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>isAsyncPlaceholder</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=nx>a</span><span class=p>.</span><span class=nx>asyncFactory</span> <span class=o>===</span> <span class=nx>b</span><span class=p>.</span><span class=nx>asyncFactory</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=nx>isUndef</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>asyncFactory</span><span class=p>.</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>sameVnode çš„é€»è¾‘éå¸¸ç®€å•ï¼Œå¦‚æœä¸¤ä¸ª vnode çš„ key ä¸ç›¸ç­‰ï¼Œåˆ™æ˜¯ä¸åŒçš„ï¼›å¦åˆ™ç»§ç»­åˆ¤æ–­å¯¹äº åŒæ­¥ç»„ä»¶ï¼Œåˆ™åˆ¤æ–­ isComment ã€ data ã€ input ç±»å‹ç­‰æ˜¯å¦ç›¸åŒï¼Œå¯¹äºå¼‚æ­¥ç»„ä»¶ï¼Œåˆ™åˆ¤æ–­ asyncFactory æ˜¯å¦ç›¸åŒã€‚</p><a href=#updatechildren><h4 id=updatechildren><span class=hanchor arialabel=Anchor># </span>updateChildren</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl> <span class=kd>function</span> <span class=nx>updateChildren</span> <span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>oldCh</span><span class=p>,</span> <span class=nx>newCh</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>removeOnly</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldStartIdx</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>newStartIdx</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldEndIdx</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldStartVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldEndVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=nx>oldEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>newEndIdx</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>newEndVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=nx>newEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldKeyToIdx</span><span class=p>,</span> <span class=nx>idxInOld</span><span class=p>,</span> <span class=nx>elmToMove</span><span class=p>,</span> <span class=nx>refElm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// removeOnly is a special flag used only by &lt;transition-group&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// to ensure removed elements stay in correct relative positions
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// during leaving transitions
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>canMove</span> <span class=o>=</span> <span class=o>!</span><span class=nx>removeOnly</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>oldStartIdx</span> <span class=o>&lt;=</span> <span class=nx>oldEndIdx</span> <span class=o>&amp;&amp;</span> <span class=nx>newStartIdx</span> <span class=o>&lt;=</span> <span class=nx>newEndIdx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldStartVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldStartVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>++</span><span class=nx>oldStartIdx</span><span class=p>]</span> <span class=c1>// Vnode has been moved left
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldEndVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>--</span><span class=nx>oldEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldStartVnode</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/*å‰å››ç§æƒ…å†µå…¶å®æ˜¯æŒ‡å®škeyçš„æ—¶å€™ï¼Œåˆ¤å®šä¸ºåŒä¸€ä¸ªVNodeï¼Œåˆ™ç›´æ¥patchVnodeå³å¯ï¼Œåˆ†åˆ«æ¯”è¾ƒoldChä»¥åŠnewChçš„ä¸¤å¤´èŠ‚ç‚¹2*2=4ç§æƒ…å†µ*/</span>
</span></span><span class=line><span class=cl>        <span class=nx>patchVnode</span><span class=p>(</span><span class=nx>oldStartVnode</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldStartVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>++</span><span class=nx>oldStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>++</span><span class=nx>newStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>,</span> <span class=nx>newEndVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>patchVnode</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>,</span> <span class=nx>newEndVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldEndVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>--</span><span class=nx>oldEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>newEndVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>--</span><span class=nx>newEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldStartVnode</span><span class=p>,</span> <span class=nx>newEndVnode</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// Vnode moved right
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>patchVnode</span><span class=p>(</span><span class=nx>oldStartVnode</span><span class=p>,</span> <span class=nx>newEndVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>canMove</span> <span class=o>&amp;&amp;</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>insertBefore</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>nextSibling</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldStartVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>++</span><span class=nx>oldStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>newEndVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>--</span><span class=nx>newEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// Vnode moved left
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>patchVnode</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>canMove</span> <span class=o>&amp;&amp;</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>insertBefore</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>oldEndVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldEndVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>--</span><span class=nx>oldEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>++</span><span class=nx>newStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>          ç”Ÿæˆä¸€ä¸ªkeyä¸æ—§VNodeçš„keyå¯¹åº”çš„å“ˆå¸Œè¡¨ï¼ˆåªæœ‰ç¬¬ä¸€æ¬¡è¿›æ¥undefinedçš„æ—¶å€™ä¼šç”Ÿæˆï¼Œä¹Ÿä¸ºåé¢æ£€æµ‹é‡å¤çš„keyå€¼åšé“ºå«ï¼‰
</span></span></span><span class=line><span class=cl><span class=cm>          æ¯”å¦‚childreæ˜¯è¿™æ ·çš„ [{xx: xx, key: &#39;key0&#39;}, {xx: xx, key: &#39;key1&#39;}, {xx: xx, key: &#39;key2&#39;}]  beginIdx = 0   endIdx = 2
</span></span></span><span class=line><span class=cl><span class=cm>          ç»“æœç”Ÿæˆ{key0: 0, key1: 1, key2: 2}
</span></span></span><span class=line><span class=cl><span class=cm>        */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldKeyToIdx</span><span class=p>))</span> <span class=nx>oldKeyToIdx</span> <span class=o>=</span> <span class=nx>createKeyToOldIdx</span><span class=p>(</span><span class=nx>oldCh</span><span class=p>,</span> <span class=nx>oldStartIdx</span><span class=p>,</span> <span class=nx>oldEndIdx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=cm>/*å¦‚æœnewStartVnodeæ–°çš„VNodeèŠ‚ç‚¹å­˜åœ¨keyå¹¶ä¸”è¿™ä¸ªkeyåœ¨oldVnodeä¸­èƒ½æ‰¾åˆ°åˆ™è¿”å›è¿™ä¸ªèŠ‚ç‚¹çš„idxInOldï¼ˆå³ç¬¬å‡ ä¸ªèŠ‚ç‚¹ï¼Œä¸‹æ ‡ï¼‰*/</span>
</span></span><span class=line><span class=cl>        <span class=nx>idxInOld</span> <span class=o>=</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>newStartVnode</span><span class=p>.</span><span class=nx>key</span><span class=p>)</span> <span class=o>?</span> <span class=nx>oldKeyToIdx</span><span class=p>[</span><span class=nx>newStartVnode</span><span class=p>.</span><span class=nx>key</span><span class=p>]</span> <span class=o>:</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>idxInOld</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// New element
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=cm>/*newStartVnodeæ²¡æœ‰keyæˆ–è€…æ˜¯è¯¥keyæ²¡æœ‰åœ¨è€èŠ‚ç‚¹ä¸­æ‰¾åˆ°åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹*/</span>
</span></span><span class=line><span class=cl>          <span class=nx>createElm</span><span class=p>(</span><span class=nx>newStartVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>parentElm</span><span class=p>,</span> <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>++</span><span class=nx>newStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=cm>/*è·å–åŒkeyçš„è€èŠ‚ç‚¹*/</span>
</span></span><span class=line><span class=cl>          <span class=nx>elmToMove</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=nx>idxInOld</span><span class=p>]</span>
</span></span><span class=line><span class=cl>          <span class=cm>/* istanbul ignore if */</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>elmToMove</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*å¦‚æœelmToMoveä¸å­˜åœ¨è¯´æ˜ä¹‹å‰å·²ç»æœ‰æ–°èŠ‚ç‚¹æ”¾å…¥è¿‡è¿™ä¸ªkeyçš„DOMä¸­ï¼Œæç¤ºå¯èƒ½å­˜åœ¨é‡å¤çš„keyï¼Œç¡®ä¿v-forçš„æ—¶å€™itemæœ‰å”¯ä¸€çš„keyå€¼*/</span>
</span></span><span class=line><span class=cl>            <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=s1>&#39;It seems there are duplicate keys that is causing an update error. &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>              <span class=s1>&#39;Make sure each v-for item has a unique key.&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>elmToMove</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*Github:https://github.com/answershuto*/</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*å¦‚æœæ–°VNodeä¸å¾—åˆ°çš„æœ‰ç›¸åŒkeyçš„èŠ‚ç‚¹æ˜¯åŒä¸€ä¸ªVNodeåˆ™è¿›è¡ŒpatchVnode*/</span>
</span></span><span class=line><span class=cl>            <span class=nx>patchVnode</span><span class=p>(</span><span class=nx>elmToMove</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*å› ä¸ºå·²ç»patchVnodeè¿›å»äº†ï¼Œæ‰€ä»¥å°†è¿™ä¸ªè€èŠ‚ç‚¹èµ‹å€¼undefinedï¼Œä¹‹åå¦‚æœè¿˜æœ‰æ–°èŠ‚ç‚¹ä¸è¯¥èŠ‚ç‚¹keyç›¸åŒå¯ä»¥æ£€æµ‹å‡ºæ¥æç¤ºå·²æœ‰é‡å¤çš„key*/</span>
</span></span><span class=line><span class=cl>            <span class=nx>oldCh</span><span class=p>[</span><span class=nx>idxInOld</span><span class=p>]</span> <span class=o>=</span> <span class=kc>undefined</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*å½“æœ‰æ ‡è¯†ä½canMoveå®å¯ä»¥ç›´æ¥æ’å…¥oldStartVnodeå¯¹åº”çš„çœŸå®DOMèŠ‚ç‚¹å‰é¢*/</span>
</span></span><span class=line><span class=cl>            <span class=nx>canMove</span> <span class=o>&amp;&amp;</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>insertBefore</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>++</span><span class=nx>newStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// same key but different element. treat as new element
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=cm>/*å½“æ–°çš„VNodeä¸æ‰¾åˆ°çš„åŒæ ·keyçš„VNodeä¸æ˜¯sameVNodeçš„æ—¶å€™ï¼ˆæ¯”å¦‚è¯´tagä¸ä¸€æ ·æˆ–è€…æ˜¯æœ‰ä¸ä¸€æ ·typeçš„inputæ ‡ç­¾ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹*/</span>
</span></span><span class=line><span class=cl>            <span class=nx>createElm</span><span class=p>(</span><span class=nx>newStartVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>parentElm</span><span class=p>,</span> <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>++</span><span class=nx>newStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>oldStartIdx</span> <span class=o>&gt;</span> <span class=nx>oldEndIdx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/*å…¨éƒ¨æ¯”è¾ƒå®Œæˆä»¥åï¼Œå‘ç°oldStartIdx &gt; oldEndIdxçš„è¯ï¼Œè¯´æ˜è€èŠ‚ç‚¹å·²ç»éå†å®Œäº†ï¼Œæ–°èŠ‚ç‚¹æ¯”è€èŠ‚ç‚¹å¤šï¼Œæ‰€ä»¥è¿™æ—¶å€™å¤šå‡ºæ¥çš„æ–°èŠ‚ç‚¹éœ€è¦ä¸€ä¸ªä¸€ä¸ªåˆ›å»ºå‡ºæ¥åŠ å…¥åˆ°çœŸå®DOMä¸­*/</span>
</span></span><span class=line><span class=cl>      <span class=nx>refElm</span> <span class=o>=</span> <span class=nx>isUndef</span><span class=p>(</span><span class=nx>newCh</span><span class=p>[</span><span class=nx>newEndIdx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>])</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=nx>newCh</span><span class=p>[</span><span class=nx>newEndIdx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>].</span><span class=nx>elm</span>
</span></span><span class=line><span class=cl>      <span class=nx>addVnodes</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>,</span> <span class=nx>newCh</span><span class=p>,</span> <span class=nx>newStartIdx</span><span class=p>,</span> <span class=nx>newEndIdx</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>newStartIdx</span> <span class=o>&gt;</span> <span class=nx>newEndIdx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/*å¦‚æœå…¨éƒ¨æ¯”è¾ƒå®Œæˆä»¥åå‘ç°newStartIdx &gt; newEndIdxï¼Œåˆ™è¯´æ˜æ–°èŠ‚ç‚¹å·²ç»éå†å®Œäº†ï¼Œè€èŠ‚ç‚¹å¤šä½™æ–°èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦å°†å¤šä½™çš„è€èŠ‚ç‚¹ä»çœŸå®DOMä¸­ç§»é™¤*/</span>
</span></span><span class=line><span class=cl>      <span class=nx>removeVnodes</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>oldCh</span><span class=p>,</span> <span class=nx>oldStartIdx</span><span class=p>,</span> <span class=nx>oldEndIdx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#æ‰‹å†™ç®€å•-diff><h4 id=æ‰‹å†™ç®€å•-diff><span class=hanchor arialabel=Anchor># </span>æ‰‹å†™ç®€å• diff</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>patchNode</span> <span class=p>(</span><span class=nx>oldNode</span><span class=p>,</span> <span class=nx>newNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>oldChildren</span> <span class=o>=</span> <span class=nx>oldNode</span><span class=p>.</span><span class=nx>children</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>newChildren</span> <span class=o>=</span> <span class=nx>newNode</span><span class=p>.</span><span class=nx>children</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è€çš„æœ‰å­èŠ‚ç‚¹ï¼Œæ–°çš„æ²¡æœ‰å°±ç§»é™¤
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>oldChildren</span><span class=p>.</span><span class=nx>length</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>newChildren</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// remove oldChildren
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è€çš„æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œæ–°çš„æœ‰ å°± æ¸…ç©ºè€èŠ‚ç‚¹å¹¶å°†æ–°èŠ‚ç‚¹åŠ å…¥åˆ°DOMä¸‹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>oldChildren</span><span class=p>.</span><span class=nx>length</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>newChildren</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// oldChildren =null
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Dom.append(newChildren)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// éƒ½æ²¡æœ‰ å°±åªåšæ–‡æœ¬çš„æ›¿æ¢
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>oldChildren</span><span class=p>.</span><span class=nx>length</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>newChildren</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ›¿æ¢æ–‡æœ¬
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>update</span><span class=p>(</span><span class=nx>oldChildren</span><span class=p>,</span> <span class=nx>newChildren</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>someNode</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ä¼˜å…ˆåˆ¤æ–­ key æ˜¯å¦ç›¸åŒ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// å¼‚æ­¥ç»„ä»¶ åˆ¤æ–­ asyncFactory  æ˜¯å¦ç›¸åŒ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// åŒæ­¥ç»„ä»¶ åˆ¤æ–­input,data,isComment  æ˜¯å¦ç›¸åŒ
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>update</span> <span class=p>(</span><span class=nx>oldNode</span><span class=p>,</span> <span class=nx>newNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>newStart</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldStart</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldEnd</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>newEnd</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>oldStart</span> <span class=o>&lt;=</span> <span class=nx>oldEnd</span> <span class=o>&amp;&amp;</span> <span class=nx>newStart</span> <span class=o>&lt;=</span> <span class=nx>newEnd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// someNode åˆ¤æ–­å éƒ½è¿›å…¥ patchVnode
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//æ–°å¤´å’Œæ—§å¤´
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>newStart</span> <span class=o>===</span> <span class=nx>oldStart</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>newStart</span><span class=o>++</span>
</span></span><span class=line><span class=cl>            <span class=nx>oldStart</span><span class=o>++</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//æ—§å°¾å’Œæ–°å°¾
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>oldEnd</span> <span class=o>===</span> <span class=nx>newEnd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>oldEnd</span><span class=o>--</span>
</span></span><span class=line><span class=cl>            <span class=nx>newEnd</span><span class=o>--</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//æ—§å¤´å’Œæ–°å°¾
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>oldStart</span> <span class=o>===</span> <span class=nx>newEnd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>oldStart</span><span class=o>++</span>
</span></span><span class=line><span class=cl>            <span class=nx>newEnd</span><span class=o>--</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//æ–°å¤´å’Œæ—§å°¾
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>newStart</span> <span class=o>===</span> <span class=nx>oldEnd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>newStart</span><span class=o>++</span>
</span></span><span class=line><span class=cl>            <span class=nx>oldEnd</span><span class=o>--</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//éƒ½æ‰¾ä¸åˆ° å°±éå†oldNode ç”Ÿæˆä¸€ä¸ª {key:index} çš„Map
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>let</span> <span class=nx>oldKeyToIdx</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>oldKeyToIdx</span><span class=p>[</span><span class=nx>newStart</span><span class=p>.</span><span class=nx>key</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// move è¿™ä¸ªèŠ‚ç‚¹åˆ° oldStart ä¹‹å‰ ç„¶åç»§ç»­éå†
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>newStart</span><span class=o>++</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å¦‚æœæ‰¾ä¸åˆ°ï¼Œæˆ–è€… key ç›¸åŒ ä½†å†…å®¹ä¸ç›¸åŒ
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//createElmåˆ›å»ºä¸€ä¸ªæ–°çš„DOMèŠ‚ç‚¹ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//å¾ªç¯å®Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// æ–°çš„æ¯”è€çš„é•¿ addVnodes å¤šå‡ºæ¥çš„èŠ‚ç‚¹
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// è€çš„æ¯”æ–°çš„é•¿ removeVnodes å¤šå‡ºæ¥çš„èŠ‚ç‚¹
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#ç¼–è¯‘><h2 id=ç¼–è¯‘><span class=hanchor arialabel=Anchor># </span>ç¼–è¯‘</h2></a><p>ç¼–è¯‘å°±æ˜¯æŠŠæ¨¡æ¿ template ç¼–è¯‘â½£æˆ render ä»¥åŠ staticRenderFns ï¼Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>createCompiler</span> <span class=o>=</span> <span class=nx>createCompilerCreator</span><span class=p>(</span><span class=kd>function</span> <span class=nx>baseCompile</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=nx>template</span><span class=o>:</span> <span class=nx>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>options</span><span class=o>:</span> <span class=nx>CompilerOptions</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>CompiledResult</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>ast</span> <span class=o>=</span> <span class=nx>parse</span><span class=p>(</span><span class=nx>template</span><span class=p>.</span><span class=nx>trim</span><span class=p>(),</span> <span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>optimize</span><span class=p>(</span><span class=nx>ast</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>code</span> <span class=o>=</span> <span class=nx>generate</span><span class=p>(</span><span class=nx>ast</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>ast</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>render</span><span class=o>:</span> <span class=nx>code</span><span class=p>.</span><span class=nx>render</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>staticRenderFns</span><span class=o>:</span> <span class=nx>code</span><span class=p>.</span><span class=nx>staticRenderFns</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><a href=#parse><h3 id=parse><span class=hanchor arialabel=Anchor># </span>parse</h3></a><p>è¿™ä¸€å—å°±æ˜¯ç±»ä¼¼ html çš„è§£æï¼Œé€šè¿‡ä¸€ä¸ªæ ˆ æ¯ä¸€æ¬¡å‡ºæ ˆéƒ½æ˜¯ä¸€ä¸ªæ ‡ç­¾çš„å¼€é—­ç»“æŸï¼Œæœ€åä¼šç”Ÿæˆä¸€ä¸ª AST æŠ½è±¡è¯­æ³•æ ‘ã€‚</p><p><img src=https://note.xiaopang.fun//images/image-20201206131358064.png width=auto alt=image-20201206131358064></p><a href=#optimization><h3 id=optimization><span class=hanchor arialabel=Anchor># </span>optimization</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>genStaticKeysCached</span> <span class=o>=</span> <span class=nx>cached</span><span class=p>(</span><span class=nx>genStaticKeys</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// éå†ASTæ ‘æ‰¾åˆ°æ°¸è¿œä¸ä¼šæ”¹å˜çš„é™æ€èŠ‚ç‚¹
</span></span></span><span class=line><span class=cl><span class=c1>//1.å°†å®ƒä»¬æå‡ä¸ºå¸¸é‡ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸å†éœ€è¦åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶ä¸ºå®ƒä»¬åˆ›å»ºæ–°èŠ‚ç‚¹ï¼›
</span></span></span><span class=line><span class=cl><span class=c1>//2.åœ¨æ‰“è¡¥ä¸è¿‡ç¨‹ä¸­å®Œå…¨è·³è¿‡å®ƒä»¬ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>optimize</span> <span class=p>(</span><span class=nx>root</span><span class=o>:</span> <span class=o>?</span><span class=nx>ASTElement</span><span class=p>,</span> <span class=nx>options</span><span class=o>:</span> <span class=nx>CompilerOptions</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>root</span><span class=p>)</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>  <span class=nx>isStaticKey</span> <span class=o>=</span> <span class=nx>genStaticKeysCached</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>staticKeys</span> <span class=o>||</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>isPlatformReservedTag</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>isReservedTag</span> <span class=o>||</span> <span class=nx>no</span>
</span></span><span class=line><span class=cl>  <span class=c1>// first pass: mark all non-static nodes.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>markStatic</span><span class=p>(</span><span class=nx>root</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// second pass: mark static roots.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>markStaticRoots</span><span class=p>(</span><span class=nx>root</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>genStaticKeys</span> <span class=p>(</span><span class=nx>keys</span><span class=o>:</span> <span class=nx>string</span><span class=p>)</span><span class=o>:</span> <span class=nb>Function</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>makeMap</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;type,tag,attrsList,attrsMap,plain,parent,children,attrs,start,end,rawAttrsMap&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>keys</span> <span class=o>?</span> <span class=s1>&#39;,&#39;</span> <span class=o>+</span> <span class=nx>keys</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>isStatic æ˜¯å¯¹â¼€ä¸ª AST å…ƒç´ èŠ‚ç‚¹æ˜¯å¦æ˜¯é™æ€çš„åˆ¤æ–­ï¼Œå¦‚æœæ˜¯è¡¨è¾¾å¼ï¼Œå°±æ˜¯éé™æ€ï¼›å¦‚æœæ˜¯<strong>çº¯æ–‡æœ¬</strong>ï¼Œ å°±æ˜¯é™æ€ï¼›å¯¹äºâ¼€ä¸ª<strong>æ™®é€šå…ƒç´ </strong>ï¼Œå¦‚æœ<strong>æœ‰ pre å±æ€§</strong>ï¼Œé‚£ä¹ˆå®ƒä½¿ç”¨äº† v-pre æŒ‡ä»¤ï¼Œæ˜¯é™æ€ï¼Œå¦åˆ™è¦åŒæ—¶ æ»¡â¾œä»¥ä¸‹æ¡ä»¶ï¼š**æ²¡æœ‰ä½¿ç”¨ v-if ã€ v-for ï¼Œæ²¡æœ‰ä½¿ç”¨å…¶å®ƒæŒ‡ä»¤ï¼ˆä¸åŒ…æ‹¬ v-once ï¼‰ï¼Œéå†…ç½®ç»„ä»¶ï¼Œ æ˜¯å¹³å°ä¿ç•™çš„æ ‡ç­¾ï¼Œéå¸¦æœ‰ v-for çš„ template æ ‡ç­¾çš„ç›´æ¥å­èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„æ‰€æœ‰å±æ€§çš„ key éƒ½æ»¡è¶³é™æ€ keyï¼›**è¿™äº›éƒ½æ»¡â¾œåˆ™è¿™ä¸ª AST èŠ‚ç‚¹æ˜¯â¼€ä¸ªé™æ€èŠ‚ç‚¹ã€‚</p><p>å¦‚æœè¿™ä¸ªèŠ‚ç‚¹æ˜¯â¼€ä¸ªæ™®é€šå…ƒç´ ï¼Œåˆ™éå†å®ƒçš„æ‰€æœ‰ children ï¼Œé€’å½’æ‰§â¾ markStatic ã€‚å› ä¸ºæ‰€æœ‰çš„ elseif å’Œ else èŠ‚ç‚¹éƒ½ä¸åœ¨ children ä¸­ï¼Œ å¦‚æœèŠ‚ç‚¹çš„ ifConditions ä¸ä¸ºç©ºï¼Œåˆ™éå† ifConditions æ‹¿åˆ°æ‰€æœ‰æ¡ä»¶ä¸­çš„ block ï¼Œä¹Ÿå°±æ˜¯å®ƒä»¬å¯¹åº”çš„ AST èŠ‚ç‚¹ï¼Œé€’å½’æ‰§â¾ markStatic ã€‚<strong>åœ¨è¿™äº›é€’å½’è¿‡ç¨‹ä¸­ï¼Œâ¼€æ—¦å­èŠ‚ç‚¹æœ‰ä¸æ˜¯ static çš„æƒ…å†µï¼Œåˆ™å®ƒçš„â½—èŠ‚ç‚¹çš„ static å‡å˜æˆ falseã€‚</strong></p><a href=#codegen><h3 id=codegen><span class=hanchor arialabel=Anchor># </span>codegen</h3></a><p>å°†æ ‡è®°å®Œåçš„å¯¹è±¡ ç”Ÿæˆä¸€ä¸ª render å‡½æ•°</p><a href=#generate><h4 id=generate><span class=hanchor arialabel=Anchor># </span>generate</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>generate</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>ast</span><span class=o>:</span> <span class=nx>ASTElement</span> <span class=o>|</span> <span class=k>void</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span><span class=o>:</span> <span class=nx>CompilerOptions</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>CodegenResult</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>state</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>CodegenState</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>code</span> <span class=o>=</span> <span class=nx>ast</span> <span class=o>?</span> <span class=nx>genElement</span><span class=p>(</span><span class=nx>ast</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span> <span class=o>:</span> <span class=s1>&#39;_c(&#34;div&#34;)&#39;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>render</span><span class=o>:</span> <span class=sb>`with(this){return </span><span class=si>${</span><span class=nx>code</span><span class=si>}</span><span class=sb>}`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>staticRenderFns</span><span class=o>:</span> <span class=nx>state</span><span class=p>.</span><span class=nx>staticRenderFns</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>é‡åˆ°ä¸åŒçš„æŒ‡ä»¤å¦‚ä½•å»ç”Ÿæˆ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>genElement</span> <span class=p>(</span><span class=nx>el</span><span class=o>:</span> <span class=nx>ASTElement</span><span class=p>,</span> <span class=nx>state</span><span class=o>:</span> <span class=nx>CodegenState</span><span class=p>)</span><span class=o>:</span> <span class=nx>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>parent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>el</span><span class=p>.</span><span class=nx>pre</span> <span class=o>=</span> <span class=nx>el</span><span class=p>.</span><span class=nx>pre</span> <span class=o>||</span> <span class=nx>el</span><span class=p>.</span><span class=nx>parent</span><span class=p>.</span><span class=nx>pre</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>staticRoot</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>el</span><span class=p>.</span><span class=nx>staticProcessed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>genStatic</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>once</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>el</span><span class=p>.</span><span class=nx>onceProcessed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>genOnce</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=k>for</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>el</span><span class=p>.</span><span class=nx>forProcessed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>genFor</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=k>if</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>el</span><span class=p>.</span><span class=nx>ifProcessed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>genIf</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>tag</span> <span class=o>===</span> <span class=s1>&#39;template&#39;</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>el</span><span class=p>.</span><span class=nx>slotTarget</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>state</span><span class=p>.</span><span class=nx>pre</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>genChildren</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span> <span class=o>||</span> <span class=s1>&#39;void 0&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>tag</span> <span class=o>===</span> <span class=s1>&#39;slot&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>genSlot</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// component or element
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>code</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>component</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>code</span> <span class=o>=</span> <span class=nx>genComponent</span><span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>component</span><span class=p>,</span> <span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>data</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>el</span><span class=p>.</span><span class=nx>plain</span> <span class=o>||</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>pre</span> <span class=o>&amp;&amp;</span> <span class=nx>state</span><span class=p>.</span><span class=nx>maybeComponent</span><span class=p>(</span><span class=nx>el</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>data</span> <span class=o>=</span> <span class=nx>genData</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>children</span> <span class=o>=</span> <span class=nx>el</span><span class=p>.</span><span class=nx>inlineTemplate</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=nx>genChildren</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>code</span> <span class=o>=</span> <span class=sb>`_c(&#39;</span><span class=si>${</span><span class=nx>el</span><span class=p>.</span><span class=nx>tag</span><span class=si>}</span><span class=sb>&#39;</span><span class=si>${</span>
</span></span><span class=line><span class=cl>        <span class=nx>data</span> <span class=o>?</span> <span class=sb>`,</span><span class=si>${</span><span class=nx>data</span><span class=si>}</span><span class=sb>`</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span> <span class=c1>// data
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=si>}${</span>
</span></span><span class=line><span class=cl>        <span class=nx>children</span> <span class=o>?</span> <span class=sb>`,</span><span class=si>${</span><span class=nx>children</span><span class=si>}</span><span class=sb>`</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span> <span class=c1>// children
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=si>}</span><span class=sb>)`</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// module transforms
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>state</span><span class=p>.</span><span class=nx>transforms</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>code</span> <span class=o>=</span> <span class=nx>state</span><span class=p>.</span><span class=nx>transforms</span><span class=p>[</span><span class=nx>i</span><span class=p>](</span><span class=nx>el</span><span class=p>,</span> <span class=nx>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>code</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#æ‰©å±•><h2 id=æ‰©å±•><span class=hanchor arialabel=Anchor># </span>æ‰©å±•</h2></a><a href=#event><h3 id=event><span class=hanchor arialabel=Anchor># </span>event</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src/compiler/parser/index.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>onRE</span> <span class=o>=</span> <span class=sr>/^@|^v-on:/</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>dirRE</span> <span class=o>=</span> <span class=sr>/^v-|^@|^:/</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>bindRE</span> <span class=o>=</span> <span class=sr>/^:|^v-bind:/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>processAtts</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>     <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>onRE</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>name</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// v-on
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>name</span> <span class=o>=</span> <span class=nx>name</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=nx>onRE</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>isDynamic</span> <span class=o>=</span> <span class=nx>dynamicArgRE</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isDynamic</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>name</span> <span class=o>=</span> <span class=nx>name</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>addHandler</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>modifiers</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>warn</span><span class=p>,</span> <span class=nx>list</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>isDynamic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨é‡åˆ°ä¸Šé¢å‡ ä¸ªæ­£åˆ™åï¼Œä¼šè¿›è¡Œåå­—çš„ addListener ç›‘å¬äº‹ä»¶</p><a href=#è‡ªå®šä¹‰äº‹ä»¶><h3 id=è‡ªå®šä¹‰äº‹ä»¶><span class=hanchor arialabel=Anchor># </span>è‡ªå®šä¹‰äº‹ä»¶</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>eventsMixin</span> <span class=p>(</span><span class=nx>Vue</span><span class=o>:</span> <span class=nx>Class</span><span class=o>&lt;</span><span class=nx>Component</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>hookRE</span> <span class=o>=</span> <span class=sr>/^hook:/</span>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$on</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>,</span> <span class=nx>fn</span><span class=o>:</span> <span class=nb>Function</span><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>event</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span><span class=p>.</span><span class=nx>$on</span><span class=p>(</span><span class=nx>event</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>fn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span><span class=p>[</span><span class=nx>event</span><span class=p>]</span> <span class=o>||</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span><span class=p>[</span><span class=nx>event</span><span class=p>]</span> <span class=o>=</span> <span class=p>[])).</span><span class=nx>push</span><span class=p>(</span><span class=nx>fn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=c1>// optimize hook:event cost by using a boolean flag marked at registration
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// instead of a hash lookup
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>hookRE</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>event</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span><span class=p>.</span><span class=nx>_hasHookEvent</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$once</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=o>:</span> <span class=nx>string</span><span class=p>,</span> <span class=nx>fn</span><span class=o>:</span> <span class=nb>Function</span><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nx>on</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$off</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span> <span class=nx>on</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>fn</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>arguments</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>on</span><span class=p>.</span><span class=nx>fn</span> <span class=o>=</span> <span class=nx>fn</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$on</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span> <span class=nx>on</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$off</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=o>?:</span> <span class=nx>string</span> <span class=o>|</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>,</span> <span class=nx>fn</span><span class=o>?:</span> <span class=nb>Function</span><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=c1>// all
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>arguments</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// array of events
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>event</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span><span class=p>.</span><span class=nx>$off</span><span class=p>(</span><span class=nx>event</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>fn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// specific event
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>cbs</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span><span class=p>[</span><span class=nx>event</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>cbs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>fn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span><span class=p>[</span><span class=nx>event</span><span class=p>]</span> <span class=o>=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// specific handler
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>cb</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>cb</span> <span class=o>=</span> <span class=nx>cbs</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>cb</span> <span class=o>===</span> <span class=nx>fn</span> <span class=o>||</span> <span class=nx>cb</span><span class=p>.</span><span class=nx>fn</span> <span class=o>===</span> <span class=nx>fn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>cbs</span><span class=p>.</span><span class=nx>splice</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$emit</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=o>:</span> <span class=nx>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>lowerCaseEvent</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>toLowerCase</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>lowerCaseEvent</span> <span class=o>!==</span> <span class=nx>event</span> <span class=o>&amp;&amp;</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span><span class=p>[</span><span class=nx>lowerCaseEvent</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>tip</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=sb>`Event &#34;</span><span class=si>${</span><span class=nx>lowerCaseEvent</span><span class=si>}</span><span class=sb>&#34; is emitted in component `</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=sb>`</span><span class=si>${</span><span class=nx>formatComponentName</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span><span class=si>}</span><span class=sb> but the handler is registered for &#34;</span><span class=si>${</span><span class=nx>event</span><span class=si>}</span><span class=sb>&#34;. `</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=sb>`Note that HTML attributes are case-insensitive and you cannot use `</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=sb>`v-on to listen to camelCase events when using in-DOM templates. `</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=sb>`You should probably use &#34;</span><span class=si>${</span><span class=nx>hyphenate</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=si>}</span><span class=sb>&#34; instead of &#34;</span><span class=si>${</span><span class=nx>event</span><span class=si>}</span><span class=sb>&#34;.`</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>cbs</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span><span class=p>[</span><span class=nx>event</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cbs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>cbs</span> <span class=o>=</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=o>?</span> <span class=nx>toArray</span><span class=p>(</span><span class=nx>cbs</span><span class=p>)</span> <span class=o>:</span> <span class=nx>cbs</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>args</span> <span class=o>=</span> <span class=nx>toArray</span><span class=p>(</span><span class=nx>arguments</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>info</span> <span class=o>=</span> <span class=sb>`event handler for &#34;</span><span class=si>${</span><span class=nx>event</span><span class=si>}</span><span class=sb>&#34;`</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>invokeWithErrorHandling</span><span class=p>(</span><span class=nx>cbs</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>vm</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=nx>vm</span><span class=p>,</span> <span class=nx>info</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>åœ¨å®ä¾‹ vm ä¸Šæ³¨å†Œäº†äº‹ä»¶ä¸­å¿ƒ <code>_events</code> ,æ ‡å‡†çš„å‘å¸ƒè®¢é˜…æ¨¡å¼</p><a href=#v-model><h3 id=v-model><span class=hanchor arialabel=Anchor># </span>V-model</h3></a><p>äº‹å®ä¸Šåªæ˜¯ä¸€ç§è¯­æ³•ç³–ï¼Œå¯¹äº input æ¥è¯´ å°±æ˜¯@input å’Œ:bind:value çš„è¯­æ³•ç³–ï¼Œå½“ä½ ä½¿ç”¨ç»„ä»¶ï¼Œä»æƒ³ä½¿ç”¨ V-model ä¹Ÿå¯ä»¥è¿™ä¹ˆä½¿ç”¨ï¼Œå¦å¤– Vue ä¹Ÿæä¾›äº† model å¯¹è±¡è¿›è¡Œè¿™ä¸¤ä¸ªå±æ€§æ›´æ”¹åˆ«åçš„æ–¹å¼</p><a href=#slot><h3 id=slot><span class=hanchor arialabel=Anchor># </span>Slot</h3></a><p>å½“é‡åˆ° slot æ ‡ç­¾çš„æ—¶å€™ä¼šç»™å¯¹åº”çš„ AST å…ƒç´ èŠ‚ç‚¹æ·»åŠ  slotName å±æ€§ï¼Œç„¶ååœ¨ codegen é˜¶æ®µï¼Œ ä¼šåˆ¤æ–­å¦‚æœå½“å‰ AST å…ƒç´ èŠ‚ç‚¹æ˜¯ slot æ ‡ç­¾ï¼Œåˆ™æ‰§è¡Œ genSlot å‡½æ•°</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>slotName</span> <span class=o>=</span> <span class=nx>el</span><span class=p>.</span><span class=nx>slotName</span> <span class=o>||</span> <span class=s1>&#39;&#34;default&#34;&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>children</span> <span class=o>=</span> <span class=nx>genChildren</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>res</span> <span class=o>=</span> <span class=sb>`_t(</span><span class=si>${</span><span class=nx>slotName</span><span class=si>}${</span><span class=nx>children</span> <span class=o>?</span> <span class=sb>`,</span><span class=si>${</span><span class=nx>children</span><span class=si>}</span><span class=sb>`</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=si>}</span><span class=sb>`</span>
</span></span></code></pre></td></tr></table></div></div><p>vm.$slots æ˜¯é€šè¿‡æ‰§è¡Œ resolveSlots(options._renderChildren, renderContext) è¿”å›çš„ï¼Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>resolveSlots</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span><span class=o>:</span> <span class=o>?</span><span class=nb>Array</span><span class=o>&lt;</span><span class=nx>VNode</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>context</span><span class=o>:</span> <span class=o>?</span><span class=nx>Component</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>]</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>VNode</span><span class=o>&gt;</span> <span class=p>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>children</span> <span class=o>||</span> <span class=o>!</span><span class=nx>children</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>slots</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>children</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>child</span> <span class=o>=</span> <span class=nx>children</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>child</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>    <span class=c1>// remove slot attribute if the node is resolved as a Vue slot node
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>data</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>attrs</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>attrs</span><span class=p>.</span><span class=nx>slot</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>delete</span> <span class=nx>data</span><span class=p>.</span><span class=nx>attrs</span><span class=p>.</span><span class=nx>slot</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// named slots should only be respected if the vnode was rendered in the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// same context.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>((</span><span class=nx>child</span><span class=p>.</span><span class=nx>context</span> <span class=o>===</span> <span class=nx>context</span> <span class=o>||</span> <span class=nx>child</span><span class=p>.</span><span class=nx>fnContext</span> <span class=o>===</span> <span class=nx>context</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>slot</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>slot</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>slot</span> <span class=o>=</span> <span class=p>(</span><span class=nx>slots</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>||</span> <span class=p>(</span><span class=nx>slots</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]))</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>child</span><span class=p>.</span><span class=nx>tag</span> <span class=o>===</span> <span class=s1>&#39;template&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>slot</span><span class=p>.</span><span class=nx>push</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>slot</span><span class=p>,</span> <span class=nx>child</span><span class=p>.</span><span class=nx>children</span> <span class=o>||</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>slot</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>child</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nx>slots</span><span class=p>.</span><span class=k>default</span> <span class=o>||</span> <span class=p>(</span><span class=nx>slots</span><span class=p>.</span><span class=k>default</span> <span class=o>=</span> <span class=p>[])).</span><span class=nx>push</span><span class=p>(</span><span class=nx>child</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ignore slots that contains only whitespace
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>name</span> <span class=k>in</span> <span class=nx>slots</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>slots</span><span class=p>[</span><span class=nx>name</span><span class=p>].</span><span class=nx>every</span><span class=p>(</span><span class=nx>isWhitespace</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>delete</span> <span class=nx>slots</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>slots</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>resolveSlots å‡½æ•°çš„é€»è¾‘å°±æ˜¯éå† chilren ï¼Œæ‹¿åˆ°æ¯â¼€ä¸ª child çš„ data ï¼Œç„¶åé€šè¿‡ data.slot è·å–åˆ°æ’æ§½åç§°ï¼Œè¿™ä¸ª slot å°±æ˜¯æˆ‘ä»¬ä¹‹å‰ç¼–è¯‘çˆ¶ç»„ä»¶åœ¨ codegen é˜¶æ®µè®¾ç½®çš„ data.slot ã€‚æ¥ç€ä»¥æ’æ§½åç§°ä¸º key æŠŠ child æ·»åŠ åˆ° slots ä¸­ï¼Œå¦‚æœ data.slot ä¸å­˜åœ¨ï¼Œ åˆ™æ˜¯é»˜è®¤æ’æ§½çš„å†…å®¹ï¼Œåˆ™æŠŠå¯¹åº”çš„ child æ·»åŠ åˆ° slots.defaults ä¸­ã€‚è¿™æ ·å°±è·å–åˆ°æ•´ä¸ª slots ï¼Œå®ƒæ˜¯â¼€ä¸ªå¯¹è±¡ï¼Œ key æ˜¯æ’æ§½åç§°ï¼Œ value æ˜¯â¼€ä¸ª vnode ç±»å‹çš„æ•°ç»„ï¼Œå› ä¸ºå®ƒå¯ä»¥æœ‰å¤š ä¸ªåŒåæ’æ§½ã€‚</p><a href=#keep-alive><h3 id=keep-alive><span class=hanchor arialabel=Anchor># </span>keep-alive</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=cm>/* @flow */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>isRegExp</span><span class=p>,</span> <span class=nx>remove</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;shared/util&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>getFirstComponentChild</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;core/vdom/helpers/index&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>type</span> <span class=nx>VNodeCache</span> <span class=o>=</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>]</span><span class=o>:</span> <span class=o>?</span><span class=nx>VNode</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>getComponentName</span> <span class=p>(</span><span class=nx>opts</span><span class=o>:</span> <span class=o>?</span><span class=nx>VNodeComponentOptions</span><span class=p>)</span><span class=o>:</span> <span class=o>?</span><span class=nx>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>opts</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>name</span> <span class=o>||</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>matches</span> <span class=p>(</span><span class=nx>pattern</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=nb>RegExp</span> <span class=o>|</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>,</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>string</span><span class=p>)</span><span class=o>:</span> <span class=kr>boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>pattern</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>pattern</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>pattern</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>pattern</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>).</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isRegExp</span><span class=p>(</span><span class=nx>pattern</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>pattern</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* istanbul ignore next */</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>pruneCache</span> <span class=p>(</span><span class=nx>keepAliveInstance</span><span class=o>:</span> <span class=nx>any</span><span class=p>,</span> <span class=nx>filter</span><span class=o>:</span> <span class=nb>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>cache</span><span class=p>,</span> <span class=nx>keys</span><span class=p>,</span> <span class=nx>_vnode</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>keepAliveInstance</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>cache</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>cachedNode</span><span class=o>:</span> <span class=o>?</span><span class=nx>VNode</span> <span class=o>=</span> <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cachedNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>name</span><span class=o>:</span> <span class=o>?</span><span class=nx>string</span> <span class=o>=</span> <span class=nx>getComponentName</span><span class=p>(</span><span class=nx>cachedNode</span><span class=p>.</span><span class=nx>componentOptions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>name</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>filter</span><span class=p>(</span><span class=nx>name</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>pruneCacheEntry</span><span class=p>(</span><span class=nx>cache</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>keys</span><span class=p>,</span> <span class=nx>_vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>pruneCacheEntry</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>cache</span><span class=o>:</span> <span class=nx>VNodeCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>keys</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>current</span><span class=o>?:</span> <span class=nx>VNode</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>cached</span> <span class=o>=</span> <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>cached</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=nx>current</span> <span class=o>||</span> <span class=nx>cached</span><span class=p>.</span><span class=nx>tag</span> <span class=o>!==</span> <span class=nx>current</span><span class=p>.</span><span class=nx>tag</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>cached</span><span class=p>.</span><span class=nx>componentInstance</span><span class=p>.</span><span class=nx>$destroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>  <span class=nx>remove</span><span class=p>(</span><span class=nx>keys</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>patternTypes</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nb>Function</span><span class=o>&gt;</span> <span class=o>=</span> <span class=p>[</span><span class=nb>String</span><span class=p>,</span> <span class=nb>RegExp</span><span class=p>,</span> <span class=nb>Array</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;keep-alive&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=kr>abstract</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>props</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>include</span><span class=o>:</span> <span class=nx>patternTypes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>exclude</span><span class=o>:</span> <span class=nx>patternTypes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>max</span><span class=o>:</span> <span class=p>[</span><span class=nb>String</span><span class=p>,</span> <span class=nb>Number</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>created</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>cache</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>keys</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>destroyed</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>key</span> <span class=k>in</span> <span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pruneCacheEntry</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>keys</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>mounted</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>$watch</span><span class=p>(</span><span class=s1>&#39;include&#39;</span><span class=p>,</span> <span class=nx>val</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pruneCache</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>name</span> <span class=p>=&gt;</span> <span class=nx>matches</span><span class=p>(</span><span class=nx>val</span><span class=p>,</span> <span class=nx>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>$watch</span><span class=p>(</span><span class=s1>&#39;exclude&#39;</span><span class=p>,</span> <span class=nx>val</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pruneCache</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>name</span> <span class=p>=&gt;</span> <span class=o>!</span><span class=nx>matches</span><span class=p>(</span><span class=nx>val</span><span class=p>,</span> <span class=nx>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>render</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>slot</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>$slots</span><span class=p>.</span><span class=k>default</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vnode</span><span class=o>:</span> <span class=nx>VNode</span> <span class=o>=</span> <span class=nx>getFirstComponentChild</span><span class=p>(</span><span class=nx>slot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>componentOptions</span><span class=o>:</span> <span class=o>?</span><span class=nx>VNodeComponentOptions</span> <span class=o>=</span> <span class=nx>vnode</span> <span class=o>&amp;&amp;</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>componentOptions</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>componentOptions</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// check pattern
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>name</span><span class=o>:</span> <span class=o>?</span><span class=nx>string</span> <span class=o>=</span> <span class=nx>getComponentName</span><span class=p>(</span><span class=nx>componentOptions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>include</span><span class=p>,</span> <span class=nx>exclude</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1>// not included
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>(</span><span class=nx>include</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=nx>name</span> <span class=o>||</span> <span class=o>!</span><span class=nx>matches</span><span class=p>(</span><span class=nx>include</span><span class=p>,</span> <span class=nx>name</span><span class=p>)))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=c1>// excluded
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>(</span><span class=nx>exclude</span> <span class=o>&amp;&amp;</span> <span class=nx>name</span> <span class=o>&amp;&amp;</span> <span class=nx>matches</span><span class=p>(</span><span class=nx>exclude</span><span class=p>,</span> <span class=nx>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>cache</span><span class=p>,</span> <span class=nx>keys</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>key</span><span class=o>:</span> <span class=o>?</span><span class=nx>string</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>key</span> <span class=o>==</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>        <span class=c1>// same constructor may get registered as different local components
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// so cid alone is not enough (#3269)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>?</span> <span class=nx>componentOptions</span><span class=p>.</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>cid</span> <span class=o>+</span> <span class=p>(</span><span class=nx>componentOptions</span><span class=p>.</span><span class=nx>tag</span> <span class=o>?</span> <span class=sb>`::</span><span class=si>${</span><span class=nx>componentOptions</span><span class=p>.</span><span class=nx>tag</span><span class=si>}</span><span class=sb>`</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>key</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span> <span class=o>=</span> <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>].</span><span class=nx>componentInstance</span>
</span></span><span class=line><span class=cl>        <span class=c1>// make current key freshest
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>remove</span><span class=p>(</span><span class=nx>keys</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>keys</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl>        <span class=nx>keys</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// prune oldest entry
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>max</span> <span class=o>&amp;&amp;</span> <span class=nx>keys</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=nb>parseInt</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>max</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>pruneCacheEntry</span><span class=p>(</span><span class=nx>cache</span><span class=p>,</span> <span class=nx>keys</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>keys</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>keepAlive</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vnode</span> <span class=o>||</span> <span class=p>(</span><span class=nx>slot</span> <span class=o>&amp;&amp;</span> <span class=nx>slot</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>æ³¨æ„å®ƒæœ‰â¼€ä¸ªå±æ€§ abstract ä¸º trueï¼Œæ˜¯â¼€ä¸ªæŠ½è±¡ç»„ä»¶ï¼ŒVue çš„â½‚æ¡£æ²¡æœ‰æè¿™ä¸ªæ¦‚å¿µï¼Œå®é™…ä¸Šå®ƒåœ¨ç»„ä»¶å®ä¾‹å»ºç«‹çˆ¶å­å…³ç³»çš„æ—¶å€™ä¼šè¢«å¿½ç•¥ï¼Œ</p><p>include å’Œ exclude å¯ä»¥ä¼ å…¥åŠ¨æ€å€¼æ˜¯å› ä¸ºåœ¨ watch ä¸­ç›‘å¬å˜åŒ–</p><p><strong>åœ¨ created é’©å­é‡Œå®šä¹‰äº† this.cache å’Œ this.keys ï¼Œæœ¬è´¨ä¸Šå®ƒå°±æ˜¯å»ç¼“å­˜å·²ç»åˆ›å»ºè¿‡çš„ vnode ã€‚</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>slot</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>$slots</span><span class=p>.</span><span class=k>default</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>vnode</span><span class=o>:</span> <span class=nx>VNode</span> <span class=o>=</span> <span class=nx>getFirstComponentChild</span><span class=p>(</span><span class=nx>slot</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>**keep-alive åªç¼“å­˜ç¬¬ä¸€ä¸ªå­å…ƒç´ ï¼**æ‰€ä»¥â¼€èˆ¬å’Œå®ƒæ­é…ä½¿ç”¨çš„æœ‰ component åŠ¨æ€ç»„ä»¶æˆ–è€…æ˜¯ router-view</p><p>å½“å†æ¬¡æ¥åˆ° creteEle çš„æ—¶å€™ isReactivated ä¸º trueï¼Œ<strong>å¹¶ä¸”åœ¨æ‰§è¡Œ init é’©å­å‡½æ•°çš„æ—¶å€™ä¸ä¼šæ‰§è¡Œç»„ä»¶çš„ mount è¿‡ç¨‹äº†</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src/core/vdom/create-component.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>init</span> <span class=p>(</span><span class=nx>vnode</span><span class=o>:</span> <span class=nx>VNodeWithData</span><span class=p>,</span> <span class=nx>hydrating</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>)</span><span class=o>:</span> <span class=o>?</span><span class=kr>boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=o>!</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span><span class=p>.</span><span class=nx>_isDestroyed</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>keepAlive</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// kept-alive components, treat as a patch
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>mountedNode</span><span class=o>:</span> <span class=nx>any</span> <span class=o>=</span> <span class=nx>vnode</span> <span class=c1>// work around flow
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>componentVNodeHooks</span><span class=p>.</span><span class=nx>prepatch</span><span class=p>(</span><span class=nx>mountedNode</span><span class=p>,</span> <span class=nx>mountedNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>child</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span> <span class=o>=</span> <span class=nx>createComponentInstanceForVnode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>activeInstance</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>child</span><span class=p>.</span><span class=nx>$mount</span><span class=p>(</span><span class=nx>hydrating</span> <span class=o>?</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span> <span class=o>:</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span></code></pre></td></tr></table></div></div><a href=#transition><h3 id=transition><span class=hanchor arialabel=Anchor># </span>transition</h3></a><p>åœ¨ä¸‹åˆ—æƒ…å½¢ä¸­ï¼Œå¯ä»¥ç»™ä»»ä½•å…ƒç´ å’Œç»„ä»¶æ·»åŠ  entering/leaving è¿‡æ¸¡ï¼š</p><ul><li>æ¡ä»¶æ¸²æŸ“ (ä½¿ç”¨ v-if )</li><li>æ¡ä»¶å±•ç¤º (ä½¿ç”¨ v-show )</li><li>åŠ¨æ€ç»„ä»¶</li><li>ç»„ä»¶æ ¹èŠ‚ç‚¹</li></ul><p>åœ¨ vnode patch çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹äºè¿‡æ¸¡çš„å®ç°ï¼Œ<strong>å®ƒåªæ¥æ”¶äº† create å’Œ activate 2 ä¸ªé’©å­å‡½æ•°</strong>ï¼Œæˆ‘ä»¬çŸ¥é“ create é’©å­å‡½æ•°åªæœ‰å½“èŠ‚ç‚¹çš„åˆ›å»ºè¿‡ç¨‹æ‰ä¼šæ‰§è¡Œï¼Œè€Œ remove ä¼šåœ¨èŠ‚ç‚¹é”€æ¯çš„æ—¶å€™æ‰§è¡Œï¼Œè¿™ä¹Ÿå°±å°è¯äº† å¿…é¡»è¦æ»¡â¾œ v-if ã€åŠ¨æ€ç»„ä»¶ã€ç»„ä»¶æ ¹èŠ‚ç‚¹æ¡ä»¶ä¹‹â¼€äº†ï¼Œ</p><p>æ€»ç»“èµ·æ¥ï¼ŒVue çš„è¿‡æ¸¡å®ç°åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>â¾ƒåŠ¨å—…æ¢ç›®æ ‡å…ƒç´ æ˜¯å¦åº”ç”¨äº† CSS è¿‡æ¸¡æˆ–åŠ¨ç”»ï¼Œå¦‚æœæ˜¯ï¼Œåœ¨æ°å½“çš„æ—¶æœºæ·»åŠ /åˆ é™¤ CSS ç±»åã€‚</li><li>å¦‚æœè¿‡æ¸¡ç»„ä»¶æä¾›äº† JavaScript é’©å­å‡½æ•°ï¼Œè¿™äº›é’©å­å‡½æ•°å°†åœ¨æ°å½“çš„æ—¶æœºè¢«è°ƒç”¨ã€‚</li><li>å¦‚æœæ²¡æœ‰æ‰¾åˆ° JavaScript é’©å­å¹¶ä¸”ä¹Ÿæ²¡æœ‰æ£€æµ‹åˆ° CSS è¿‡æ¸¡/åŠ¨ç”»ï¼ŒDOM æ“ä½œ (æ’å…¥/åˆ é™¤) åœ¨ä¸‹â¼€å¸§ ä¸­ç«‹å³æ‰§è¡Œã€‚</li></ol><a href=#vue-route><h2 id=vue-route><span class=hanchor arialabel=Anchor># </span>Vue-Route</h2></a><a href=#vueuse><h3 id=vueuse><span class=hanchor arialabel=Anchor># </span>Vue.use</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>initUse</span> <span class=p>(</span><span class=nx>Vue</span><span class=o>:</span> <span class=nx>GlobalAPI</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>use</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>plugin</span><span class=o>:</span> <span class=nb>Function</span> <span class=o>|</span> <span class=nb>Object</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>installedPlugins</span> <span class=o>=</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>_installedPlugins</span> <span class=o>||</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>_installedPlugins</span> <span class=o>=</span> <span class=p>[]))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>installedPlugins</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>plugin</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// additional parameters
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>args</span> <span class=o>=</span> <span class=nx>toArray</span><span class=p>(</span><span class=nx>arguments</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>args</span><span class=p>.</span><span class=nx>unshift</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>plugin</span><span class=p>.</span><span class=nx>install</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>plugin</span><span class=p>.</span><span class=nx>install</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>plugin</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>plugin</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>plugin</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>installedPlugins</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>plugin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#vuex><h2 id=vuex><span class=hanchor arialabel=Anchor># </span><a href=/Vuex rel=noopener class=internal-link data-src=/Vuex>Vuex</a></h2></a><a href=#æ€»ç»“-2><h2 id=æ€»ç»“-2><span class=hanchor arialabel=Anchor># </span>æ€»ç»“</h2></a><p>Vue æ˜¯ä¸€ä¸ªé€šè¿‡å“åº”å¼å¯¹è±¡ å®ç°çš„ä¸€ä¸ª MVVM æ¡†æ¶ï¼Œä»–çš„æ¸²æŸ“æµç¨‹æ˜¯è¿™æ ·çš„ï¼Œä»–é¦–å…ˆå…¶å®å°±æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œåœ¨åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œä»–æŠŠåƒ extendã€use ç­‰ç­‰æ–¹æ³•æŒ‚è½½åˆ°åŸå‹é“¾ä¸Šï¼Œç„¶åç­‰å¾… New ä¸€ä¸ªæ–°çš„å®ä¾‹å‡ºæ¥ï¼Œ init ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†ä¸ºæ•°æ®æ³¨å…¥å’Œ$mount ä¸¤ä¸ªæ—¶æœŸ</p><p>æ•°æ®æ³¨å…¥æ˜¯æŒ‰ç…§</p><ul><li>initLifecycle(vm) // $parent,$root,$children,$refs</li><li>initEvents(vm) // å¤„ç†çˆ¶ç»„ä»¶ä¼ é€’çš„äº‹ä»¶å’Œå›è°ƒ</li><li>initRender(vm) // $slots,$scopedSlots,_c,$createElement</li><li><strong>callHook(vm, &lsquo;beforeCreate&rsquo;)</strong></li><li>initInjections(vm) // è·å–æ³¨å…¥æ•°æ®</li><li>initState(vm) // åˆå§‹åŒ– propsï¼Œmethodsï¼Œdataï¼Œcomputedï¼Œwatch</li><li>initProvide(vm) // æä¾›æ•°æ®æ³¨å…¥</li><li><strong>callHook(vm, &lsquo;created&rsquo;)</strong></li></ul><p>è¿™æ®µæ—¶æœŸï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ™°çš„äº†è§£åˆ° beforeCreate å’Œ Create è¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸå¯ä»¥è·å–åˆ°çš„æ•°æ®ã€‚å¯¹æ•°æ®çš„å“åº”å¼å£°æ˜ä¹Ÿå‘ç”Ÿåœ¨è¿™ä¸ªé˜¶æ®µã€‚</p><p>ç„¶åå°±è¿›å…¥äº†$mount é˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µä¹Ÿå«æŒ‚è½½ï¼Œ</p><p>é¦–å…ˆ ä¼šè°ƒç”¨ <code>_render</code> å°† æ¨¡æ¿è½¬åŒ–æˆ ASTã€staticRenderFnsã€render å‡½æ•°ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªé˜¶æ®µç§°ä¹‹ä¸ºç¼–è¯‘é˜¶æ®µ</p><p>è½¬åŒ–æˆ AST è¿™ä¸ªé˜¶æ®µçš„è¿‡ç¨‹ï¼Œæœ‰ç‚¹ç±»ä¼¼äº HTML çš„æ¨¡æ¿è½¬åŒ–ï¼Œ é€šè¿‡ä¸€ä¸ªæ ˆ è¿›è¡Œæ ‡ç­¾çš„é—­åˆåŒ¹é…ï¼Œé€šè¿‡å¤§é‡æ­£åˆ™è¿›è¡Œäº‹ä»¶å’ŒæŒ‡ä»¤ç­‰æ“ä½œçš„åŒ¹é…ï¼Œæœ€åç”Ÿæˆä¸€æ£µ AST æ ‘ï¼ŒAST å…ƒç´ èŠ‚ç‚¹æ€»å…±æœ‰ 3 ç§ç±»å‹ï¼Œ type ä¸º 1 è¡¨ç¤ºæ˜¯æ™®é€šå…ƒç´ ï¼Œä¸º 2 è¡¨ç¤ºæ˜¯è¡¨è¾¾å¼ï¼Œä¸º 3 è¡¨ç¤ºæ˜¯çº¯æ–‡æœ¬ã€‚</p><p><strong>&mdash; callHook(<em>vm</em>, &lsquo;beforeMount&rsquo;) &mdash;</strong></p><p>ç”Ÿæˆä»¥åï¼Œè¦é€šè¿‡æ ‡è®°é™æ€èŠ‚ç‚¹æ¥ä¼˜åŒ–è¿™é¢— AST æ ‘ï¼Œåˆ°è¿™å°±è¦å°† AST æ ‘å’Œ options ä¼ å…¥ render ç”ŸæˆçœŸæ­£è¿è¡Œçš„ codeï¼Œå…¶ä¸­æ¶‰åŠåˆ° vifï¼Œvfor ç­‰æŒ‡ä»¤çš„å…·ä½“æ‰§è¡Œ</p><p>äº§ç”Ÿä¸€ä¸ªç»„ä»¶çº§åˆ«çš„ Watcherï¼Œé€šè¿‡ <code>_update</code>å°† VNode æ›´æ–°æˆçœŸå® DOM æ—¶ï¼Œè§¦å‘äº† getter è¿›è¡Œä¾èµ–æ”¶é›†</p><p><strong>&mdash; callHook(<em>vm</em>, &lsquo;Mount&rsquo;) &mdash;</strong></p><p>å“åº”å¼ï¼š æœ€å¼€å§‹ init æ—¶å·²ç»å¯¹æ¯ä¸ªæ•°æ®è¿›è¡Œäº†å“åº”å¼å£°æ˜ï¼Œåœ¨$mount é˜¶æ®µï¼Œå°† template è½¬åŒ–æˆ AST æ ‘æ—¶ï¼ŒåŒæ—¶ä¹Ÿä¼šè§¦å‘å“åº”å¼å¯¹è±¡çš„ get æ–¹æ³•ï¼Œå°†ç›¸åº”çš„ watcher push åˆ° Dep çš„ sub æ•°ç»„é‡Œï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œä»–åœ¨å…¨å±€å£°æ˜äº†ä¸€ä¸ª Dep.target,ä¿è¯åŒæ—¶åªæœ‰ä¸€ä¸ª watcher åœ¨æ‰§è¡Œï¼Œ</p><p>ç„¶åå°±æ˜¯</p><p>è§¦å‘æ›´æ–°æ—¶ï¼ŒDep æ¥å—åˆ°å˜åŒ–é€šçŸ¥ï¼Œé€šçŸ¥å†…éƒ¨çš„ watcher è¿›è¡Œè§†å›¾æ›´æ–°ï¼ŒWatcher å†…éƒ¨æœ‰æ–°æ—§ Dep ä¸¤ä¸ªæ•°ç»„ï¼Œä»–ä¼šå…ˆå»å–æ¶ˆæ—§ Watcher çš„è®¢é˜…ï¼Œç„¶åæ‰§è¡Œ watcher.run()ä¼šè¿›å…¥é˜Ÿåˆ—è¿›è¡Œä¸€æ³¢å»é‡ï¼Œç„¶åå¼‚æ­¥å»è°ƒç”¨ patchï¼Œpatch è¿™è¾¹ä¹Ÿé‡æ–°ç”Ÿæˆä¸€ä¸ª Vnode Tree ä¸æ—§ tree è¿›è¡Œ diff ç®—æ³•ã€‚</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>åå‘é“¾æ¥</h3><ul class=backlinks><li><a href=/%E6%AC%A2%E8%81%9A%E6%97%B6%E4%BB%A3/ data-ctx=Vue2æºç é˜…è¯»#æ·±å…¥å“åº”å¼åŸç† data-src=/%E6%AC%A2%E8%81%9A%E6%97%B6%E4%BB%A3 class=internal-link>æ¬¢èšæ—¶ä»£</a></li><li><a href=/Vue/ data-ctx="Vue2 æºç é˜…è¯»" data-src=/Vue class=internal-link>Vue</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>å†…éƒ¨é“¾æ¥å…³ç³»å›¾</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://note.xiaopang.fun/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><hr><script src=https://giscus.app/client.js data-repo=chelseachen007/ObPublish data-repo-id=R_kgDOJSeHfQ data-category=General data-category-id=DIC_kwDOJSeHfc4CXVcx data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><center><script>var caution=!1,now,visits;function setCookie(e,t,n,s,o,a){var i=e+"="+escape(t)+(n?"; expires="+n.toGMTString():"")+(s?"; path="+s:"")+(o?"; domain="+o:"")+(a?"; secure":"");!caution||(e+"="+escape(t)).length<=4e3?document.cookie=i:confirm("Cookie exceeds 4KB and will be cut!")&&(document.cookie=i)}function getCookie(s){var e=s+"=",n,t=document.cookie.indexOf(e);return t==-1?null:(n=document.cookie.indexOf(";",t+e.length),n==-1&&(n=document.cookie.length),unescape(document.cookie.substring(t+e.length,n)))}function deleteCookie(e,t,n){getCookie(e)&&(document.cookie=e+"="+(t?"; path="+t:"")+(n?"; domain="+n:"")+"; expires=Thu, 01-Jan-70 00:00:01 GMT")}function fixDate(e){var n=new Date(0),t=n.getTime();t>0&&e.setTime(e.getTime()-t)}now=new Date,fixDate(now),now.setTime(now.getTime()+730*24*60*60*1e3),visits=getCookie("counter"),visits?visits=parseInt(visits)+1:visits=1,setCookie("counter",visits,now),document.write("<font size=2>ğŸ‘‹è®¿é—®é‡ï¼š"+visits+"")</script></center></div></body></html>