<!doctype html><html lang=en><head><script async defer data-website-id=08a754c4-6690-46d7-bb80-8ff93cfa232f src=https://umami.oldwinter.top/umami.js></script><meta charset=utf-8><meta name=description content="Vue2 源码阅读 准备工作 vue 中使用的类型检查工具是 Flow.js 有点类似 TypeScript 。
目录 1 2 3 4 5 6 7  src ├── compiler # 编译相关 包括把模板解析成 ast 语法树，ast 语法树优化，代码⽣成等功能。 ├── core # 核⼼代码 包括内置组件、全局 API 封装，Vue 实例化、观察者、虚拟 DOM、⼯具函数等等。 ├── platforms # 不同平台的⽀持 web和 weex入口， ├── server # 服务端渲染 ├── sfc # ."><title>Vue2 源码阅读</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://note.xiaopang.fun//icon.png><link href=https://note.xiaopang.fun/styles.b3e1e36b0403ac565c9392b3e23ef3b6.min.css rel=stylesheet><link href=https://note.xiaopang.fun/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://note.xiaopang.fun/js/darkmode.660407930f154820c5998c99422c74bb.min.js></script>
<script src=https://note.xiaopang.fun/js/util.9825137f5e7825e8553c68ce39ac9e44.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://note.xiaopang.fun/js/popover.abe6a51cc7138c5dff00f151dd627ad1.min.js></script>
<script src=https://note.xiaopang.fun/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://note.xiaopang.fun/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://note.xiaopang.fun/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const BASE_URL="https://note.xiaopang.fun/",fetchData=Promise.all([fetch("https://note.xiaopang.fun/indices/linkIndex.5d34c18cb5802c12304f1330c8df0edd.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://note.xiaopang.fun/indices/contentIndex.80062824eb006684aa96e829bc6f3dba.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addCollapsibleCallouts(),initPopover("https://note.xiaopang.fun",!0,!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://note.xiaopang.fun",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})}</script><script>window.Million={navigate:e=>window.location.href=e,prefetch:()=>{}},window.addEventListener("DOMContentLoaded",()=>{init(),render()})</script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-11MD77L81V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-11MD77L81V",{anonymize_ip:!1})}</script><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=search placeholder=支持标题及全文搜索...><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://note.xiaopang.fun/js/full-text-search.24827f874defbbc6d529926cbfcfb493.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://note.xiaopang.fun/>🌿数字花园🌸</a></h1><div class=spacer></div><div id=search-icon><p>search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Vue2 源码阅读</h1><p class=meta>最近编辑于
Jul 14, 2023</p><ul class=tags></ul><aside class=mainTOC><details><summary>目录</summary><nav id=TableOfContents><ol><li><a href=#准备工作>准备工作</a><ol><li><a href=#目录>目录</a></li><li><a href=#选择版本>选择版本</a></li></ol></li><li><a href=#从入口开始>从入口开始</a><ol><li><a href=#init>init</a></li><li><a href=#mount>$mount</a></li><li><a href=#总结>总结</a></li></ol></li><li><a href=#组件化>组件化</a><ol><li><a href=#createelement><strong>createElement</strong></a></li><li><a href=#createcomponent>createComponent</a></li><li><a href=#patch>patch</a></li><li><a href=#总结-1>总结</a></li></ol></li><li><a href=#深入响应式原理>深入响应式原理</a><ol><li><a href=#响应式对象>响应式对象</a></li><li><a href=#nexttick>nextTick</a></li><li><a href=#特殊情况>特殊情况</a></li><li><a href=#计算属性-vs-侦听属性>计算属性 VS 侦听属性</a></li><li><a href=#组件更新>组件更新</a></li></ol></li><li><a href=#编译>编译</a><ol><li><a href=#parse>parse</a></li><li><a href=#optimization>optimization</a></li><li><a href=#codegen>codegen</a></li></ol></li><li><a href=#扩展>扩展</a><ol><li><a href=#event>event</a></li><li><a href=#自定义事件>自定义事件</a></li><li><a href=#v-model>V-model</a></li><li><a href=#slot>Slot</a></li><li><a href=#keep-alive>keep-alive</a></li><li><a href=#transition>transition</a></li></ol></li><li><a href=#vue-route>Vue-Route</a><ol><li><a href=#vueuse>Vue.use</a></li></ol></li><li><a href=#vuex>[[Vuex]]</a></li><li><a href=#总结-2>总结</a></li></ol></nav></details></aside><a href=#vue2-源码阅读><h1 id=vue2-源码阅读><span class=hanchor arialabel=Anchor># </span>Vue2 源码阅读</h1></a><a href=#准备工作><h2 id=准备工作><span class=hanchor arialabel=Anchor># </span>准备工作</h2></a><p>vue 中使用的类型检查工具是 Flow.js 有点类似 TypeScript 。</p><a href=#目录><h3 id=目录><span class=hanchor arialabel=Anchor># </span>目录</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=nx>src</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=nx>compiler</span> <span class=err>#</span> <span class=nx>编译相关</span> <span class=nx>包括把模板解析成</span> <span class=nx>ast</span> <span class=nx>语法树</span><span class=err>，</span><span class=nx>ast</span> <span class=nx>语法树优化</span><span class=err>，</span><span class=nx>代码</span><span class=err>⽣</span><span class=nx>成等功能</span><span class=err>。</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=nx>core</span> <span class=err>#</span> <span class=nx>核</span><span class=err>⼼</span><span class=nx>代码</span>  <span class=nx>包括内置组件</span><span class=err>、</span><span class=nx>全局</span> <span class=nx>API</span> <span class=nx>封装</span><span class=err>，</span><span class=nx>Vue</span> <span class=nx>实例化</span><span class=err>、</span><span class=nx>观察者</span><span class=err>、</span><span class=nx>虚拟</span> <span class=nx>DOM</span><span class=err>、⼯</span><span class=nx>具函数等等</span><span class=err>。</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=nx>platforms</span> <span class=err>#</span> <span class=nx>不同平台的</span><span class=err>⽀</span><span class=nx>持</span> <span class=nx>web和</span> <span class=nx>weex入口</span><span class=err>，</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=nx>server</span> <span class=err>#</span> <span class=nx>服务端渲染</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=nx>sfc</span> <span class=err>#</span> <span class=p>.</span><span class=nx>vue</span> <span class=err>⽂</span><span class=nx>件解析</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=nx>shared</span> <span class=err>#</span> <span class=nx>共享代码</span>
</span></span></code></pre></td></tr></table></div></div><a href=#选择版本><h3 id=选择版本><span class=hanchor arialabel=Anchor># </span>选择版本</h3></a><ul><li><p>Runtime Only</p><p>我们在使用 Runtime Only 版本的 Vue.js 的时候，通常需要借助如 webpack 的 vue-loader ⼯具把 .vue ⽂ 件编译成 JavaScript，因为是在编译阶段做的，所以它只包含运行时的 Vue.js 代码，因此代码体积也会 更轻量。</p></li><li><p>Runtime+Compiler</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// 需要编译器的版本
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>new</span> <span class=nx>Vue</span><span class=p>({</span>
</span></span><span class=line><span class=cl><span class=nx>template</span><span class=o>:</span> <span class=s1>&#39;&lt;div&gt;{{ hi }}&lt;/div&gt;&#39;</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><a href=#从入口开始><h2 id=从入口开始><span class=hanchor arialabel=Anchor># </span>从入口开始</h2></a><p>初始化全局 api</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=nx>initGlobalAPI</span><span class=p>(</span><span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>initGlobalAPI</span> <span class=p>(</span><span class=nx>Vue</span><span class=o>:</span> <span class=nx>GlobalAPI</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Vue</span><span class=p>.</span><span class=nx>util</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>warn</span><span class=p>,</span> <span class=nx>extend</span><span class=p>,</span> <span class=nx>mergeOptions</span><span class=p>,</span> <span class=nx>defineReactive</span><span class=p>,</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=nx>Vue</span><span class=p>.</span><span class=nx>set</span> <span class=o>=</span> <span class=nx>set</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>Vue</span><span class=p>.</span><span class=k>delete</span> <span class=o>=</span> <span class=nx>del</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>Vue</span><span class=p>.</span><span class=nx>nextTick</span> <span class=o>=</span> <span class=nx>nextTick</span><span class=p>;</span> <span class=c1>// TODO：nnextTick
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>Vue</span><span class=p>.</span><span class=nx>options</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>ASSET_TYPES</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>type</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>Vue</span><span class=p>.</span><span class=nx>options</span><span class=p>[</span><span class=nx>type</span> <span class=o>+</span> <span class=s2>&#34;s&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>Vue</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>_base</span> <span class=o>=</span> <span class=nx>Vue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>extend</span><span class=p>(</span><span class=nx>Vue</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>components</span><span class=p>,</span> <span class=nx>builtInComponents</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>initUse</span><span class=p>(</span><span class=nx>Vue</span><span class=p>);</span> <span class=c1>// TODO：initUse
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>);</span> <span class=c1>// TODO：initMixin
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initExtend</span><span class=p>(</span><span class=nx>Vue</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>initAssetRegisters</span><span class=p>(</span><span class=nx>Vue</span><span class=p>);</span> <span class=c1>// 注册实现Vue.component/directive/filter
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>传入的 Vue 将生命周期等混入</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src\core\instance\index.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>Vue</span> <span class=p>(</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=o>!</span><span class=p>(</span><span class=k>this</span> <span class=k>instanceof</span> <span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>warn</span><span class=p>(</span><span class=s1>&#39;Vue is a constructor and should be called with the `new` keyword&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>_init</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>initMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>stateMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>eventsMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>lifecycleMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>renderMixin</span><span class=p>(</span><span class=nx>Vue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>Vue</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>所以 Vue 本质上就是⼀个用 Function 实现的 Class，然后它的原型 prototype 以及它本⾝都扩展了⼀系列的 方法和属性，</strong></p><a href=#init><h3 id=init><span class=hanchor arialabel=Anchor># </span>init</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/core/instance/init.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>initMixin</span> <span class=p>(</span><span class=nx>Vue</span><span class=o>:</span> <span class=nx>Class</span><span class=o>&lt;</span><span class=nx>Component</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_init</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>options</span><span class=o>?:</span> <span class=nb>Object</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=c1>// a uid
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_uid</span> <span class=o>=</span> <span class=nx>uid</span><span class=o>++</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>options</span> <span class=o>&amp;&amp;</span> <span class=nx>options</span><span class=p>.</span><span class=nx>_isComponent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>initInternalComponent</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span> <span class=o>=</span> <span class=nx>mergeOptions</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>resolveConstructorOptions</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>constructor</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>options</span> <span class=o>||</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// expose real self
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_self</span> <span class=o>=</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=nx>initLifecycle</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span> <span class=c1>// $parent,$root,$children,$refs
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initEvents</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span> <span class=c1>// 处理父组件传递的事件和回调
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initRender</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span> <span class=c1>// $slots,$scopedSlots,_c,$createElement
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeCreate&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>initInjections</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span> <span class=c1>// 获取注入数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initState</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span> <span class=c1>// 初始化props，methods，data，computed，watch
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initProvide</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span> <span class=c1>// 提供数据注入
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;created&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>el</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$mount</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>el</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Vue 初始化主要就干了几件事情，合并配置，初始化生命周期，初始化事件中心，初始化渲染，初始 化 data、props、computed、watcher 等等。</p><a href=#mount><h3 id=mount><span class=hanchor arialabel=Anchor># </span>$mount</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>mount</span> <span class=o>=</span> <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$mount</span>
</span></span><span class=line><span class=cl><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$mount</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>el</span><span class=o>?:</span> <span class=nx>string</span> <span class=o>|</span> <span class=nx>Element</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hydrating</span><span class=o>?:</span> <span class=kr>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>el</span> <span class=o>=</span> <span class=nx>el</span> <span class=o>&amp;&amp;</span> <span class=nx>query</span><span class=p>(</span><span class=nx>el</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* istanbul ignore if */</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>el</span> <span class=o>===</span> <span class=nb>document</span><span class=p>.</span><span class=nx>body</span> <span class=o>||</span> <span class=nx>el</span> <span class=o>===</span> <span class=nb>document</span><span class=p>.</span><span class=nx>documentElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=sb>`Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.`</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>options</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>$options</span>
</span></span><span class=line><span class=cl>  <span class=c1>// resolve template/el and convert to render function
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>options</span><span class=p>.</span><span class=nx>render</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>template</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>template</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>template</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>template</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>template</span><span class=p>.</span><span class=nx>charAt</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>===</span> <span class=s1>&#39;#&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>template</span> <span class=o>=</span> <span class=nx>idToTemplate</span><span class=p>(</span><span class=nx>template</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>template</span><span class=p>.</span><span class=nx>nodeType</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>template</span> <span class=o>=</span> <span class=nx>template</span><span class=p>.</span><span class=nx>innerHTML</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>template</span> <span class=o>=</span> <span class=nx>getOuterHTML</span><span class=p>(</span><span class=nx>el</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>template</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>options</span><span class=p>.</span><span class=nx>render</span> <span class=o>=</span> <span class=nx>render</span>
</span></span><span class=line><span class=cl>      <span class=nx>options</span><span class=p>.</span><span class=nx>staticRenderFns</span> <span class=o>=</span> <span class=nx>staticRenderFns</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>mount</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>el</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>首先，它 对 el 做了限制，Vue 不能挂载在 body 、 html 这样的根节点上。</p><p>接下来的是很关键的逻辑 —— 如果没有定义 render 方法，则会把 el 或者 template 字符串<strong>转换成 render 方法</strong>。</p><a href=#mountcomponent><h4 id=mountcomponent><span class=hanchor arialabel=Anchor># </span>mountComponent</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/core/instance/lifecycle.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>mountComponent</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>el</span><span class=o>:</span> <span class=o>?</span><span class=nx>Element</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>hydrating</span><span class=o>?:</span> <span class=kr>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>el</span>
</span></span><span class=line><span class=cl>  <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeMount&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>updateComponent</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* istanbul ignore if */</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>config</span><span class=p>.</span><span class=nx>performance</span> <span class=o>&amp;&amp;</span> <span class=nx>mark</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateComponent</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_name</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>id</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_uid</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>startTag</span> <span class=o>=</span> <span class=sb>`vue-perf-start:</span><span class=si>${</span><span class=nx>id</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>endTag</span> <span class=o>=</span> <span class=sb>`vue-perf-end:</span><span class=si>${</span><span class=nx>id</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>mark</span><span class=p>(</span><span class=nx>startTag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_render</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=nx>mark</span><span class=p>(</span><span class=nx>endTag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>measure</span><span class=p>(</span><span class=sb>`vue </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb> render`</span><span class=p>,</span> <span class=nx>startTag</span><span class=p>,</span> <span class=nx>endTag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>mark</span><span class=p>(</span><span class=nx>startTag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>_update</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>mark</span><span class=p>(</span><span class=nx>endTag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>measure</span><span class=p>(</span><span class=sb>`vue </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb> patch`</span><span class=p>,</span> <span class=nx>startTag</span><span class=p>,</span> <span class=nx>endTag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>updateComponent</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>_update</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_render</span><span class=p>(),</span> <span class=nx>hydrating</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>new</span> <span class=nx>Watcher</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>updateComponent</span><span class=p>,</span> <span class=nx>noop</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>before</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isMounted</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isDestroyed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeUpdate&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=kc>true</span> <span class=cm>/* isRenderWatcher */</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>hydrating</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_isMounted</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;mounted&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>从上⾯的代码可以看到， mountComponent 核⼼就是先调用 vm._render 方法先⽣成虚拟 Node，再实例化⼀个渲染 Watcher ，在它的回调函数中会调用 updateComponent 方法，最终调用 vm._update 更新 DOM。</p><p>Watcher 在这里起到两个作用，⼀个是初始化的时候会执行回调函数，另⼀个是当 vm 实例中的监测 的数据发⽣变化的时候执行回调函数。</p><p>函数最后判断为根节点的时候设置 vm._isMounted 为 true ， 表示这个实例已经挂载了，同时执行 mounted 钩子函数。 这里注意 vm.$vnode 表示 Vue 实例的父虚拟 Node，所以它为 Null 则表示 当前是根 Vue 的实例。</p><a href=#render><h4 id=render><span class=hanchor arialabel=Anchor># </span>render</h4></a><p>Vue 的 _render 方法是实例的⼀个私有方法，它用来把实例渲染成⼀个虚拟 Node。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>div</span> <span class=nx>id</span><span class=o>=</span><span class=s2>&#34;app&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>{{</span> <span class=nx>message</span> <span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>转化成</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=nx>render</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>createElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>createElement</span><span class=p>(</span><span class=s1>&#39;div&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>attrs</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>id</span><span class=o>:</span> <span class=s1>&#39;app&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=k>this</span><span class=p>.</span><span class=nx>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#virtual-dom><h4 id=virtual-dom><span class=hanchor arialabel=Anchor># </span>Virtual DOM</h4></a><p>Virtual DOM 就是用⼀个原⽣的 JS 对象去描述⼀个 DOM 节点，所以它比创建⼀个 DOM 的代价要 ⼩很多。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>class</span> <span class=nx>VNode</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>tag</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// 标签
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>data</span><span class=o>:</span> <span class=nx>VNodeData</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// 数据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>children</span><span class=o>:</span> <span class=o>?</span><span class=nb>Array</span><span class=o>&lt;</span><span class=nx>VNode</span><span class=o>&gt;</span><span class=p>;</span> <span class=c1>// 子节点
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>text</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// 文本
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>elm</span><span class=o>:</span> <span class=nx>Node</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>ns</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>context</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// rendered in this component&#39;s scope
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>key</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=nx>number</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>componentOptions</span><span class=o>:</span> <span class=nx>VNodeComponentOptions</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>componentInstance</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// component instance
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>parent</span><span class=o>:</span> <span class=nx>VNode</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// component placeholder node
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// strictly internal
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>raw</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span> <span class=c1>// 包含原始HTML？(仅限服务器)。
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>isStatic</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span> <span class=c1>// 是静态节点吗
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>isRootInsert</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span> <span class=c1>// 进入Root必须吗
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>isComment</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span> <span class=c1>// 空注释占位符?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>isCloned</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span> <span class=c1>// 是克隆节点吗?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>isOnce</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span> <span class=c1>// 是v-once节点吗?
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>asyncFactory</span><span class=o>:</span> <span class=nb>Function</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// 异步组件工厂函数。
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>asyncMeta</span><span class=o>:</span> <span class=nb>Object</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>isAsyncPlaceholder</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>ssrContext</span><span class=o>:</span> <span class=nb>Object</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>fnContext</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>|</span> <span class=k>void</span><span class=p>;</span> <span class=c1>// 功能节点的真实上下文虚拟机
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>fnOptions</span><span class=o>:</span> <span class=o>?</span><span class=nx>ComponentOptions</span><span class=p>;</span> <span class=c1>// for SSR caching
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>devtoolsMeta</span><span class=o>:</span> <span class=o>?</span><span class=nb>Object</span><span class=p>;</span> <span class=c1>// 用于存储DevTools的功能渲染上下文
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>fnScopeId</span><span class=o>:</span> <span class=o>?</span><span class=nx>string</span><span class=p>;</span> <span class=c1>// functional scope id support
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>tag</span><span class=o>?:</span> <span class=nx>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=o>?:</span> <span class=nx>VNodeData</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>children</span><span class=o>?:</span> <span class=o>?</span><span class=nb>Array</span><span class=o>&lt;</span><span class=nx>VNode</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>text</span><span class=o>?:</span> <span class=nx>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>elm</span><span class=o>?:</span> <span class=nx>Node</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span><span class=o>?:</span> <span class=nx>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>componentOptions</span><span class=o>?:</span> <span class=nx>VNodeComponentOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>asyncFactory</span><span class=o>?:</span> <span class=nb>Function</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// DEPRECATED: alias for componentInstance for backwards compat.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/* istanbul ignore next */</span>
</span></span><span class=line><span class=cl>  <span class=nx>get</span> <span class=nx>child</span> <span class=p>()</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>|</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>componentInstance</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>其实 VNode 是对真实 DOM 的⼀种抽象描述，它的核心定义无非就几个关键属性，<strong>标签名、数据、子节点、键值等</strong>，其它属性都是都是用来扩展 VNode 的灵活性以及实现⼀些特殊 feature 的。由于 VNode 只是用来映射到真实 DOM 的渲染，不需要包含操作 DOM 的方法，因此它是非常轻量和简单的。</p><a href=#update><h4 id=update><span class=hanchor arialabel=Anchor># </span>update</h4></a><p>Vue 的 _update 是实例的⼀个私有方法，<strong>它被调用的时机有 2 个，⼀个是首次渲染，⼀个是数据更新的时候；</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src/core/instance/lifecycle.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_update</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>vnode</span><span class=o>:</span> <span class=nx>VNode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=o>?:</span> <span class=kr>boolean</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>prevEl</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>prevVnode</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_vnode</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>restoreActiveInstance</span> <span class=o>=</span> <span class=nx>setActiveInstance</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_vnode</span> <span class=o>=</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Vue.prototype.__patch__ is injected in entry points
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// based on the rendering backend used.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>prevVnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// initial render
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* removeOnly */</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// updates
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>prevVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>restoreActiveInstance</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// update __vue__ reference
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>prevEl</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>prevEl</span><span class=p>.</span><span class=nx>__vue__</span> <span class=o>=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>.</span><span class=nx>__vue__</span> <span class=o>=</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// if parent is an HOC, update its $el as well
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>&amp;&amp;</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span> <span class=o>&amp;&amp;</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>===</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// updated hook is called by the scheduler to ensure that children are
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// updated in a parent&#39;s updated hook.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里逻辑不用看，下面会详细说，我们知道最后会进入<code>__patch__</code> 即可</p><p>核心方法<code>__patch__</code> 区分服务端渲染</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/platforms/web/runtime/index.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>__patch__</span> <span class=o>=</span> <span class=nx>inBrowser</span> <span class=o>?</span> <span class=nx>patch</span> <span class=o>:</span> <span class=nx>noop</span>
</span></span><span class=line><span class=cl><span class=c1>// src\platforms\web\runtime\patch.js
</span></span></span><span class=line><span class=cl><span class=c1>//每个平台都有各⾃的 nodeOps 和 modules
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>patch</span><span class=o>:</span> <span class=nb>Function</span> <span class=o>=</span> <span class=nx>createPatchFunction</span><span class=p>({</span> <span class=nx>nodeOps</span><span class=p>,</span> <span class=nx>modules</span> <span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>VDom 进行 diff 的地方 ，后面再来分析</p><p>// TODO:diff</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/core/vdom/patch.js
</span></span></span></code></pre></td></tr></table></div></div><a href=#总结><h3 id=总结><span class=hanchor arialabel=Anchor># </span>总结</h3></a><ul><li>首先 new Vue()</li><li>=> init() 进行全局属性和生命周期等注入<ul><li>beforeMount</li></ul></li><li>=> 将$mount 挂载</li><li>=> <code>_render</code> 函数将 temlate 转化成 Vdom</li><li>=> <code>_patch</code>将 Vdom 转化成真实 DOM<ul><li>初次渲染，不用 diff</li><li>Dom 变化，diff 算法后 异步更新</li></ul></li><li>渲染完成，等待更新<ul><li>Mounted</li></ul></li></ul><a href=#组件化><h2 id=组件化><span class=hanchor arialabel=Anchor># </span>组件化</h2></a><a href=#createelement><h3 id=createelement><span class=hanchor arialabel=Anchor># </span><strong>createElement</strong></h3></a><p>createElement 有三个分支逻辑</p><ol><li>假如是普通的 html 标签，渲染一个 VNode</li><li>假如是 componen 且 options 中注册了 ，就进入 createComponent 逻辑</li><li>不命名 tag，也创建一个 VNode</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src\core\vdom\create-element.js  function _createElement
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>tag</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>Ctor</span>
</span></span><span class=line><span class=cl>    <span class=nx>ns</span> <span class=o>=</span> <span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>&amp;&amp;</span> <span class=nx>context</span><span class=p>.</span><span class=nx>$vnode</span><span class=p>.</span><span class=nx>ns</span><span class=p>)</span> <span class=o>||</span> <span class=nx>config</span><span class=p>.</span><span class=nx>getTagNamespace</span><span class=p>(</span><span class=nx>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>isReservedTag</span><span class=p>(</span><span class=nx>tag</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// platform built-in elements
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vnode</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>VNode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>config</span><span class=p>.</span><span class=nx>parsePlatformTagName</span><span class=p>(</span><span class=nx>tag</span><span class=p>),</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>undefined</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>context</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=o>!</span><span class=nx>data</span> <span class=o>||</span> <span class=o>!</span><span class=nx>data</span><span class=p>.</span><span class=nx>pre</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>Ctor</span> <span class=o>=</span> <span class=nx>resolveAsset</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nx>$options</span><span class=p>,</span> <span class=s1>&#39;components&#39;</span><span class=p>,</span> <span class=nx>tag</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// component
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>createComponent</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span> <span class=nx>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// unknown or unlisted namespaced elements
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// check at runtime because it may get assigned a namespace when its
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// parent normalizes children
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vnode</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>VNode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>tag</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=kc>undefined</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>context</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 组件的构造函数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>createComponent</span><span class=p>(</span><span class=nx>tag</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>children</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#createcomponent><h3 id=createcomponent><span class=hanchor arialabel=Anchor># </span>createComponent</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>createComponent</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>Ctor</span><span class=o>:</span> <span class=nx>Class</span><span class=o>&lt;</span><span class=nx>Component</span><span class=o>&gt;</span> <span class=o>|</span> <span class=nb>Function</span> <span class=o>|</span> <span class=nb>Object</span> <span class=o>|</span> <span class=k>void</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span><span class=o>:</span> <span class=o>?</span><span class=nx>VNodeData</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>context</span><span class=o>:</span> <span class=nx>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span><span class=o>:</span> <span class=o>?</span><span class=nb>Array</span><span class=o>&lt;</span><span class=nx>VNode</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>tag</span><span class=o>?:</span> <span class=nx>string</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>VNode</span> <span class=o>|</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>VNode</span><span class=o>&gt;</span> <span class=o>|</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// plain options object: turn it into a constructor
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Ctor</span> <span class=o>=</span> <span class=nx>baseCtor</span><span class=p>.</span><span class=nx>extend</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// async component
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>asyncFactory</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>cid</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>asyncFactory</span> <span class=o>=</span> <span class=nx>Ctor</span>
</span></span><span class=line><span class=cl>    <span class=nx>Ctor</span> <span class=o>=</span> <span class=nx>resolveAsyncComponent</span><span class=p>(</span><span class=nx>asyncFactory</span><span class=p>,</span> <span class=nx>baseCtor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>Ctor</span> <span class=o>===</span> <span class=kc>undefined</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// return a placeholder node for async component, which is rendered
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// as a comment node but preserves all the raw information for the node.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// the information will be used for async server-rendering and hydration.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=nx>createAsyncPlaceholder</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>asyncFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>tag</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>data</span> <span class=o>=</span> <span class=nx>data</span> <span class=o>||</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// resolve constructor options in case global mixins are applied after
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// component constructor creation
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>resolveConstructorOptions</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// transform component v-model data into props &amp; events
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>model</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>transformModel</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// extract props
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>propsData</span> <span class=o>=</span> <span class=nx>extractPropsFromVNodeData</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>Ctor</span><span class=p>,</span> <span class=nx>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// functional component
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>functional</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>createFunctionalComponent</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>,</span> <span class=nx>propsData</span><span class=p>,</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span> <span class=nx>children</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>listeners</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>on</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span><span class=p>.</span><span class=nx>on</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>nativeOn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=kr>abstract</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// abstract components do not keep anything
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// other than props &amp; listeners &amp; slot
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// work around flow
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>slot</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>slot</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>slot</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span><span class=p>.</span><span class=nx>slot</span> <span class=o>=</span> <span class=nx>slot</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// install component management hooks onto the placeholder node
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>installComponentHooks</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// return a placeholder vnode
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>name</span> <span class=o>||</span> <span class=nx>tag</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>vnode</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>VNode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=sb>`vue-component-</span><span class=si>${</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>cid</span><span class=si>}${</span><span class=nx>name</span> <span class=o>?</span> <span class=sb>`-</span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb>`</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nx>Ctor</span><span class=p>,</span> <span class=nx>propsData</span><span class=p>,</span> <span class=nx>listeners</span><span class=p>,</span> <span class=nx>tag</span><span class=p>,</span> <span class=nx>children</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>asyncFactory</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>去掉多余的判断，可以整理出他做了三件事</p><a href=#构造子类构造函数><h4 id=构造子类构造函数><span class=hanchor arialabel=Anchor># </span>构造子类构造函数</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;app&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>components</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>HelloWorld</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 我们平时传入的都是一个对象
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Ctor</span> <span class=o>=</span> <span class=nx>baseCtor</span><span class=p>.</span><span class=nx>extend</span><span class=p>(</span><span class=nx>Ctor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>//src/core/global-api/extend.js
</span></span></span></code></pre></td></tr></table></div></div><p>Vue.extend 的作用就是构造⼀个 Vue 的子类，它使用⼀种非常经典的原型继承的方式把⼀个纯对 象转换⼀个继承于 Vue 的构造器 Sub 并返回，然后对 Sub 这个对象本⾝扩展了⼀些属性，如扩 展 options 、添加全局 API 等；并且对配置中的 props 和 computed 做了初始化⼯作；最后对于 这个 Sub 构造函数做了缓存，避免多次执行 Vue.extend 的时候对同⼀个子组件重复构造。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=nx>Vue</span><span class=p>.</span><span class=nx>extend</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>extendOptions</span><span class=o>:</span> <span class=nb>Object</span><span class=p>)</span><span class=o>:</span> <span class=nb>Function</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>extendOptions</span> <span class=o>=</span> <span class=nx>extendOptions</span> <span class=o>||</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>Super</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>SuperId</span> <span class=o>=</span> <span class=nx>Super</span><span class=p>.</span><span class=nx>cid</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>cachedCtors</span> <span class=o>=</span> <span class=nx>extendOptions</span><span class=p>.</span><span class=nx>_Ctor</span> <span class=o>||</span> <span class=p>(</span><span class=nx>extendOptions</span><span class=p>.</span><span class=nx>_Ctor</span> <span class=o>=</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cachedCtors</span><span class=p>[</span><span class=nx>SuperId</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>cachedCtors</span><span class=p>[</span><span class=nx>SuperId</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>extendOptions</span><span class=p>.</span><span class=nx>name</span> <span class=o>||</span> <span class=nx>Super</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>name</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>validateComponentName</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>Sub</span> <span class=o>=</span> <span class=kd>function</span> <span class=nx>VueComponent</span> <span class=p>(</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>_init</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>prototype</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>Super</span><span class=p>.</span><span class=nx>prototype</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>constructor</span> <span class=o>=</span> <span class=nx>Sub</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>cid</span> <span class=o>=</span> <span class=nx>cid</span><span class=o>++</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>options</span> <span class=o>=</span> <span class=nx>mergeOptions</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>Super</span><span class=p>.</span><span class=nx>options</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>extendOptions</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>[</span><span class=s1>&#39;super&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>Super</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// For props and computed properties, we define the proxy getters on
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// the Vue instances at extension time, on the extended prototype. This
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// avoids Object.defineProperty calls for each instance created.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>Sub</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>props</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>initProps</span><span class=p>(</span><span class=nx>Sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>Sub</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>computed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>initComputed</span><span class=p>(</span><span class=nx>Sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// allow further extension/mixin/plugin usage
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>extend</span> <span class=o>=</span> <span class=nx>Super</span><span class=p>.</span><span class=nx>extend</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>mixin</span> <span class=o>=</span> <span class=nx>Super</span><span class=p>.</span><span class=nx>mixin</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>use</span> <span class=o>=</span> <span class=nx>Super</span><span class=p>.</span><span class=nx>use</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// create asset registers, so extended classes
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// can have their private assets too.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ASSET_TYPES</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Sub</span><span class=p>[</span><span class=nx>type</span><span class=p>]</span> <span class=o>=</span> <span class=nx>Super</span><span class=p>[</span><span class=nx>type</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=c1>// enable recursive self-lookup
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Sub</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>components</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>Sub</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// keep a reference to the super options at extension time.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// later at instantiation we can check if Super&#39;s options have
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// been updated.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>superOptions</span> <span class=o>=</span> <span class=nx>Super</span><span class=p>.</span><span class=nx>options</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>extendOptions</span> <span class=o>=</span> <span class=nx>extendOptions</span>
</span></span><span class=line><span class=cl>    <span class=nx>Sub</span><span class=p>.</span><span class=nx>sealedOptions</span> <span class=o>=</span> <span class=nx>extend</span><span class=p>({},</span> <span class=nx>Sub</span><span class=p>.</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// cache constructor
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>cachedCtors</span><span class=p>[</span><span class=nx>SuperId</span><span class=p>]</span> <span class=o>=</span> <span class=nx>Sub</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>Sub</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#安装组件钩子函数><h4 id=安装组件钩子函数><span class=hanchor arialabel=Anchor># </span>安装组件钩子函数</h4></a><p>整个 <strong>installComponentHooks</strong> 的过程就是把 componentVNodeHooks 的钩子函数合并到 <strong>data.hook</strong> 中，在 VNode 执行 patch 的过程中执行相关的钩子函数,但他的 Marge 不是覆盖，而是按顺序执行。</p><a href=#实例化-vnode><h4 id=实例化-vnode><span class=hanchor arialabel=Anchor># </span>实例化 VNode</h4></a><p>最后⼀步非常简单，通过 new VNode 实例化⼀个 vnode 并返回。需要注意的是和普通元素节点的 vnode 不同，组件的 vnode 是没有 children 的，这点很关键。</p><a href=#patch><h3 id=patch><span class=hanchor arialabel=Anchor># </span>patch</h3></a><p><strong>执行 vm.patch 去把 VNode 转换成真正的 DOM 节点。</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src/core/vdom/patch.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>createElm</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>parentElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>refElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>nested</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>ownerArray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>index</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>createComponent</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>parentElm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#createcomponent-1><h4 id=createcomponent-1><span class=hanchor arialabel=Anchor># </span>createComponent</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl>	<span class=kd>function</span> <span class=nx>createComponent</span> <span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>parentElm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>i</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kr>const</span> <span class=nx>isReactivated</span> <span class=o>=</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>i</span><span class=p>.</span><span class=nx>keepAlive</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>i</span><span class=p>.</span><span class=nx>hook</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>i</span> <span class=o>=</span> <span class=nx>i</span><span class=p>.</span><span class=nx>init</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>i</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* hydrating */</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>//调用init钩子后，如果vnode为子组件。
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>//它应该已经创建子实例并挂载它。这孩子。
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>//组件还设置了占位符vnode的elm。
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>//在这种情况下，我们只需返回元素即可完成。
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>//属性回调执行
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>initComponent</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=c1>//追加到父组件
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>insert</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>isReactivated</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>reactivateComponent</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>parentElm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果 vnode 是⼀个组件 VNode，那么条件会满⾜，并且得到 i 就是 init 钩子函数，执行<code>_init</code></p><p>子组件的实例化实际上就是在这个时机执行的，并且它会执行实例的 _init 方法，</p><a href=#_render><h4 id=_render><span class=hanchor arialabel=Anchor># </span>_render()</h4></a><p>然后进行_render()</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>// src/core/instance/render.js
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_render</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span><span class=o>:</span> <span class=nx>VNode</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>render</span><span class=p>,</span> <span class=nx>_parentVnode</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>_parentVnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$scopedSlots</span> <span class=o>=</span> <span class=nx>normalizeScopedSlots</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>_parentVnode</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>scopedSlots</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span><span class=p>.</span><span class=nx>$slots</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span><span class=p>.</span><span class=nx>$scopedSlots</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>=</span> <span class=nx>_parentVnode</span>
</span></span><span class=line><span class=cl>    <span class=c1>// render self
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>currentRenderingInstance</span> <span class=o>=</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>render</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_renderProxy</span><span class=p>,</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$createElement</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果返回的数组只包含一个节点，则允许它
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>vnode</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span> <span class=o>=</span> <span class=nx>createEmptyVNode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// set parent
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vnode</span><span class=p>.</span><span class=nx>parent</span> <span class=o>=</span> <span class=nx>_parentVnode</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们只保留关键部分的代码，这里的 _parentVnode 就是当前组件的父 VNode，⽽ render 函数⽣ 成的 vnode 当前组件的渲染 vnode ， vnode 的 parent 指向了 _parentVnode ，也就是 vm.$vnode ，它们是⼀种父子的关系。</p><a href=#_update><h4 id=_update><span class=hanchor arialabel=Anchor># </span>_update</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src/core/instance/lifecycle.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>_update</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>vnode</span><span class=o>:</span> <span class=nx>VNode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=o>?:</span> <span class=kr>boolean</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>prevEl</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>prevVnode</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_vnode</span>
</span></span><span class=line><span class=cl>    <span class=c1>//是保持当前上下⽂的 Vue 实例，它是在 lifecycle 模块的全局变量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>restoreActiveInstance</span> <span class=o>=</span> <span class=nx>setActiveInstance</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_vnode</span> <span class=o>=</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Vue.prototype.__patch__ is injected in entry points
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// based on the rendering backend used.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>prevVnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// initial render
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* removeOnly */</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// updates
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>prevVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>restoreActiveInstance</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// update __vue__ reference
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>prevEl</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>prevEl</span><span class=p>.</span><span class=nx>__vue__</span> <span class=o>=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>.</span><span class=nx>__vue__</span> <span class=o>=</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// if parent is an HOC, update its $el as well
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>&amp;&amp;</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span> <span class=o>&amp;&amp;</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$vnode</span> <span class=o>===</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$parent</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// updated hook is called by the scheduler to ensure that children are
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// updated in a parent&#39;s updated hook.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里要理清，vm._vnode 和 vm.$vnode 的关系就是⼀种父子关系，用代码表示就是 **vm.<code>vnode.parent </code>=== vm.$vnode**</p><p>restoreActiveInstance 是用来保持递归过程中记录当前 vm 的 parent，当⼀个 vm 实例完成它的所有子树的 patch 或者 update 过程后，</p><p>restoreActiveInstance 回到他的父实例后，传入的 Vue 实例和 vm.$parent 依然能保留</p><a href=#__patch_><h4 id=__patch_><span class=hanchor arialabel=Anchor># </span><code>__patch_</code></h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* removeOnly */</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>patch</span> <span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>,</span> <span class=nx>removeOnly</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>isInitialPatch</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>insertedVnodeQueue</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 首次渲染
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// empty mount (likely as component), create new root element
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>isInitialPatch</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=nx>createElm</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#createelm><h5 id=createelm><span class=hanchor arialabel=Anchor># </span>createElm</h5></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl>	<span class=kd>function</span> <span class=nx>createElm</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>parentElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>refElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>nested</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>ownerArray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>index</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>ownerArray</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// This vnode was used in a previous render!
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// now it&#39;s used as a new node, overwriting its elm would cause
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// potential patch errors down the road when it&#39;s used as an insertion
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// reference node. Instead, we clone the node on-demand before creating
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// associated DOM element for it.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>vnode</span> <span class=o>=</span> <span class=nx>ownerArray</span><span class=p>[</span><span class=nx>index</span><span class=p>]</span> <span class=o>=</span> <span class=nx>cloneVNode</span><span class=p>(</span><span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>vnode</span><span class=p>.</span><span class=nx>isRootInsert</span> <span class=o>=</span> <span class=o>!</span><span class=nx>nested</span> <span class=c1>// for transition enter check
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=p>(</span><span class=nx>createComponent</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>parentElm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>		<span class=kr>const</span> <span class=nx>children</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>children</span>
</span></span><span class=line><span class=cl>		<span class=kr>const</span> <span class=nx>tag</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>tag</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>tag</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>data</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>pre</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>creatingElmInVPre</span><span class=o>++</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>isUnknownElement</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>creatingElmInVPre</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>						<span class=s1>&#39;Unknown custom element: &lt;&#39;</span> <span class=o>+</span> <span class=nx>tag</span> <span class=o>+</span> <span class=s1>&#39;&gt; - did you &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>						<span class=s1>&#39;register the component correctly? For recursive components, &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>						<span class=s1>&#39;make sure to provide the &#34;name&#34; option.&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=nx>vnode</span><span class=p>.</span><span class=nx>context</span>
</span></span><span class=line><span class=cl>					<span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>ns</span>
</span></span><span class=line><span class=cl>				<span class=o>?</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>createElementNS</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>ns</span><span class=p>,</span> <span class=nx>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=o>:</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>createElement</span><span class=p>(</span><span class=nx>tag</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>setScope</span><span class=p>(</span><span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=cm>/* istanbul ignore if */</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>__WEEX__</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// in Weex, the default insertion order is parent-first.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// List items can be optimized to use children-first insertion
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// with append=&#34;tree&#34;.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=kr>const</span> <span class=nx>appendAsTree</span> <span class=o>=</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isTrue</span><span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>appendAsTree</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>appendAsTree</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>invokeCreateHooks</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>insert</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>createChildren</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>appendAsTree</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>invokeCreateHooks</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>insert</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>createChildren</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>children</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>invokeCreateHooks</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>insert</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>pre</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>creatingElmInVPre</span><span class=o>--</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>isComment</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span> <span class=o>=</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>createComment</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>insert</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span> <span class=o>=</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>createTextNode</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>insert</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>又回到了这里，当遇到普通的 VNode createComponent 就会返回 false，然后重新上面创建父占位符，并遍历所有子 VNode 调用<strong>createElm</strong> 当遇到组件 VNode 则进行深入的递归</p><p>在完成组件的整个 patch 过程后，最后执行 <strong>insert(parentElm, vnode.elm, refElm)</strong> 完成组件的 DOM 插入，<strong>如果组件 patch 过程中又创建了子组件，那么 DOM 的插入顺序是先子后父。</strong></p><a href=#总结-1><h3 id=总结-1><span class=hanchor arialabel=Anchor># </span>总结</h3></a><p>第一次渲染，没有 oldVodeTree，就是创建占位符 => 遍历子 VNode => 遇到组件 VNode => 向下递归 然后开始 DOM 操作 直到回到占位符的位置。</p><p>这一圈下来，基本的执行流程和代码都有了眼缘了，我们开始深入一些细节进行学习。</p><a href=#深入响应式原理><h2 id=深入响应式原理><span class=hanchor arialabel=Anchor># </span>深入响应式原理</h2></a><p>Vue 的数据驱动除了数据渲染 DOM 之外，还有⼀个很重要的体现就是<strong>数据的变更会触发 DOM 的变化</strong></p><a href=#响应式对象><h3 id=响应式对象><span class=hanchor arialabel=Anchor># </span>响应式对象</h3></a><p>过 Vue.js 实现响应式的核⼼是利用了 ES5 的 <strong>Object.defineProperty</strong> ， 这也是为什么 Vue.js 不能兼容 IE8 及以下浏览器的原因。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src\core\instance\state.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>initState</span> <span class=p>(</span><span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span><span class=p>.</span><span class=nx>_watchers</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>opts</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>props</span><span class=p>)</span> <span class=nx>initProps</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>props</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>methods</span><span class=p>)</span> <span class=nx>initMethods</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>methods</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>initData</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>observe</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_data</span> <span class=o>=</span> <span class=p>{},</span> <span class=kc>true</span> <span class=cm>/* asRootData */</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>computed</span><span class=p>)</span> <span class=nx>initComputed</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>computed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>watch</span> <span class=o>&amp;&amp;</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>watch</span> <span class=o>!==</span> <span class=nx>nativeWatch</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>initWatch</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>watch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>其他暂且不管，我们先看到有 data 情况下的 initData 做了什么</p><p>值得注意的是初始化顺序是 prop => methods => data => computed => watch</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>initData</span> <span class=p>(</span><span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_data</span> <span class=o>=</span> <span class=k>typeof</span> <span class=nx>data</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=nx>getData</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=nx>vm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=nx>data</span> <span class=o>||</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isPlainObject</span><span class=p>(</span><span class=nx>data</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;data functions should return an object:\n&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// proxy data on instance
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>keys</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>props</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>props</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>methods</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>$options</span><span class=p>.</span><span class=nx>methods</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>keys</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>key</span> <span class=o>=</span> <span class=nx>keys</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>methods</span> <span class=o>&amp;&amp;</span> <span class=nx>hasOwn</span><span class=p>(</span><span class=nx>methods</span><span class=p>,</span> <span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=sb>`Method &#34;</span><span class=si>${</span><span class=nx>key</span><span class=si>}</span><span class=sb>&#34; has already been defined as a data property.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>vm</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>props</span> <span class=o>&amp;&amp;</span> <span class=nx>hasOwn</span><span class=p>(</span><span class=nx>props</span><span class=p>,</span> <span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sb>`The data property &#34;</span><span class=si>${</span><span class=nx>key</span><span class=si>}</span><span class=sb>&#34; is already declared as a prop. `</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>        <span class=sb>`Use prop default value instead.`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isReserved</span><span class=p>(</span><span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>proxy</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=sb>`_data`</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// observe data
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>observe</span><span class=p>(</span><span class=nx>data</span><span class=p>,</span> <span class=kc>true</span> <span class=cm>/* asRootData */</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ol><li>首先是推荐了 function 写法，object 虽然支持但是会给个 warn</li><li>将每一个 data 都从 vm._data.xxx 代理到 vm.xxx 上</li><li>另外一个就是我们熟悉的 将遍历每个 key 转变成响应式</li></ol><p>proxy 的实现 是通过 defineProperty 将 vm._data 的 get 和 set 改成 null，同时将 vm.xxx 的读取都绑定到 vm._data 详细代码就不贴了</p><p>我们接下来看看下核心 observe 的实现</p><a href=#observe><h4 id=observe><span class=hanchor arialabel=Anchor># </span>observe</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>observe</span> <span class=p>(</span><span class=nx>value</span><span class=o>:</span> <span class=nx>any</span><span class=p>,</span> <span class=nx>asRootData</span><span class=o>:</span> <span class=o>?</span><span class=kr>boolean</span><span class=p>)</span><span class=o>:</span> <span class=nx>Observer</span> <span class=o>|</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=o>||</span> <span class=nx>value</span> <span class=k>instanceof</span> <span class=nx>VNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>ob</span><span class=o>:</span> <span class=nx>Observer</span> <span class=o>|</span> <span class=k>void</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>hasOwn</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=s1>&#39;__ob__&#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>value</span><span class=p>.</span><span class=nx>__ob__</span> <span class=k>instanceof</span> <span class=nx>Observer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ob</span> <span class=o>=</span> <span class=nx>value</span><span class=p>.</span><span class=nx>__ob__</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>shouldObserve</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=o>!</span><span class=nx>isServerRendering</span><span class=p>()</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=o>||</span> <span class=nx>isPlainObject</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=nb>Object</span><span class=p>.</span><span class=nx>isExtensible</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=o>!</span><span class=nx>value</span><span class=p>.</span><span class=nx>_isVue</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ob</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Observer</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>asRootData</span> <span class=o>&amp;&amp;</span> <span class=nx>ob</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ob</span><span class=p>.</span><span class=nx>vmCount</span><span class=o>++</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>ob</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这段很无趣，就是判断 VNode 上是否已有，没有就绑上个 new Observer(value) ，</p><a href=#observer><h4 id=observer><span class=hanchor arialabel=Anchor># </span>Observer</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>Observer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>value</span><span class=o>:</span> <span class=nx>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>dep</span><span class=o>:</span> <span class=nx>Dep</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>vmCount</span><span class=o>:</span> <span class=nx>number</span><span class=p>;</span> <span class=c1>// number of vms that have this object as root $data
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span> <span class=p>(</span><span class=nx>value</span><span class=o>:</span> <span class=nx>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>dep</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Dep</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>vmCount</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=nx>def</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=s1>&#39;__ob__&#39;</span><span class=p>,</span> <span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>hasProto</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>protoAugment</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>arrayMethods</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>copyAugment</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=nx>arrayMethods</span><span class=p>,</span> <span class=nx>arrayKeys</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>observeArray</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>walk</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Walk through all properties and convert them into
</span></span></span><span class=line><span class=cl><span class=cm>   * getter/setters. This method should only be called when
</span></span></span><span class=line><span class=cl><span class=cm>   * value type is Object.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>walk</span> <span class=p>(</span><span class=nx>obj</span><span class=o>:</span> <span class=nb>Object</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>keys</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>keys</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>defineReactive</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>keys</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>observeArray</span> <span class=p>(</span><span class=nx>items</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>any</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>items</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>observe</span><span class=p>(</span><span class=nx>items</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Observer 的构造函数逻辑很简单，首先<strong>实例化 Dep 对象</strong>，接着通过执行 def 函数把⾃⾝实例添加到数据对象 value 的 <strong>ob</strong> 属性上，后面就是对对象和数组区分遍历，进行对每个 key 值的响应式转化。</p><a href=#definereactive><h4 id=definereactive><span class=hanchor arialabel=Anchor># </span>defineReactive</h4></a><p>defineReactive 函数最开始初始化 Dep 对象的实例，接着拿到 obj 的属性描述符，然后对子对 象递归调用 observe 方法，这样就保证了无论 obj 的结构多复杂，它的所有子属性也能变成响应式的对象，这样我们访问或修改 obj 中⼀个嵌套较深的属性，也能触发 getter 和 setter。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>defineReactive</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>obj</span><span class=o>:</span> <span class=nb>Object</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>val</span><span class=o>:</span> <span class=nx>any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>customSetter</span><span class=o>?:</span> <span class=o>?</span><span class=nb>Function</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>shallow</span><span class=o>?:</span> <span class=kr>boolean</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>dep</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Dep</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>property</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>getOwnPropertyDescriptor</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>property</span> <span class=o>&amp;&amp;</span> <span class=nx>property</span><span class=p>.</span><span class=nx>configurable</span> <span class=o>===</span> <span class=kc>false</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// cater for pre-defined getter/setters
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>getter</span> <span class=o>=</span> <span class=nx>property</span> <span class=o>&amp;&amp;</span> <span class=nx>property</span><span class=p>.</span><span class=nx>get</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>setter</span> <span class=o>=</span> <span class=nx>property</span> <span class=o>&amp;&amp;</span> <span class=nx>property</span><span class=p>.</span><span class=nx>set</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=o>!</span><span class=nx>getter</span> <span class=o>||</span> <span class=nx>setter</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>arguments</span><span class=p>.</span><span class=nx>length</span> <span class=o>===</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>val</span> <span class=o>=</span> <span class=nx>obj</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>childOb</span> <span class=o>=</span> <span class=o>!</span><span class=nx>shallow</span> <span class=o>&amp;&amp;</span> <span class=nx>observe</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>Object</span><span class=p>.</span><span class=nx>defineProperty</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>enumerable</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>configurable</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>get</span><span class=o>:</span> <span class=kd>function</span> <span class=nx>reactiveGetter</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>value</span> <span class=o>=</span> <span class=nx>getter</span> <span class=o>?</span> <span class=nx>getter</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=o>:</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>dep</span><span class=p>.</span><span class=nx>depend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>childOb</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>childOb</span><span class=p>.</span><span class=nx>dep</span><span class=p>.</span><span class=nx>depend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>dependArray</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>set</span><span class=o>:</span> <span class=kd>function</span> <span class=nx>reactiveSetter</span> <span class=p>(</span><span class=nx>newVal</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>value</span> <span class=o>=</span> <span class=nx>getter</span> <span class=o>?</span> <span class=nx>getter</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=o>:</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>      <span class=cm>/* eslint-disable no-self-compare */</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>newVal</span> <span class=o>===</span> <span class=nx>value</span> <span class=o>||</span> <span class=p>(</span><span class=nx>newVal</span> <span class=o>!==</span> <span class=nx>newVal</span> <span class=o>&amp;&amp;</span> <span class=nx>value</span> <span class=o>!==</span> <span class=nx>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=cm>/* eslint-enable no-self-compare */</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>customSetter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>customSetter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// #7981: for accessor properties without setter
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>getter</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>setter</span><span class=p>)</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>setter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>setter</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>newVal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>val</span> <span class=o>=</span> <span class=nx>newVal</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>childOb</span> <span class=o>=</span> <span class=o>!</span><span class=nx>shallow</span> <span class=o>&amp;&amp;</span> <span class=nx>observe</span><span class=p>(</span><span class=nx>newVal</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>dep</span><span class=p>.</span><span class=nx>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#依赖收集><h4 id=依赖收集><span class=hanchor arialabel=Anchor># </span>依赖收集</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kd>let</span> <span class=nx>uid</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>class</span> <span class=nx>Dep</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>target</span><span class=o>:</span> <span class=o>?</span><span class=nx>Watcher</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>id</span><span class=o>:</span> <span class=nx>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>subs</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>Watcher</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=nx>uid</span><span class=o>++</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>subs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>addSub</span> <span class=p>(</span><span class=nx>sub</span><span class=o>:</span> <span class=nx>Watcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>subs</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>removeSub</span> <span class=p>(</span><span class=nx>sub</span><span class=o>:</span> <span class=nx>Watcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>remove</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>subs</span><span class=p>,</span> <span class=nx>sub</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>depend</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>addDep</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>notify</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// stabilize the subscriber list first
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>subs</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>subs</span><span class=p>.</span><span class=nx>slice</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>config</span><span class=p>.</span><span class=kr>async</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// subs aren&#39;t sorted in scheduler if not running async
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// we need to sort them now to make sure they fire in correct
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// order
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>subs</span><span class=p>.</span><span class=nx>sort</span><span class=p>((</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>a</span><span class=p>.</span><span class=nx>id</span> <span class=o>-</span> <span class=nx>b</span><span class=p>.</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>subs</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>subs</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>update</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Dep 是⼀个 Class，它定义了⼀些属性和方法，这里需要特别注意的是它有⼀个静态属性 target ， 这是⼀个全局唯⼀ Watcher ，这是⼀个非常巧妙的设计，因为在同⼀时间只能有⼀个全局的 Watcher 被计算，另外它的自身属性 subs 也是 Watcher 的数组。</p><p>Vue 的 mount 过程是通过 mountComponent 函数，其中有⼀段比较重要的逻辑，大致如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl>  <span class=nx>updateComponent</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>_update</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_render</span><span class=p>(),</span> <span class=nx>hydrating</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>new</span> <span class=nx>Watcher</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>updateComponent</span><span class=p>,</span> <span class=nx>noop</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>before</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isMounted</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isDestroyed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>callHook</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=s1>&#39;beforeUpdate&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=kc>true</span> <span class=cm>/* isRenderWatcher */</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>每一个组件都会生成一个 Watcher 里面生成一个 Dep(),里面每个对象值都持有一个 dep，当 render 时，会触发所有数据的 getter 进行 dep.append() 方法（这里会做逻辑判断，防止同样的数据重复添加）。就完成了依赖收集，</strong></p><p>接下来因为 Vue 是数据驱动的，所以每次数据变化都会重新 render，那么 vm._render() 方法又会再次执行，并再次触发数据的 getters，<strong>所以 Wathcer 在构造函数中会初始化 2 个 Dep 实例数组， newDeps 表示新添加的 Dep 实例数组，而 deps 表示上⼀次添加的 Dep 实例数组。</strong> 在执行 cleanupDeps 函数的时候，会首先遍历 deps ，移除对 dep 的订阅，然后把 newDepIds 和 depIds 交换， newDeps 和 deps 交换，并把 newDepIds 和 newDeps 清空。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src\core\observer\watcher.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>let</span> <span class=nx>uid</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * A watcher parses an expression, collects dependencies,
</span></span></span><span class=line><span class=cl><span class=cm> * and fires callback when the expression value changes.
</span></span></span><span class=line><span class=cl><span class=cm> * This is used for both the $watch() api and directives.
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>class</span> <span class=nx>Watcher</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>expression</span><span class=o>:</span> <span class=nx>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>cb</span><span class=o>:</span> <span class=nb>Function</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>id</span><span class=o>:</span> <span class=nx>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>deep</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>user</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>lazy</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>sync</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>dirty</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>active</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>deps</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>Dep</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>newDeps</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>Dep</span><span class=o>&gt;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>depIds</span><span class=o>:</span> <span class=nx>SimpleSet</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>newDepIds</span><span class=o>:</span> <span class=nx>SimpleSet</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>before</span><span class=o>:</span> <span class=o>?</span><span class=nb>Function</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>getter</span><span class=o>:</span> <span class=nb>Function</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>value</span><span class=o>:</span> <span class=nx>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>expOrFn</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=nb>Function</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>cb</span><span class=o>:</span> <span class=nb>Function</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span><span class=o>?:</span> <span class=o>?</span><span class=nb>Object</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>isRenderWatcher</span><span class=o>?:</span> <span class=kr>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>vm</span> <span class=o>=</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>isRenderWatcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>_watcher</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>_watchers</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// options
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>options</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>deep</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>deep</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>user</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>user</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>lazy</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>lazy</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>sync</span> <span class=o>=</span> <span class=o>!!</span><span class=nx>options</span><span class=p>.</span><span class=nx>sync</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>before</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>before</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>deep</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>user</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>lazy</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>sync</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>cb</span> <span class=o>=</span> <span class=nx>cb</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=o>++</span><span class=nx>uid</span> <span class=c1>// uid for batching
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>active</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>dirty</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>lazy</span> <span class=c1>// for lazy watchers
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>deps</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>depIds</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>expression</span> <span class=o>=</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span>
</span></span><span class=line><span class=cl>      <span class=o>?</span> <span class=nx>expOrFn</span><span class=p>.</span><span class=nx>toString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=o>:</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// parse expression for getter
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>expOrFn</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>getter</span> <span class=o>=</span> <span class=nx>expOrFn</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>getter</span> <span class=o>=</span> <span class=nx>parsePath</span><span class=p>(</span><span class=nx>expOrFn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>getter</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>getter</span> <span class=o>=</span> <span class=nx>noop</span>
</span></span><span class=line><span class=cl>        <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=sb>`Failed watching path: &#34;</span><span class=si>${</span><span class=nx>expOrFn</span><span class=si>}</span><span class=sb>&#34; `</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;Watcher only accepts simple dot-delimited paths. &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=s1>&#39;For full control, use a function instead.&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>vm</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>lazy</span>
</span></span><span class=line><span class=cl>      <span class=o>?</span> <span class=kc>undefined</span>
</span></span><span class=line><span class=cl>      <span class=o>:</span> <span class=k>this</span><span class=p>.</span><span class=nx>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Evaluate the getter, and re-collect dependencies.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>get</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>pushTarget</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>getter</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>vm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>handleError</span><span class=p>(</span><span class=nx>e</span><span class=p>,</span> <span class=nx>vm</span><span class=p>,</span> <span class=sb>`getter for watcher &#34;</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>expression</span><span class=si>}</span><span class=sb>&#34;`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>throw</span> <span class=nx>e</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// &#34;touch&#34; every property so they are all tracked as
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// dependencies for deep watching
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>deep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>traverse</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>popTarget</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>cleanupDeps</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Add a dependency to this directive.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>addDep</span> <span class=p>(</span><span class=nx>dep</span><span class=o>:</span> <span class=nx>Dep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>id</span> <span class=o>=</span> <span class=nx>dep</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>dep</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>depIds</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>dep</span><span class=p>.</span><span class=nx>addSub</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Clean up for dependency collection.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>cleanupDeps</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>dep</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>dep</span><span class=p>.</span><span class=nx>id</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>dep</span><span class=p>.</span><span class=nx>removeSub</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>tmp</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>depIds</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>depIds</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span> <span class=o>=</span> <span class=nx>tmp</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDepIds</span><span class=p>.</span><span class=nx>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>tmp</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>deps</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span> <span class=o>=</span> <span class=nx>tmp</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>newDeps</span><span class=p>.</span><span class=nx>length</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Subscriber interface.
</span></span></span><span class=line><span class=cl><span class=cm>   * Will be called when a dependency changes.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>update</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* istanbul ignore else */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>lazy</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>dirty</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>sync</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>queueWatcher</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Scheduler job interface.
</span></span></span><span class=line><span class=cl><span class=cm>   * Will be called by the scheduler.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>run</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>active</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>value</span> <span class=o>!==</span> <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Deep watchers and watchers on Object/Arrays should fire even
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// when the value is the same, because the value may
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// have mutated.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>isObject</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>deep</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// set new value
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kr>const</span> <span class=nx>oldValue</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>value</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>cb</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>oldValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>handleError</span><span class=p>(</span><span class=nx>e</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>,</span> <span class=sb>`callback for watcher &#34;</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>expression</span><span class=si>}</span><span class=sb>&#34;`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>cb</span><span class=p>.</span><span class=nx>call</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>oldValue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Evaluate the value of the watcher.
</span></span></span><span class=line><span class=cl><span class=cm>   * This only gets called for lazy watchers.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>evaluate</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>dirty</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Depend on all deps collected by this watcher.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>depend</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>depend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * Remove self from all dependencies&#39; subscriber list.
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>teardown</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>active</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// remove self from vm&#39;s watcher list
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// this is a somewhat expensive operation so we skip it
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// if the vm is being destroyed.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_isBeingDestroyed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>remove</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_watchers</span><span class=p>,</span> <span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>      <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>deps</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>removeSub</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>active</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#派发更新><h4 id=派发更新><span class=hanchor arialabel=Anchor># </span>派发更新</h4></a><p>setter 的逻辑有 2 个关键的点，⼀个是 <strong>childOb = !shallow && observe(newVal)</strong> ，如果 shallow 为 false 的情况，会对新设置的值变成⼀个响应式对象；另⼀个是 dep.notify() ，通知所有的订阅者.</p><p><strong>Vue 派发更新的时候做了⼀个优化点，它并不会每次数据改变都触发 watcher 的回调，而是把这些 watcher 先添加到⼀个队列里，然后在 nextTick 后执行 flushSchedulerQueue 。</strong></p><a href=#nexttick><h3 id=nexttick><span class=hanchor arialabel=Anchor># </span>nextTick</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl> <span class=c1>//src/core/util/next-tick.js
</span></span></span><span class=line><span class=cl><span class=c1>// 代码在上面，就是浏览器兼容性从微任务降级到宏任务的过程
</span></span></span></code></pre></td></tr></table></div></div><a href=#特殊情况><h3 id=特殊情况><span class=hanchor arialabel=Anchor># </span>特殊情况</h3></a><a href=#set><h4 id=set><span class=hanchor arialabel=Anchor># </span>$set</h4></a><p>Vue 考虑到初始化时未声明情况，提供了$set 方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>set</span> <span class=p>(</span><span class=nx>target</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>any</span><span class=o>&gt;</span> <span class=o>|</span> <span class=nb>Object</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=nx>any</span><span class=p>,</span> <span class=nx>val</span><span class=o>:</span> <span class=nx>any</span><span class=p>)</span><span class=o>:</span> <span class=nx>any</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span> <span class=o>||</span> <span class=nx>isPrimitive</span><span class=p>(</span><span class=nx>target</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>warn</span><span class=p>(</span><span class=sb>`Cannot set reactive property on undefined, null, or primitive value: </span><span class=si>${</span><span class=p>(</span><span class=nx>target</span><span class=o>:</span> <span class=nx>any</span><span class=p>)</span><span class=si>}</span><span class=sb>`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>target</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isValidArrayIndex</span><span class=p>(</span><span class=nx>key</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span><span class=p>.</span><span class=nx>length</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>max</span><span class=p>(</span><span class=nx>target</span><span class=p>.</span><span class=nx>length</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span><span class=p>.</span><span class=nx>splice</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>key</span> <span class=k>in</span> <span class=nx>target</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=nx>key</span> <span class=k>in</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>prototype</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>ob</span> <span class=o>=</span> <span class=p>(</span><span class=nx>target</span><span class=o>:</span> <span class=nx>any</span><span class=p>).</span><span class=nx>__ob__</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>target</span><span class=p>.</span><span class=nx>_isVue</span> <span class=o>||</span> <span class=p>(</span><span class=nx>ob</span> <span class=o>&amp;&amp;</span> <span class=nx>ob</span><span class=p>.</span><span class=nx>vmCount</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;Avoid adding reactive properties to a Vue instance or its root $data &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;at runtime - declare it upfront in the data option.&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>ob</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>target</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>defineReactive</span><span class=p>(</span><span class=nx>ob</span><span class=p>.</span><span class=nx>value</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>ob</span><span class=p>.</span><span class=nx>dep</span><span class=p>.</span><span class=nx>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>val</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><code>set</code>方法接收 3 个参数， target 可能是数组或者是普通对象， key 代表的是数组的下标或者是对象的键值， val 代表添加的值。</p><a href=#array><h4 id=array><span class=hanchor arialabel=Anchor># </span>Array</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src\core\observer\array.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>methodsToPatch</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>method</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// cache original method
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>original</span> <span class=o>=</span> <span class=nx>arrayProto</span><span class=p>[</span><span class=nx>method</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>def</span><span class=p>(</span><span class=nx>arrayMethods</span><span class=p>,</span> <span class=nx>method</span><span class=p>,</span> <span class=kd>function</span> <span class=nx>mutator</span> <span class=p>(...</span><span class=nx>args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=nx>original</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ob</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>__ob__</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>inserted</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=nx>method</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;push&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;unshift&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>inserted</span> <span class=o>=</span> <span class=nx>args</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=s1>&#39;splice&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>inserted</span> <span class=o>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>inserted</span><span class=p>)</span> <span class=nx>ob</span><span class=p>.</span><span class=nx>observeArray</span><span class=p>(</span><span class=nx>inserted</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// notify change
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ob</span><span class=p>.</span><span class=nx>dep</span><span class=p>.</span><span class=nx>notify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>result</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>数组通过原生方法增加的 Key 都是没有经过响应式转换的，所以 Vue 把 push，unshift，splice 方法重新劫持了，当调用这些方法时，会重新遍历转化一遍。</p><a href=#计算属性-vs-侦听属性><h3 id=计算属性-vs-侦听属性><span class=hanchor arialabel=Anchor># </span>计算属性 VS 侦听属性</h3></a><a href=#initcomputed><h4 id=initcomputed><span class=hanchor arialabel=Anchor># </span>initComputed</h4></a><p>我们在 initComputed 中找到了这串代码</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src/core/instance/state.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>createComputedGetter</span> <span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kd>function</span> <span class=nx>computedGetter</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>watcher</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>_computedWatchers</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>_computedWatchers</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>watcher</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>watcher</span><span class=p>.</span><span class=nx>dirty</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>watcher</span><span class=p>.</span><span class=nx>evaluate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>Dep</span><span class=p>.</span><span class=nx>target</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>watcher</span><span class=p>.</span><span class=nx>depend</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>watcher</span><span class=p>.</span><span class=nx>value</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl>  <span class=nx>evaluate</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>value</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>dirty</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>计算属性本质上就是⼀个<code>computed watcher</code> ，也了解了它的创建过程和 被访问触发 getter 以及依赖更新的过程，其实这是最新的计算属性的实现，之所以这么设计是因为 Vue 想确保不仅仅是计算属性依赖的值发⽣变化，而是<strong>当计算属性最终计算的值发生变化才会触发</strong>渲染 watcher 重新渲染，本质上是⼀种优化。</p><a href=#initwatch><h4 id=initwatch><span class=hanchor arialabel=Anchor># </span>initWatch</h4></a><p>侦听属性也是基于 Watcher 实现的，它是⼀个 <code>user watcher</code> 。其实 Watcher ⽀持了 不同的类型，下⾯我们梳理⼀下它有哪些类型以及它们的作用。</p><a href=#deep><h5 id=deep><span class=hanchor arialabel=Anchor># </span>deep</h5></a><p>普通的 watch 值只会触发最外层对象的 getter，所以无法订阅其变化</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>deep</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>traverse</span><span class=p>(</span><span class=nx>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>//src/core/observer/traverse.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>_traverse</span> <span class=p>(</span><span class=nx>val</span><span class=o>:</span> <span class=nx>any</span><span class=p>,</span> <span class=nx>seen</span><span class=o>:</span> <span class=nx>SimpleSet</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>let</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>keys</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>isA</span> <span class=o>=</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=o>!</span><span class=nx>isA</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>isObject</span><span class=p>(</span><span class=nx>val</span><span class=p>))</span> <span class=o>||</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>isFrozen</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span> <span class=o>||</span> <span class=nx>val</span> <span class=k>instanceof</span> <span class=nx>VNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>val</span><span class=p>.</span><span class=nx>__ob__</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>depId</span> <span class=o>=</span> <span class=nx>val</span><span class=p>.</span><span class=nx>__ob__</span><span class=p>.</span><span class=nx>dep</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>seen</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=nx>depId</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>seen</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>depId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isA</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>i</span> <span class=o>=</span> <span class=nx>val</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=nx>_traverse</span><span class=p>(</span><span class=nx>val</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>seen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>keys</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>i</span> <span class=o>=</span> <span class=nx>keys</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=nx>_traverse</span><span class=p>(</span><span class=nx>val</span><span class=p>[</span><span class=nx>keys</span><span class=p>[</span><span class=nx>i</span><span class=p>]],</span> <span class=nx>seen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>traverse 的逻辑也很简单，它实际上就是对⼀个对象做深层递归遍历，因为遍历过程中就是<strong>对⼀个子对象的访问，会触发它们的 getter 过程</strong>，这样就可以收集到依赖，也就是订阅它们变化的 watcher ，这个函数实现还有⼀个小的优化，遍历过程中会把子响应式对象通过它们的 dep id 记 录到 seenObjects ，避免以后重复访问。</p><a href=#sync><h5 id=sync><span class=hanchor arialabel=Anchor># </span>sync</h5></a><p>当响应式数据发送变化后，触发了 watcher.update() ， 只是把这个 watcher 推送到⼀个队列中，在 nextTick 后才会真正执行 watcher 的回调函数。但是⼀旦我们设置了 sync ，就可以在当前 Tick 中同步执行 watcher 的回调函数。</p><a href=#组件更新><h3 id=组件更新><span class=hanchor arialabel=Anchor># </span>组件更新</h3></a><p>这里和初次渲染走了不同的 patch 方式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src\core\instance\lifecycle.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>prevVnode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// initial render
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/* removeOnly */</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// updates
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$el</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>__patch__</span><span class=p>(</span><span class=nx>prevVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里执行 patch 的逻辑和首次渲染是不⼀样的，因为 oldVnode 不为空，并且它和 vnode 都是 VNode 类型，接下来会通过 <strong>sameVNode(oldVnode, vnode)</strong> 判断它们是否是相同的 VNode 来决定⾛ 不同的更新逻辑：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span><span class=lnt>96
</span><span class=lnt>97
</span><span class=lnt>98
</span><span class=lnt>99
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl>   <span class=k>return</span> <span class=kd>function</span> <span class=nx>patch</span> <span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>,</span> <span class=nx>removeOnly</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>))</span> <span class=nx>invokeDestroyHook</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>isInitialPatch</span> <span class=o>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>insertedVnodeQueue</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// empty mount (likely as component), create new root element
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>isInitialPatch</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>            <span class=nx>createElm</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>isRealElement</span> <span class=o>=</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>nodeType</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isRealElement</span> <span class=o>&amp;&amp;</span> <span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// patch existing root node
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>patchVnode</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=nx>removeOnly</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=nx>isRealElement</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// mounting to a real element
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// check if this is server-rendered content and if we can perform
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// a successful hydration.
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>nodeType</span> <span class=o>===</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=nx>oldVnode</span><span class=p>.</span><span class=nx>hasAttribute</span><span class=p>(</span><span class=nx>SSR_ATTR</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nx>oldVnode</span><span class=p>.</span><span class=nx>removeAttribute</span><span class=p>(</span><span class=nx>SSR_ATTR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=nx>hydrating</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>isTrue</span><span class=p>(</span><span class=nx>hydrating</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=nx>hydrate</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>,</span> <span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nx>invokeInsertHook</span><span class=p>(</span><span class=nx>vnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=k>return</span> <span class=nx>oldVnode</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                                <span class=s1>&#39;The client-side rendered virtual DOM tree is not matching &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                                <span class=s1>&#39;server-rendered content. This is likely caused by incorrect &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                                <span class=s1>&#39;HTML markup, for example nesting block-level elements inside &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                                <span class=s1>&#39;&lt;p&gt;, or missing &lt;tbody&gt;. Bailing hydration and performing &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>                                <span class=s1>&#39;full client-side render.&#39;</span>
</span></span><span class=line><span class=cl>                            <span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// either not server-rendered, or hydration failed.
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// create an empty node and replace it
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=nx>oldVnode</span> <span class=o>=</span> <span class=nx>emptyNodeAt</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// replacing existing element
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=kr>const</span> <span class=nx>oldElm</span> <span class=o>=</span> <span class=nx>oldVnode</span><span class=p>.</span><span class=nx>elm</span>
</span></span><span class=line><span class=cl>                <span class=kr>const</span> <span class=nx>parentElm</span> <span class=o>=</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>parentNode</span><span class=p>(</span><span class=nx>oldElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// create new node
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>createElm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nx>insertedVnodeQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=c1>// extremely rare edge case: do not insert if old element is in a
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// leaving transition. Only happens when combining transition +
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=c1>// keep-alive + HOCs. (#4590)
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=nx>oldElm</span><span class=p>.</span><span class=nx>_leaveCb</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=nx>parentElm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>nextSibling</span><span class=p>(</span><span class=nx>oldElm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// update parent placeholder node element, recursively
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>parent</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=kd>let</span> <span class=nx>ancestor</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>parent</span>
</span></span><span class=line><span class=cl>                    <span class=kr>const</span> <span class=nx>patchable</span> <span class=o>=</span> <span class=nx>isPatchable</span><span class=p>(</span><span class=nx>vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>while</span> <span class=p>(</span><span class=nx>ancestor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>destroy</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=o>++</span><span class=nx>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nx>cbs</span><span class=p>.</span><span class=nx>destroy</span><span class=p>[</span><span class=nx>i</span><span class=p>](</span><span class=nx>ancestor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=nx>ancestor</span><span class=p>.</span><span class=nx>elm</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=p>(</span><span class=nx>patchable</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>create</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=o>++</span><span class=nx>i</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=nx>cbs</span><span class=p>.</span><span class=nx>create</span><span class=p>[</span><span class=nx>i</span><span class=p>](</span><span class=nx>emptyNode</span><span class=p>,</span> <span class=nx>ancestor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                            <span class=c1>// #6513
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=c1>// invoke insert hooks that may have been merged by create hooks.
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=c1>// e.g. for directives that uses the &#34;inserted&#34; hook.
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=kr>const</span> <span class=nx>insert</span> <span class=o>=</span> <span class=nx>ancestor</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>hook</span><span class=p>.</span><span class=nx>insert</span>
</span></span><span class=line><span class=cl>                            <span class=k>if</span> <span class=p>(</span><span class=nx>insert</span><span class=p>.</span><span class=nx>merged</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// start at index 1 to avoid re-invoking component mounted hook
</span></span></span><span class=line><span class=cl><span class=c1></span>                                <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>insert</span><span class=p>.</span><span class=nx>fns</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                                    <span class=nx>insert</span><span class=p>.</span><span class=nx>fns</span><span class=p>[</span><span class=nx>i</span><span class=p>]()</span>
</span></span><span class=line><span class=cl>                                <span class=p>}</span>
</span></span><span class=line><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=nx>registerRef</span><span class=p>(</span><span class=nx>ancestor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                        <span class=nx>ancestor</span> <span class=o>=</span> <span class=nx>ancestor</span><span class=p>.</span><span class=nx>parent</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// destroy old node
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>removeVnodes</span><span class=p>([</span><span class=nx>oldVnode</span><span class=p>],</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isDef</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>.</span><span class=nx>tag</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>invokeDestroyHook</span><span class=p>(</span><span class=nx>oldVnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>patchVnode 的规则是这样的：</p><p>1.如果新旧 VNode 都是静态的，同时它们的 key 相同（代表同一节点），并且新的 VNode 是 clone 或者是标记了 once（标记 v-once 属性，只渲染一次），那么只需要替换 elm 以及 componentInstance 即可。</p><p>2.新老节点均有 children 子节点，则对子节点进行 diff 操作，调用 updateChildren，这个 updateChildren 也是 diff 的核心。</p><p>3.如果老节点没有子节点而新节点存在子节点，先清空老节点 DOM 的文本内容，然后为当前 DOM 节点加入子节点。</p><p>4.当新节点没有子节点而老节点有子节点的时候，则移除该 DOM 节点的所有子节点。</p><p>5.当新老节点都无子节点的时候，只是文本的替换。</p><a href=#samenode><h4 id=samenode><span class=hanchor arialabel=Anchor># </span>samenode</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>sameVnode</span> <span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>a</span><span class=p>.</span><span class=nx>key</span> <span class=o>===</span> <span class=nx>b</span><span class=p>.</span><span class=nx>key</span> <span class=o>&amp;&amp;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>a</span><span class=p>.</span><span class=nx>tag</span> <span class=o>===</span> <span class=nx>b</span><span class=p>.</span><span class=nx>tag</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=nx>a</span><span class=p>.</span><span class=nx>isComment</span> <span class=o>===</span> <span class=nx>b</span><span class=p>.</span><span class=nx>isComment</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=nx>isDef</span><span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span> <span class=o>===</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>data</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=nx>sameInputType</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span> <span class=o>||</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>isTrue</span><span class=p>(</span><span class=nx>a</span><span class=p>.</span><span class=nx>isAsyncPlaceholder</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=nx>a</span><span class=p>.</span><span class=nx>asyncFactory</span> <span class=o>===</span> <span class=nx>b</span><span class=p>.</span><span class=nx>asyncFactory</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                <span class=nx>isUndef</span><span class=p>(</span><span class=nx>b</span><span class=p>.</span><span class=nx>asyncFactory</span><span class=p>.</span><span class=nx>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>sameVnode 的逻辑非常简单，如果两个 vnode 的 key 不相等，则是不同的；否则继续判断对于 同步组件，则判断 isComment 、 data 、 input 类型等是否相同，对于异步组件，则判断 asyncFactory 是否相同。</p><a href=#updatechildren><h4 id=updatechildren><span class=hanchor arialabel=Anchor># </span>updateChildren</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl> <span class=kd>function</span> <span class=nx>updateChildren</span> <span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>oldCh</span><span class=p>,</span> <span class=nx>newCh</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>removeOnly</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldStartIdx</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>newStartIdx</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldEndIdx</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldStartVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldEndVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=nx>oldEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>newEndIdx</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>.</span><span class=nx>length</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>newEndVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=nx>newEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldKeyToIdx</span><span class=p>,</span> <span class=nx>idxInOld</span><span class=p>,</span> <span class=nx>elmToMove</span><span class=p>,</span> <span class=nx>refElm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// removeOnly is a special flag used only by &lt;transition-group&gt;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// to ensure removed elements stay in correct relative positions
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// during leaving transitions
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>canMove</span> <span class=o>=</span> <span class=o>!</span><span class=nx>removeOnly</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>oldStartIdx</span> <span class=o>&lt;=</span> <span class=nx>oldEndIdx</span> <span class=o>&amp;&amp;</span> <span class=nx>newStartIdx</span> <span class=o>&lt;=</span> <span class=nx>newEndIdx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldStartVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldStartVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>++</span><span class=nx>oldStartIdx</span><span class=p>]</span> <span class=c1>// Vnode has been moved left
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldEndVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>--</span><span class=nx>oldEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldStartVnode</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/*前四种情况其实是指定key的时候，判定为同一个VNode，则直接patchVnode即可，分别比较oldCh以及newCh的两头节点2*2=4种情况*/</span>
</span></span><span class=line><span class=cl>        <span class=nx>patchVnode</span><span class=p>(</span><span class=nx>oldStartVnode</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldStartVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>++</span><span class=nx>oldStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>++</span><span class=nx>newStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>,</span> <span class=nx>newEndVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>patchVnode</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>,</span> <span class=nx>newEndVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldEndVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>--</span><span class=nx>oldEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>newEndVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>--</span><span class=nx>newEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldStartVnode</span><span class=p>,</span> <span class=nx>newEndVnode</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// Vnode moved right
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>patchVnode</span><span class=p>(</span><span class=nx>oldStartVnode</span><span class=p>,</span> <span class=nx>newEndVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>canMove</span> <span class=o>&amp;&amp;</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>insertBefore</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>nextSibling</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldStartVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>++</span><span class=nx>oldStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>newEndVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>--</span><span class=nx>newEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// Vnode moved left
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>patchVnode</span><span class=p>(</span><span class=nx>oldEndVnode</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>canMove</span> <span class=o>&amp;&amp;</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>insertBefore</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>oldEndVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>oldEndVnode</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=o>--</span><span class=nx>oldEndIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>++</span><span class=nx>newStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>          生成一个key与旧VNode的key对应的哈希表（只有第一次进来undefined的时候会生成，也为后面检测重复的key值做铺垫）
</span></span></span><span class=line><span class=cl><span class=cm>          比如childre是这样的 [{xx: xx, key: &#39;key0&#39;}, {xx: xx, key: &#39;key1&#39;}, {xx: xx, key: &#39;key2&#39;}]  beginIdx = 0   endIdx = 2
</span></span></span><span class=line><span class=cl><span class=cm>          结果生成{key0: 0, key1: 1, key2: 2}
</span></span></span><span class=line><span class=cl><span class=cm>        */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>oldKeyToIdx</span><span class=p>))</span> <span class=nx>oldKeyToIdx</span> <span class=o>=</span> <span class=nx>createKeyToOldIdx</span><span class=p>(</span><span class=nx>oldCh</span><span class=p>,</span> <span class=nx>oldStartIdx</span><span class=p>,</span> <span class=nx>oldEndIdx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=cm>/*如果newStartVnode新的VNode节点存在key并且这个key在oldVnode中能找到则返回这个节点的idxInOld（即第几个节点，下标）*/</span>
</span></span><span class=line><span class=cl>        <span class=nx>idxInOld</span> <span class=o>=</span> <span class=nx>isDef</span><span class=p>(</span><span class=nx>newStartVnode</span><span class=p>.</span><span class=nx>key</span><span class=p>)</span> <span class=o>?</span> <span class=nx>oldKeyToIdx</span><span class=p>[</span><span class=nx>newStartVnode</span><span class=p>.</span><span class=nx>key</span><span class=p>]</span> <span class=o>:</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isUndef</span><span class=p>(</span><span class=nx>idxInOld</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// New element
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=cm>/*newStartVnode没有key或者是该key没有在老节点中找到则创建一个新的节点*/</span>
</span></span><span class=line><span class=cl>          <span class=nx>createElm</span><span class=p>(</span><span class=nx>newStartVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>parentElm</span><span class=p>,</span> <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>++</span><span class=nx>newStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=cm>/*获取同key的老节点*/</span>
</span></span><span class=line><span class=cl>          <span class=nx>elmToMove</span> <span class=o>=</span> <span class=nx>oldCh</span><span class=p>[</span><span class=nx>idxInOld</span><span class=p>]</span>
</span></span><span class=line><span class=cl>          <span class=cm>/* istanbul ignore if */</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>elmToMove</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*如果elmToMove不存在说明之前已经有新节点放入过这个key的DOM中，提示可能存在重复的key，确保v-for的时候item有唯一的key值*/</span>
</span></span><span class=line><span class=cl>            <span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>              <span class=s1>&#39;It seems there are duplicate keys that is causing an update error. &#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>              <span class=s1>&#39;Make sure each v-for item has a unique key.&#39;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>sameVnode</span><span class=p>(</span><span class=nx>elmToMove</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*Github:https://github.com/answershuto*/</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*如果新VNode与得到的有相同key的节点是同一个VNode则进行patchVnode*/</span>
</span></span><span class=line><span class=cl>            <span class=nx>patchVnode</span><span class=p>(</span><span class=nx>elmToMove</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*因为已经patchVnode进去了，所以将这个老节点赋值undefined，之后如果还有新节点与该节点key相同可以检测出来提示已有重复的key*/</span>
</span></span><span class=line><span class=cl>            <span class=nx>oldCh</span><span class=p>[</span><span class=nx>idxInOld</span><span class=p>]</span> <span class=o>=</span> <span class=kc>undefined</span>
</span></span><span class=line><span class=cl>            <span class=cm>/*当有标识位canMove实可以直接插入oldStartVnode对应的真实DOM节点前面*/</span>
</span></span><span class=line><span class=cl>            <span class=nx>canMove</span> <span class=o>&amp;&amp;</span> <span class=nx>nodeOps</span><span class=p>.</span><span class=nx>insertBefore</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>newStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>,</span> <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>++</span><span class=nx>newStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// same key but different element. treat as new element
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=cm>/*当新的VNode与找到的同样key的VNode不是sameVNode的时候（比如说tag不一样或者是有不一样type的input标签），创建一个新的节点*/</span>
</span></span><span class=line><span class=cl>            <span class=nx>createElm</span><span class=p>(</span><span class=nx>newStartVnode</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>,</span> <span class=nx>parentElm</span><span class=p>,</span> <span class=nx>oldStartVnode</span><span class=p>.</span><span class=nx>elm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>newStartVnode</span> <span class=o>=</span> <span class=nx>newCh</span><span class=p>[</span><span class=o>++</span><span class=nx>newStartIdx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>oldStartIdx</span> <span class=o>&gt;</span> <span class=nx>oldEndIdx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/*全部比较完成以后，发现oldStartIdx &gt; oldEndIdx的话，说明老节点已经遍历完了，新节点比老节点多，所以这时候多出来的新节点需要一个一个创建出来加入到真实DOM中*/</span>
</span></span><span class=line><span class=cl>      <span class=nx>refElm</span> <span class=o>=</span> <span class=nx>isUndef</span><span class=p>(</span><span class=nx>newCh</span><span class=p>[</span><span class=nx>newEndIdx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>])</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=nx>newCh</span><span class=p>[</span><span class=nx>newEndIdx</span> <span class=o>+</span> <span class=mi>1</span><span class=p>].</span><span class=nx>elm</span>
</span></span><span class=line><span class=cl>      <span class=nx>addVnodes</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>refElm</span><span class=p>,</span> <span class=nx>newCh</span><span class=p>,</span> <span class=nx>newStartIdx</span><span class=p>,</span> <span class=nx>newEndIdx</span><span class=p>,</span> <span class=nx>insertedVnodeQueue</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>newStartIdx</span> <span class=o>&gt;</span> <span class=nx>newEndIdx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/*如果全部比较完成以后发现newStartIdx &gt; newEndIdx，则说明新节点已经遍历完了，老节点多余新节点，这个时候需要将多余的老节点从真实DOM中移除*/</span>
</span></span><span class=line><span class=cl>      <span class=nx>removeVnodes</span><span class=p>(</span><span class=nx>parentElm</span><span class=p>,</span> <span class=nx>oldCh</span><span class=p>,</span> <span class=nx>oldStartIdx</span><span class=p>,</span> <span class=nx>oldEndIdx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#手写简单-diff><h4 id=手写简单-diff><span class=hanchor arialabel=Anchor># </span>手写简单 diff</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>patchNode</span> <span class=p>(</span><span class=nx>oldNode</span><span class=p>,</span> <span class=nx>newNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>oldChildren</span> <span class=o>=</span> <span class=nx>oldNode</span><span class=p>.</span><span class=nx>children</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>newChildren</span> <span class=o>=</span> <span class=nx>newNode</span><span class=p>.</span><span class=nx>children</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 老的有子节点，新的没有就移除
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>oldChildren</span><span class=p>.</span><span class=nx>length</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>newChildren</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// remove oldChildren
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 老的没有子节点，新的有 就 清空老节点并将新节点加入到DOM下
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>oldChildren</span><span class=p>.</span><span class=nx>length</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>newChildren</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// oldChildren =null
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Dom.append(newChildren)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 都没有 就只做文本的替换
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>oldChildren</span><span class=p>.</span><span class=nx>length</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>newChildren</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 替换文本
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>update</span><span class=p>(</span><span class=nx>oldChildren</span><span class=p>,</span> <span class=nx>newChildren</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>someNode</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 优先判断 key 是否相同
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 异步组件 判断 asyncFactory  是否相同
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 同步组件 判断input,data,isComment  是否相同
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>update</span> <span class=p>(</span><span class=nx>oldNode</span><span class=p>,</span> <span class=nx>newNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>newStart</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldStart</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>oldEnd</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>newEnd</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>oldStart</span> <span class=o>&lt;=</span> <span class=nx>oldEnd</span> <span class=o>&amp;&amp;</span> <span class=nx>newStart</span> <span class=o>&lt;=</span> <span class=nx>newEnd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// someNode 判断后 都进入 patchVnode
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//新头和旧头
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nx>newStart</span> <span class=o>===</span> <span class=nx>oldStart</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>newStart</span><span class=o>++</span>
</span></span><span class=line><span class=cl>            <span class=nx>oldStart</span><span class=o>++</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//旧尾和新尾
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>oldEnd</span> <span class=o>===</span> <span class=nx>newEnd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>oldEnd</span><span class=o>--</span>
</span></span><span class=line><span class=cl>            <span class=nx>newEnd</span><span class=o>--</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//旧头和新尾
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>oldStart</span> <span class=o>===</span> <span class=nx>newEnd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>oldStart</span><span class=o>++</span>
</span></span><span class=line><span class=cl>            <span class=nx>newEnd</span><span class=o>--</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//新头和旧尾
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>newStart</span> <span class=o>===</span> <span class=nx>oldEnd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>newStart</span><span class=o>++</span>
</span></span><span class=line><span class=cl>            <span class=nx>oldEnd</span><span class=o>--</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//都找不到 就遍历oldNode 生成一个 {key:index} 的Map
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>let</span> <span class=nx>oldKeyToIdx</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>oldKeyToIdx</span><span class=p>[</span><span class=nx>newStart</span><span class=p>.</span><span class=nx>key</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// move 这个节点到 oldStart 之前 然后继续遍历
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>newStart</span><span class=o>++</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果找不到，或者 key 相同 但内容不相同
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>//createElm创建一个新的DOM节点。
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//循环完
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 新的比老的长 addVnodes 多出来的节点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 老的比新的长 removeVnodes 多出来的节点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#编译><h2 id=编译><span class=hanchor arialabel=Anchor># </span>编译</h2></a><p>编译就是把模板 template 编译⽣成 render 以及 staticRenderFns ，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>createCompiler</span> <span class=o>=</span> <span class=nx>createCompilerCreator</span><span class=p>(</span><span class=kd>function</span> <span class=nx>baseCompile</span> <span class=p>(</span>
</span></span><span class=line><span class=cl><span class=nx>template</span><span class=o>:</span> <span class=nx>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>options</span><span class=o>:</span> <span class=nx>CompilerOptions</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>CompiledResult</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>ast</span> <span class=o>=</span> <span class=nx>parse</span><span class=p>(</span><span class=nx>template</span><span class=p>.</span><span class=nx>trim</span><span class=p>(),</span> <span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>optimize</span><span class=p>(</span><span class=nx>ast</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>code</span> <span class=o>=</span> <span class=nx>generate</span><span class=p>(</span><span class=nx>ast</span><span class=p>,</span> <span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nx>ast</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>render</span><span class=o>:</span> <span class=nx>code</span><span class=p>.</span><span class=nx>render</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=nx>staticRenderFns</span><span class=o>:</span> <span class=nx>code</span><span class=p>.</span><span class=nx>staticRenderFns</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><a href=#parse><h3 id=parse><span class=hanchor arialabel=Anchor># </span>parse</h3></a><p>这一块就是类似 html 的解析，通过一个栈 每一次出栈都是一个标签的开闭结束，最后会生成一个 AST 抽象语法树。</p><p><img src=https://note.xiaopang.fun//images/image-20201206131358064.png width=auto alt=image-20201206131358064></p><a href=#optimization><h3 id=optimization><span class=hanchor arialabel=Anchor># </span>optimization</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>genStaticKeysCached</span> <span class=o>=</span> <span class=nx>cached</span><span class=p>(</span><span class=nx>genStaticKeys</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 遍历AST树找到永远不会改变的静态节点
</span></span></span><span class=line><span class=cl><span class=c1>//1.将它们提升为常量，这样我们就不再需要在每次重新渲染时为它们创建新节点；
</span></span></span><span class=line><span class=cl><span class=c1>//2.在打补丁过程中完全跳过它们。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>optimize</span> <span class=p>(</span><span class=nx>root</span><span class=o>:</span> <span class=o>?</span><span class=nx>ASTElement</span><span class=p>,</span> <span class=nx>options</span><span class=o>:</span> <span class=nx>CompilerOptions</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>root</span><span class=p>)</span> <span class=k>return</span>
</span></span><span class=line><span class=cl>  <span class=nx>isStaticKey</span> <span class=o>=</span> <span class=nx>genStaticKeysCached</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>staticKeys</span> <span class=o>||</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>isPlatformReservedTag</span> <span class=o>=</span> <span class=nx>options</span><span class=p>.</span><span class=nx>isReservedTag</span> <span class=o>||</span> <span class=nx>no</span>
</span></span><span class=line><span class=cl>  <span class=c1>// first pass: mark all non-static nodes.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>markStatic</span><span class=p>(</span><span class=nx>root</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// second pass: mark static roots.
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>markStaticRoots</span><span class=p>(</span><span class=nx>root</span><span class=p>,</span> <span class=kc>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>genStaticKeys</span> <span class=p>(</span><span class=nx>keys</span><span class=o>:</span> <span class=nx>string</span><span class=p>)</span><span class=o>:</span> <span class=nb>Function</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>makeMap</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;type,tag,attrsList,attrsMap,plain,parent,children,attrs,start,end,rawAttrsMap&#39;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nx>keys</span> <span class=o>?</span> <span class=s1>&#39;,&#39;</span> <span class=o>+</span> <span class=nx>keys</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>isStatic 是对⼀个 AST 元素节点是否是静态的判断，如果是表达式，就是非静态；如果是<strong>纯文本</strong>， 就是静态；对于⼀个<strong>普通元素</strong>，如果<strong>有 pre 属性</strong>，那么它使用了 v-pre 指令，是静态，否则要同时 满⾜以下条件：**没有使用 v-if 、 v-for ，没有使用其它指令（不包括 v-once ），非内置组件， 是平台保留的标签，非带有 v-for 的 template 标签的直接子节点，节点的所有属性的 key 都满足静态 key；**这些都满⾜则这个 AST 节点是⼀个静态节点。</p><p>如果这个节点是⼀个普通元素，则遍历它的所有 children ，递归执⾏ markStatic 。因为所有的 elseif 和 else 节点都不在 children 中， 如果节点的 ifConditions 不为空，则遍历 ifConditions 拿到所有条件中的 block ，也就是它们对应的 AST 节点，递归执⾏ markStatic 。<strong>在这些递归过程中，⼀旦子节点有不是 static 的情况，则它的⽗节点的 static 均变成 false。</strong></p><a href=#codegen><h3 id=codegen><span class=hanchor arialabel=Anchor># </span>codegen</h3></a><p>将标记完后的对象 生成一个 render 函数</p><a href=#generate><h4 id=generate><span class=hanchor arialabel=Anchor># </span>generate</h4></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>generate</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>ast</span><span class=o>:</span> <span class=nx>ASTElement</span> <span class=o>|</span> <span class=k>void</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>options</span><span class=o>:</span> <span class=nx>CompilerOptions</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=nx>CodegenResult</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>state</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>CodegenState</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>code</span> <span class=o>=</span> <span class=nx>ast</span> <span class=o>?</span> <span class=nx>genElement</span><span class=p>(</span><span class=nx>ast</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span> <span class=o>:</span> <span class=s1>&#39;_c(&#34;div&#34;)&#39;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>render</span><span class=o>:</span> <span class=sb>`with(this){return </span><span class=si>${</span><span class=nx>code</span><span class=si>}</span><span class=sb>}`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>staticRenderFns</span><span class=o>:</span> <span class=nx>state</span><span class=p>.</span><span class=nx>staticRenderFns</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>遇到不同的指令如何去生成</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>genElement</span> <span class=p>(</span><span class=nx>el</span><span class=o>:</span> <span class=nx>ASTElement</span><span class=p>,</span> <span class=nx>state</span><span class=o>:</span> <span class=nx>CodegenState</span><span class=p>)</span><span class=o>:</span> <span class=nx>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>parent</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>el</span><span class=p>.</span><span class=nx>pre</span> <span class=o>=</span> <span class=nx>el</span><span class=p>.</span><span class=nx>pre</span> <span class=o>||</span> <span class=nx>el</span><span class=p>.</span><span class=nx>parent</span><span class=p>.</span><span class=nx>pre</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>staticRoot</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>el</span><span class=p>.</span><span class=nx>staticProcessed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>genStatic</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>once</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>el</span><span class=p>.</span><span class=nx>onceProcessed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>genOnce</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=k>for</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>el</span><span class=p>.</span><span class=nx>forProcessed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>genFor</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=k>if</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>el</span><span class=p>.</span><span class=nx>ifProcessed</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>genIf</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>tag</span> <span class=o>===</span> <span class=s1>&#39;template&#39;</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>el</span><span class=p>.</span><span class=nx>slotTarget</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>state</span><span class=p>.</span><span class=nx>pre</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>genChildren</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span> <span class=o>||</span> <span class=s1>&#39;void 0&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>tag</span> <span class=o>===</span> <span class=s1>&#39;slot&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>genSlot</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// component or element
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>code</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>component</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>code</span> <span class=o>=</span> <span class=nx>genComponent</span><span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>component</span><span class=p>,</span> <span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>data</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>el</span><span class=p>.</span><span class=nx>plain</span> <span class=o>||</span> <span class=p>(</span><span class=nx>el</span><span class=p>.</span><span class=nx>pre</span> <span class=o>&amp;&amp;</span> <span class=nx>state</span><span class=p>.</span><span class=nx>maybeComponent</span><span class=p>(</span><span class=nx>el</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>data</span> <span class=o>=</span> <span class=nx>genData</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>children</span> <span class=o>=</span> <span class=nx>el</span><span class=p>.</span><span class=nx>inlineTemplate</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=nx>genChildren</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>code</span> <span class=o>=</span> <span class=sb>`_c(&#39;</span><span class=si>${</span><span class=nx>el</span><span class=p>.</span><span class=nx>tag</span><span class=si>}</span><span class=sb>&#39;</span><span class=si>${</span>
</span></span><span class=line><span class=cl>        <span class=nx>data</span> <span class=o>?</span> <span class=sb>`,</span><span class=si>${</span><span class=nx>data</span><span class=si>}</span><span class=sb>`</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span> <span class=c1>// data
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=si>}${</span>
</span></span><span class=line><span class=cl>        <span class=nx>children</span> <span class=o>?</span> <span class=sb>`,</span><span class=si>${</span><span class=nx>children</span><span class=si>}</span><span class=sb>`</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span> <span class=c1>// children
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=si>}</span><span class=sb>)`</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// module transforms
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>state</span><span class=p>.</span><span class=nx>transforms</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>code</span> <span class=o>=</span> <span class=nx>state</span><span class=p>.</span><span class=nx>transforms</span><span class=p>[</span><span class=nx>i</span><span class=p>](</span><span class=nx>el</span><span class=p>,</span> <span class=nx>code</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>code</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#扩展><h2 id=扩展><span class=hanchor arialabel=Anchor># </span>扩展</h2></a><a href=#event><h3 id=event><span class=hanchor arialabel=Anchor># </span>event</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src/compiler/parser/index.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>onRE</span> <span class=o>=</span> <span class=sr>/^@|^v-on:/</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>dirRE</span> <span class=o>=</span> <span class=sr>/^v-|^@|^:/</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>bindRE</span> <span class=o>=</span> <span class=sr>/^:|^v-bind:/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>processAtts</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>     <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>onRE</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>name</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// v-on
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>name</span> <span class=o>=</span> <span class=nx>name</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=nx>onRE</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>isDynamic</span> <span class=o>=</span> <span class=nx>dynamicArgRE</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>isDynamic</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>name</span> <span class=o>=</span> <span class=nx>name</span><span class=p>.</span><span class=nx>slice</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>addHandler</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>modifiers</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>warn</span><span class=p>,</span> <span class=nx>list</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>isDynamic</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在遇到上面几个正则后，会进行名字的 addListener 监听事件</p><a href=#自定义事件><h3 id=自定义事件><span class=hanchor arialabel=Anchor># </span>自定义事件</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>eventsMixin</span> <span class=p>(</span><span class=nx>Vue</span><span class=o>:</span> <span class=nx>Class</span><span class=o>&lt;</span><span class=nx>Component</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>hookRE</span> <span class=o>=</span> <span class=sr>/^hook:/</span>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$on</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>,</span> <span class=nx>fn</span><span class=o>:</span> <span class=nb>Function</span><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>event</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span><span class=p>.</span><span class=nx>$on</span><span class=p>(</span><span class=nx>event</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>fn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span><span class=p>[</span><span class=nx>event</span><span class=p>]</span> <span class=o>||</span> <span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span><span class=p>[</span><span class=nx>event</span><span class=p>]</span> <span class=o>=</span> <span class=p>[])).</span><span class=nx>push</span><span class=p>(</span><span class=nx>fn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=c1>// optimize hook:event cost by using a boolean flag marked at registration
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// instead of a hash lookup
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>hookRE</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>event</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span><span class=p>.</span><span class=nx>_hasHookEvent</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$once</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=o>:</span> <span class=nx>string</span><span class=p>,</span> <span class=nx>fn</span><span class=o>:</span> <span class=nb>Function</span><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=kd>function</span> <span class=nx>on</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>$off</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span> <span class=nx>on</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>fn</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>vm</span><span class=p>,</span> <span class=nx>arguments</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>on</span><span class=p>.</span><span class=nx>fn</span> <span class=o>=</span> <span class=nx>fn</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>$on</span><span class=p>(</span><span class=nx>event</span><span class=p>,</span> <span class=nx>on</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$off</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=o>?:</span> <span class=nx>string</span> <span class=o>|</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>,</span> <span class=nx>fn</span><span class=o>?:</span> <span class=nb>Function</span><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=c1>// all
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>arguments</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// array of events
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>event</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vm</span><span class=p>.</span><span class=nx>$off</span><span class=p>(</span><span class=nx>event</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>fn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// specific event
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>cbs</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span><span class=p>[</span><span class=nx>event</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>cbs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>fn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span><span class=p>[</span><span class=nx>event</span><span class=p>]</span> <span class=o>=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// specific handler
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>cb</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>length</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=nx>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>cb</span> <span class=o>=</span> <span class=nx>cbs</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>cb</span> <span class=o>===</span> <span class=nx>fn</span> <span class=o>||</span> <span class=nx>cb</span><span class=p>.</span><span class=nx>fn</span> <span class=o>===</span> <span class=nx>fn</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>cbs</span><span class=p>.</span><span class=nx>splice</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>prototype</span><span class=p>.</span><span class=nx>$emit</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=o>:</span> <span class=nx>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>Component</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vm</span><span class=o>:</span> <span class=nx>Component</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>!==</span> <span class=s1>&#39;production&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>lowerCaseEvent</span> <span class=o>=</span> <span class=nx>event</span><span class=p>.</span><span class=nx>toLowerCase</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>lowerCaseEvent</span> <span class=o>!==</span> <span class=nx>event</span> <span class=o>&amp;&amp;</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span><span class=p>[</span><span class=nx>lowerCaseEvent</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>tip</span><span class=p>(</span>
</span></span><span class=line><span class=cl>          <span class=sb>`Event &#34;</span><span class=si>${</span><span class=nx>lowerCaseEvent</span><span class=si>}</span><span class=sb>&#34; is emitted in component `</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=sb>`</span><span class=si>${</span><span class=nx>formatComponentName</span><span class=p>(</span><span class=nx>vm</span><span class=p>)</span><span class=si>}</span><span class=sb> but the handler is registered for &#34;</span><span class=si>${</span><span class=nx>event</span><span class=si>}</span><span class=sb>&#34;. `</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=sb>`Note that HTML attributes are case-insensitive and you cannot use `</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=sb>`v-on to listen to camelCase events when using in-DOM templates. `</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>          <span class=sb>`You should probably use &#34;</span><span class=si>${</span><span class=nx>hyphenate</span><span class=p>(</span><span class=nx>event</span><span class=p>)</span><span class=si>}</span><span class=sb>&#34; instead of &#34;</span><span class=si>${</span><span class=nx>event</span><span class=si>}</span><span class=sb>&#34;.`</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>cbs</span> <span class=o>=</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>_events</span><span class=p>[</span><span class=nx>event</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cbs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>cbs</span> <span class=o>=</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=o>?</span> <span class=nx>toArray</span><span class=p>(</span><span class=nx>cbs</span><span class=p>)</span> <span class=o>:</span> <span class=nx>cbs</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>args</span> <span class=o>=</span> <span class=nx>toArray</span><span class=p>(</span><span class=nx>arguments</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>info</span> <span class=o>=</span> <span class=sb>`event handler for &#34;</span><span class=si>${</span><span class=nx>event</span><span class=si>}</span><span class=sb>&#34;`</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>cbs</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>invokeWithErrorHandling</span><span class=p>(</span><span class=nx>cbs</span><span class=p>[</span><span class=nx>i</span><span class=p>],</span> <span class=nx>vm</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=nx>vm</span><span class=p>,</span> <span class=nx>info</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vm</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在实例 vm 上注册了事件中心 <code>_events</code> ,标准的发布订阅模式</p><a href=#v-model><h3 id=v-model><span class=hanchor arialabel=Anchor># </span>V-model</h3></a><p>事实上只是一种语法糖，对于 input 来说 就是@input 和:bind:value 的语法糖，当你使用组件，仍想使用 V-model 也可以这么使用，另外 Vue 也提供了 model 对象进行这两个属性更改别名的方式</p><a href=#slot><h3 id=slot><span class=hanchor arialabel=Anchor># </span>Slot</h3></a><p>当遇到 slot 标签的时候会给对应的 AST 元素节点添加 slotName 属性，然后在 codegen 阶段， 会判断如果当前 AST 元素节点是 slot 标签，则执行 genSlot 函数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>slotName</span> <span class=o>=</span> <span class=nx>el</span><span class=p>.</span><span class=nx>slotName</span> <span class=o>||</span> <span class=s1>&#39;&#34;default&#34;&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>children</span> <span class=o>=</span> <span class=nx>genChildren</span><span class=p>(</span><span class=nx>el</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>res</span> <span class=o>=</span> <span class=sb>`_t(</span><span class=si>${</span><span class=nx>slotName</span><span class=si>}${</span><span class=nx>children</span> <span class=o>?</span> <span class=sb>`,</span><span class=si>${</span><span class=nx>children</span><span class=si>}</span><span class=sb>`</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=si>}</span><span class=sb>`</span>
</span></span></code></pre></td></tr></table></div></div><p>vm.$slots 是通过执行 resolveSlots(options._renderChildren, renderContext) 返回的，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>resolveSlots</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span><span class=o>:</span> <span class=o>?</span><span class=nb>Array</span><span class=o>&lt;</span><span class=nx>VNode</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>context</span><span class=o>:</span> <span class=o>?</span><span class=nx>Component</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>]</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>VNode</span><span class=o>&gt;</span> <span class=p>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>children</span> <span class=o>||</span> <span class=o>!</span><span class=nx>children</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>slots</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>l</span> <span class=o>=</span> <span class=nx>children</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>l</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>child</span> <span class=o>=</span> <span class=nx>children</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>child</span><span class=p>.</span><span class=nx>data</span>
</span></span><span class=line><span class=cl>    <span class=c1>// remove slot attribute if the node is resolved as a Vue slot node
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nx>data</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>attrs</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>attrs</span><span class=p>.</span><span class=nx>slot</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>delete</span> <span class=nx>data</span><span class=p>.</span><span class=nx>attrs</span><span class=p>.</span><span class=nx>slot</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// named slots should only be respected if the vnode was rendered in the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// same context.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>((</span><span class=nx>child</span><span class=p>.</span><span class=nx>context</span> <span class=o>===</span> <span class=nx>context</span> <span class=o>||</span> <span class=nx>child</span><span class=p>.</span><span class=nx>fnContext</span> <span class=o>===</span> <span class=nx>context</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>slot</span> <span class=o>!=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>slot</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>slot</span> <span class=o>=</span> <span class=p>(</span><span class=nx>slots</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>||</span> <span class=p>(</span><span class=nx>slots</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]))</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>child</span><span class=p>.</span><span class=nx>tag</span> <span class=o>===</span> <span class=s1>&#39;template&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>slot</span><span class=p>.</span><span class=nx>push</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>slot</span><span class=p>,</span> <span class=nx>child</span><span class=p>.</span><span class=nx>children</span> <span class=o>||</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>slot</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>child</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=nx>slots</span><span class=p>.</span><span class=k>default</span> <span class=o>||</span> <span class=p>(</span><span class=nx>slots</span><span class=p>.</span><span class=k>default</span> <span class=o>=</span> <span class=p>[])).</span><span class=nx>push</span><span class=p>(</span><span class=nx>child</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ignore slots that contains only whitespace
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>name</span> <span class=k>in</span> <span class=nx>slots</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>slots</span><span class=p>[</span><span class=nx>name</span><span class=p>].</span><span class=nx>every</span><span class=p>(</span><span class=nx>isWhitespace</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>delete</span> <span class=nx>slots</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>slots</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>resolveSlots 函数的逻辑就是遍历 chilren ，拿到每⼀个 child 的 data ，然后通过 data.slot 获取到插槽名称，这个 slot 就是我们之前编译父组件在 codegen 阶段设置的 data.slot 。接着以插槽名称为 key 把 child 添加到 slots 中，如果 data.slot 不存在， 则是默认插槽的内容，则把对应的 child 添加到 slots.defaults 中。这样就获取到整个 slots ，它是⼀个对象， key 是插槽名称， value 是⼀个 vnode 类型的数组，因为它可以有多 个同名插槽。</p><a href=#keep-alive><h3 id=keep-alive><span class=hanchor arialabel=Anchor># </span>keep-alive</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=cm>/* @flow */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>isRegExp</span><span class=p>,</span> <span class=nx>remove</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;shared/util&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>getFirstComponentChild</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;core/vdom/helpers/index&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>type</span> <span class=nx>VNodeCache</span> <span class=o>=</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>]</span><span class=o>:</span> <span class=o>?</span><span class=nx>VNode</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>getComponentName</span> <span class=p>(</span><span class=nx>opts</span><span class=o>:</span> <span class=o>?</span><span class=nx>VNodeComponentOptions</span><span class=p>)</span><span class=o>:</span> <span class=o>?</span><span class=nx>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>opts</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>options</span><span class=p>.</span><span class=nx>name</span> <span class=o>||</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>tag</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>matches</span> <span class=p>(</span><span class=nx>pattern</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=nb>RegExp</span> <span class=o>|</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>,</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>string</span><span class=p>)</span><span class=o>:</span> <span class=kr>boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>pattern</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>pattern</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>pattern</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>pattern</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>).</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>isRegExp</span><span class=p>(</span><span class=nx>pattern</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>pattern</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* istanbul ignore next */</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>pruneCache</span> <span class=p>(</span><span class=nx>keepAliveInstance</span><span class=o>:</span> <span class=nx>any</span><span class=p>,</span> <span class=nx>filter</span><span class=o>:</span> <span class=nb>Function</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>cache</span><span class=p>,</span> <span class=nx>keys</span><span class=p>,</span> <span class=nx>_vnode</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>keepAliveInstance</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>key</span> <span class=k>in</span> <span class=nx>cache</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>cachedNode</span><span class=o>:</span> <span class=o>?</span><span class=nx>VNode</span> <span class=o>=</span> <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>cachedNode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>name</span><span class=o>:</span> <span class=o>?</span><span class=nx>string</span> <span class=o>=</span> <span class=nx>getComponentName</span><span class=p>(</span><span class=nx>cachedNode</span><span class=p>.</span><span class=nx>componentOptions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>name</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nx>filter</span><span class=p>(</span><span class=nx>name</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>pruneCacheEntry</span><span class=p>(</span><span class=nx>cache</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>keys</span><span class=p>,</span> <span class=nx>_vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>pruneCacheEntry</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>cache</span><span class=o>:</span> <span class=nx>VNodeCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>keys</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nx>string</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>current</span><span class=o>?:</span> <span class=nx>VNode</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>cached</span> <span class=o>=</span> <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>cached</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=nx>current</span> <span class=o>||</span> <span class=nx>cached</span><span class=p>.</span><span class=nx>tag</span> <span class=o>!==</span> <span class=nx>current</span><span class=p>.</span><span class=nx>tag</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>cached</span><span class=p>.</span><span class=nx>componentInstance</span><span class=p>.</span><span class=nx>$destroy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>  <span class=nx>remove</span><span class=p>(</span><span class=nx>keys</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>patternTypes</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nb>Function</span><span class=o>&gt;</span> <span class=o>=</span> <span class=p>[</span><span class=nb>String</span><span class=p>,</span> <span class=nb>RegExp</span><span class=p>,</span> <span class=nb>Array</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;keep-alive&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=kr>abstract</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>props</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>include</span><span class=o>:</span> <span class=nx>patternTypes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>exclude</span><span class=o>:</span> <span class=nx>patternTypes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>max</span><span class=o>:</span> <span class=p>[</span><span class=nb>String</span><span class=p>,</span> <span class=nb>Number</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>created</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>cache</span> <span class=o>=</span> <span class=nb>Object</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>keys</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>destroyed</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>key</span> <span class=k>in</span> <span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pruneCacheEntry</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>cache</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>keys</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>mounted</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>$watch</span><span class=p>(</span><span class=s1>&#39;include&#39;</span><span class=p>,</span> <span class=nx>val</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pruneCache</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>name</span> <span class=p>=&gt;</span> <span class=nx>matches</span><span class=p>(</span><span class=nx>val</span><span class=p>,</span> <span class=nx>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>$watch</span><span class=p>(</span><span class=s1>&#39;exclude&#39;</span><span class=p>,</span> <span class=nx>val</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pruneCache</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>name</span> <span class=p>=&gt;</span> <span class=o>!</span><span class=nx>matches</span><span class=p>(</span><span class=nx>val</span><span class=p>,</span> <span class=nx>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>render</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>slot</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>$slots</span><span class=p>.</span><span class=k>default</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>vnode</span><span class=o>:</span> <span class=nx>VNode</span> <span class=o>=</span> <span class=nx>getFirstComponentChild</span><span class=p>(</span><span class=nx>slot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>componentOptions</span><span class=o>:</span> <span class=o>?</span><span class=nx>VNodeComponentOptions</span> <span class=o>=</span> <span class=nx>vnode</span> <span class=o>&amp;&amp;</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>componentOptions</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>componentOptions</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// check pattern
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>name</span><span class=o>:</span> <span class=o>?</span><span class=nx>string</span> <span class=o>=</span> <span class=nx>getComponentName</span><span class=p>(</span><span class=nx>componentOptions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>include</span><span class=p>,</span> <span class=nx>exclude</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1>// not included
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>(</span><span class=nx>include</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=nx>name</span> <span class=o>||</span> <span class=o>!</span><span class=nx>matches</span><span class=p>(</span><span class=nx>include</span><span class=p>,</span> <span class=nx>name</span><span class=p>)))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=c1>// excluded
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>(</span><span class=nx>exclude</span> <span class=o>&amp;&amp;</span> <span class=nx>name</span> <span class=o>&amp;&amp;</span> <span class=nx>matches</span><span class=p>(</span><span class=nx>exclude</span><span class=p>,</span> <span class=nx>name</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>cache</span><span class=p>,</span> <span class=nx>keys</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>key</span><span class=o>:</span> <span class=o>?</span><span class=nx>string</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>key</span> <span class=o>==</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>        <span class=c1>// same constructor may get registered as different local components
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// so cid alone is not enough (#3269)
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>?</span> <span class=nx>componentOptions</span><span class=p>.</span><span class=nx>Ctor</span><span class=p>.</span><span class=nx>cid</span> <span class=o>+</span> <span class=p>(</span><span class=nx>componentOptions</span><span class=p>.</span><span class=nx>tag</span> <span class=o>?</span> <span class=sb>`::</span><span class=si>${</span><span class=nx>componentOptions</span><span class=p>.</span><span class=nx>tag</span><span class=si>}</span><span class=sb>`</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>key</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span> <span class=o>=</span> <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>].</span><span class=nx>componentInstance</span>
</span></span><span class=line><span class=cl>        <span class=c1>// make current key freshest
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>remove</span><span class=p>(</span><span class=nx>keys</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>keys</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>cache</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=o>=</span> <span class=nx>vnode</span>
</span></span><span class=line><span class=cl>        <span class=nx>keys</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// prune oldest entry
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>max</span> <span class=o>&amp;&amp;</span> <span class=nx>keys</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=nb>parseInt</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>max</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>pruneCacheEntry</span><span class=p>(</span><span class=nx>cache</span><span class=p>,</span> <span class=nx>keys</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>keys</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>_vnode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>keepAlive</span> <span class=o>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>vnode</span> <span class=o>||</span> <span class=p>(</span><span class=nx>slot</span> <span class=o>&amp;&amp;</span> <span class=nx>slot</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>注意它有⼀个属性 abstract 为 true，是⼀个抽象组件，Vue 的⽂档没有提这个概念，实际上它在组件实例建立父子关系的时候会被忽略，</p><p>include 和 exclude 可以传入动态值是因为在 watch 中监听变化</p><p><strong>在 created 钩子里定义了 this.cache 和 this.keys ，本质上它就是去缓存已经创建过的 vnode 。</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>slot</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>$slots</span><span class=p>.</span><span class=k>default</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>vnode</span><span class=o>:</span> <span class=nx>VNode</span> <span class=o>=</span> <span class=nx>getFirstComponentChild</span><span class=p>(</span><span class=nx>slot</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>**keep-alive 只缓存第一个子元素！**所以⼀般和它搭配使用的有 component 动态组件或者是 router-view</p><p>当再次来到 creteEle 的时候 isReactivated 为 true，<strong>并且在执行 init 钩子函数的时候不会执行组件的 mount 过程了</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl><span class=c1>//src/core/vdom/create-component.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>init</span> <span class=p>(</span><span class=nx>vnode</span><span class=o>:</span> <span class=nx>VNodeWithData</span><span class=p>,</span> <span class=nx>hydrating</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>)</span><span class=o>:</span> <span class=o>?</span><span class=kr>boolean</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=o>!</span><span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span><span class=p>.</span><span class=nx>_isDestroyed</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=nx>vnode</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>keepAlive</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// kept-alive components, treat as a patch
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>mountedNode</span><span class=o>:</span> <span class=nx>any</span> <span class=o>=</span> <span class=nx>vnode</span> <span class=c1>// work around flow
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>componentVNodeHooks</span><span class=p>.</span><span class=nx>prepatch</span><span class=p>(</span><span class=nx>mountedNode</span><span class=p>,</span> <span class=nx>mountedNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>child</span> <span class=o>=</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>componentInstance</span> <span class=o>=</span> <span class=nx>createComponentInstanceForVnode</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>vnode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>activeInstance</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nx>child</span><span class=p>.</span><span class=nx>$mount</span><span class=p>(</span><span class=nx>hydrating</span> <span class=o>?</span> <span class=nx>vnode</span><span class=p>.</span><span class=nx>elm</span> <span class=o>:</span> <span class=kc>undefined</span><span class=p>,</span> <span class=nx>hydrating</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span></code></pre></td></tr></table></div></div><a href=#transition><h3 id=transition><span class=hanchor arialabel=Anchor># </span>transition</h3></a><p>在下列情形中，可以给任何元素和组件添加 entering/leaving 过渡：</p><ul><li>条件渲染 (使用 v-if )</li><li>条件展示 (使用 v-show )</li><li>动态组件</li><li>组件根节点</li></ul><p>在 vnode patch 的过程中，对于过渡的实现，<strong>它只接收了 create 和 activate 2 个钩子函数</strong>，我们知道 create 钩子函数只有当节点的创建过程才会执行，而 remove 会在节点销毁的时候执行，这也就印证了 必须要满⾜ v-if 、动态组件、组件根节点条件之⼀了，</p><p>总结起来，Vue 的过渡实现分为以下几个步骤：</p><ol><li>⾃动嗅探目标元素是否应用了 CSS 过渡或动画，如果是，在恰当的时机添加/删除 CSS 类名。</li><li>如果过渡组件提供了 JavaScript 钩子函数，这些钩子函数将在恰当的时机被调用。</li><li>如果没有找到 JavaScript 钩子并且也没有检测到 CSS 过渡/动画，DOM 操作 (插入/删除) 在下⼀帧 中立即执行。</li></ol><a href=#vue-route><h2 id=vue-route><span class=hanchor arialabel=Anchor># </span>Vue-Route</h2></a><a href=#vueuse><h3 id=vueuse><span class=hanchor arialabel=Anchor># </span>Vue.use</h3></a><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-JavaScript data-lang=JavaScript><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>initUse</span> <span class=p>(</span><span class=nx>Vue</span><span class=o>:</span> <span class=nx>GlobalAPI</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Vue</span><span class=p>.</span><span class=nx>use</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>plugin</span><span class=o>:</span> <span class=nb>Function</span> <span class=o>|</span> <span class=nb>Object</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>installedPlugins</span> <span class=o>=</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>_installedPlugins</span> <span class=o>||</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>_installedPlugins</span> <span class=o>=</span> <span class=p>[]))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>installedPlugins</span><span class=p>.</span><span class=nx>indexOf</span><span class=p>(</span><span class=nx>plugin</span><span class=p>)</span> <span class=o>&gt;</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// additional parameters
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>args</span> <span class=o>=</span> <span class=nx>toArray</span><span class=p>(</span><span class=nx>arguments</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>args</span><span class=p>.</span><span class=nx>unshift</span><span class=p>(</span><span class=k>this</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>plugin</span><span class=p>.</span><span class=nx>install</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>plugin</span><span class=p>.</span><span class=nx>install</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>plugin</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>plugin</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>plugin</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=nx>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>installedPlugins</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>plugin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><a href=#vuex><h2 id=vuex><span class=hanchor arialabel=Anchor># </span><a href=/Vuex rel=noopener class=internal-link data-src=/Vuex>Vuex</a></h2></a><a href=#总结-2><h2 id=总结-2><span class=hanchor arialabel=Anchor># </span>总结</h2></a><p>Vue 是一个通过响应式对象 实现的一个 MVVM 框架，他的渲染流程是这样的，他首先其实就是一个构造函数，在初始化的过程中，他把像 extend、use 等等方法挂载到原型链上，然后等待 New 一个新的实例出来， init 中，我们可以分为数据注入和$mount 两个时期</p><p>数据注入是按照</p><ul><li>initLifecycle(vm) // $parent,$root,$children,$refs</li><li>initEvents(vm) // 处理父组件传递的事件和回调</li><li>initRender(vm) // $slots,$scopedSlots,_c,$createElement</li><li><strong>callHook(vm, &lsquo;beforeCreate&rsquo;)</strong></li><li>initInjections(vm) // 获取注入数据</li><li>initState(vm) // 初始化 props，methods，data，computed，watch</li><li>initProvide(vm) // 提供数据注入</li><li><strong>callHook(vm, &lsquo;created&rsquo;)</strong></li></ul><p>这段时期，我们可以清晰的了解到 beforeCreate 和 Create 这两个生命周期可以获取到的数据。对数据的响应式声明也发生在这个阶段。</p><p>然后就进入了$mount 阶段，这个阶段也叫挂载，</p><p>首先 会调用 <code>_render</code> 将 模板转化成 AST、staticRenderFns、render 函数，我们将这个阶段称之为编译阶段</p><p>转化成 AST 这个阶段的过程，有点类似于 HTML 的模板转化， 通过一个栈 进行标签的闭合匹配，通过大量正则进行事件和指令等操作的匹配，最后生成一棵 AST 树，AST 元素节点总共有 3 种类型， type 为 1 表示是普通元素，为 2 表示是表达式，为 3 表示是纯文本。</p><p><strong>&mdash; callHook(<em>vm</em>, &lsquo;beforeMount&rsquo;) &mdash;</strong></p><p>生成以后，要通过标记静态节点来优化这颗 AST 树，到这就要将 AST 树和 options 传入 render 生成真正运行的 code，其中涉及到 vif，vfor 等指令的具体执行</p><p>产生一个组件级别的 Watcher，通过 <code>_update</code>将 VNode 更新成真实 DOM 时，触发了 getter 进行依赖收集</p><p><strong>&mdash; callHook(<em>vm</em>, &lsquo;Mount&rsquo;) &mdash;</strong></p><p>响应式： 最开始 init 时已经对每个数据进行了响应式声明，在$mount 阶段，将 template 转化成 AST 树时，同时也会触发响应式对象的 get 方法，将相应的 watcher push 到 Dep 的 sub 数组里，这里有一个细节，他在全局声明了一个 Dep.target,保证同时只有一个 watcher 在执行，</p><p>然后就是</p><p>触发更新时，Dep 接受到变化通知，通知内部的 watcher 进行视图更新，Watcher 内部有新旧 Dep 两个数组，他会先去取消旧 Watcher 的订阅，然后执行 watcher.run()会进入队列进行一波去重，然后异步去调用 patch，patch 这边也重新生成一个 Vnode Tree 与旧 tree 进行 diff 算法。</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>反向链接</h3><ul class=backlinks><li><a href=/%E6%AC%A2%E8%81%9A%E6%97%B6%E4%BB%A3/ data-ctx=Vue2源码阅读#深入响应式原理 data-src=/%E6%AC%A2%E8%81%9A%E6%97%B6%E4%BB%A3 class=internal-link>欢聚时代</a></li><li><a href=/Vue/ data-ctx="Vue2 源码阅读" data-src=/Vue class=internal-link>Vue</a></li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>内部链接关系图</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://note.xiaopang.fun/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><hr><script src=https://giscus.app/client.js data-repo=chelseachen007/ObPublish data-repo-id=R_kgDOJSeHfQ data-category=General data-category-id=DIC_kwDOJSeHfc4CXVcx data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><center><script>var caution=!1,now,visits;function setCookie(e,t,n,s,o,a){var i=e+"="+escape(t)+(n?"; expires="+n.toGMTString():"")+(s?"; path="+s:"")+(o?"; domain="+o:"")+(a?"; secure":"");!caution||(e+"="+escape(t)).length<=4e3?document.cookie=i:confirm("Cookie exceeds 4KB and will be cut!")&&(document.cookie=i)}function getCookie(s){var e=s+"=",n,t=document.cookie.indexOf(e);return t==-1?null:(n=document.cookie.indexOf(";",t+e.length),n==-1&&(n=document.cookie.length),unescape(document.cookie.substring(t+e.length,n)))}function deleteCookie(e,t,n){getCookie(e)&&(document.cookie=e+"="+(t?"; path="+t:"")+(n?"; domain="+n:"")+"; expires=Thu, 01-Jan-70 00:00:01 GMT")}function fixDate(e){var n=new Date(0),t=n.getTime();t>0&&e.setTime(e.getTime()-t)}now=new Date,fixDate(now),now.setTime(now.getTime()+730*24*60*60*1e3),visits=getCookie("counter"),visits?visits=parseInt(visits)+1:visits=1,setCookie("counter",visits,now),document.write("<font size=2>👋访问量："+visits+"")</script></center></div></body></html>