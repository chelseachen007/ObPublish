---
tags:
title: 三级目录组件
date created: 2023-04-04
date modified: 2023-04-26
---

# 三级目录组件

## 难点

## Code

```js
import React, { useEffect, useState } from 'react';

import _ from 'lodash';

import styled from 'styled-components';

import {

message,

Divider,

Checkbox,

Input,

Button,

Modal,

Popover,

Tooltip,

} from 'antd';

import {

FolderOutlined,

PlusCircleOutlined,

MinusCircleOutlined,

CloseCircleOutlined,

TagOutlined,

PlusOutlined,

ExclamationCircleOutlined,

} from '@ant-design/icons';

import LabelUpdateModal from './LabelUpdateModal';

import { calcLength } from '@/shared/utils';



const { confirm } = Modal;



interface ITreeGraphProps {

isEdit: boolean;

treeData: any;

businessRange: any;

refreshList: () => void;

}



const STreeGraph = styled.div`

display: flex;

align-items: flex-start;

font-size: 12px;

padding-top: 16px;

.category-box {

width: 168px;

position: relative;

padding: 6px 12px;

border: 1px solid #d9d9d9;

border-radius: 4px;

// text-align: center;

.switch {

position: absolute;

top: 50%;

left: 100%;

margin-left: 8px;

transform: translateY(-40%);

cursor: pointer;

}

.add-button {

width: 168px;

position: absolute;

top: 100%;

left: 0%;

padding: 6px 12px;

margin-top: 16px;

color: #8d8e99;

border: 1px solid #d9d9d9;

border-radius: 4px;

cursor: pointer;

}

.delete {

position: absolute;

top: 0%;

right: 0%;

line-height: 1;

transform: translate(50%, -50%);

background-color: #fff;

cursor: pointer;

}

}

.second-category {

flex: 1;

display: flex;

flex-direction: column;

margin-left: 14px;

.item {

display: flex;

align-items: flex-start;

height: 100%;

.vertical-line {

width: 9px;

border-left: 1px solid #dedede;

margin: -16px 0 0;

align-self: stretch;

}

&-second {

display: flex;

align-items: center;

.vertical-line {

display: block !important;

width: 9px;

border-left: 1px solid #dedede;

border-bottom: 1px solid #dedede;

border-bottom-left-radius: 4px;

margin: -16px 0 15px;

}

.horizontal-line {

width: 74px;

height: 1px;

background-color: #d9d9d9;

}

.horizontal-line-right {

width: 52px;

height: 1px;

background-color: #d9d9d9;

}

}

.label-content {

flex: 1;

display: flex;

.vertical-line {

display: block !important;

width: 9px;

border-left: 1px solid #dedede !important;

border-bottom: 1px solid #dedede;

border-bottom-left-radius: 4px;

margin: 16px 0 35px !important;

}

.label-container {

flex: 1;

display: flex;

flex-direction: column;

.item-label {

flex: 1;

display: flex;

align-items: center;

.horizontal-line {

width: 60px;

height: 1px;

background-color: #d9d9d9;

}

.label-box {

flex: 1;

height: 72px;

display: flex;

justify-content: space-between;

padding: 12px 16px;

border: 1px solid #d9d9d9;

border-radius: 4px;

.label-info {

width: 0;

flex: 1;

flex-shrink: 0;

margin: 0 8px;

.description {

white-space: nowrap;

overflow: hidden;

text-overflow: ellipsis;

margin-top: 10px;

color: #979797;

}

}

.label-operation {

flex-shrink: 0;

align-self: center;

color: #4a96ff;

span {

cursor: pointer;

}

}

}

}

.item-label:first-child {

align-items: stretch;

.horizontal-line {

margin-top: 16px;

}

}

.item-label:not(:first-child) {

margin-top: 20px;

}

.item-label:not(:last-child) {

.horizontal-line {

width: 68px;

margin-left: -8px;

}

}

}

}

}

.item:not(:first-child) {

margin-top: 16px;

}

.item:not(:first-child):not(:last-child) {

.item-second .horizontal-line {

margin-left: -8px;

width: 82px;

}

}

.item:first-child {

.vertical-line {

margin-top: 24px;

}

}

.item:last-child {

.vertical-line {

display: none;

}

}

.item:first-child:last-child {

.vertical-line {

display: block;

border-left: none;

}

}

.item:not(:last-child) {

.item-second .category-box .add-button {

display: none;

}

.item-second .vertical-line {

display: none !important;

}

.label-content .batch-operation {

display: none;

}

}

.ant-checkbox-group {

font-size: 12px;

}

.batch-operation {

height: 36px;

margin: 20px 0 0 380px;

}

}

`;

const TreeGraph = (props: ITreeGraphProps) => {

const { isEdit, treeData, refreshList, businessRange } = props;

const plainOptions = treeData.childTypes

.map((f: any) => f.labels)

.flat(2)

.map((l: any) => String(l.labelId));

const [isOpen, setIsOpen] = useState<boolean>(false);

const [indeterminate, setIndeterminate] = useState<boolean>(false);

const [checkAll, setCheckAll] = useState<boolean>(false);

const [checkedList, setCheckedList] = useState<string[]>([]);

const [labelUpdateModalVisible, setLabelUpdateModalVisible] =

useState<boolean>(false);

const [updateList, setUpdateList] = useState<number[]>([]);

// const [popoverVisible, setPopoverVisible] = useState<boolean>(false);

const [addName, setAddName] = useState<string>('');



// const PER_UPDATE_LABEL =

// _.includes(PERMISSION2.update, businessRange) || false;

useEffect(() => {

setCheckedList([]);

setIndeterminate(false);

setCheckAll(false);

}, [isEdit, treeData]);



const onCheckboxChange = (checkedValues: string[]) => {

setCheckedList(checkedValues);

setIndeterminate(

!!checkedValues.length && checkedValues.length < plainOptions.length,

);

setCheckAll(checkedValues.length === plainOptions.length);

};



const onCheckAllChange = (e: any) => {

setCheckedList(e.target.checked ? plainOptions : []);

setIndeterminate(false);

setCheckAll(e.target.checked);

};



const updateCategory = (labelIds: number[]) => {

setUpdateList(labelIds);

setLabelUpdateModalVisible(true);

};



const deleteCategory = (id: number) => {

confirm({

title: '是否确认删除该类目?',

icon: <ExclamationCircleOutlined />,

content: '提示：删除类目后，类目下标签会被删除，且不可恢复，请谨慎操作',

onOk() {

dispatch.labelManage.deleteCategory(id).then(() => {

message.success('删除成功');

refreshList();

});

},

});

};



const deleteLabel = (labelIds: number[]) => {

confirm({

title: '是否确认删除该标签?',

icon: <ExclamationCircleOutlined />,

onOk() {

dispatch.labelManage.deleteLabel(labelIds).then(() => {

message.success('删除成功');

refreshList();

});

},

});

};



const onVisibleChange = (visible: boolean) => {

if (!visible) {

setAddName('');

}

// setPopoverVisible(visible);

};



const addNameChange = (e: any) => {

setAddName(e.target.value);

};



const addCategory = () => {

if (!addName.trim()) {

message.info('请输入类目名称');

return;

}

if (calcLength(addName) > 20) {

message.error('分类名称最大长度为20个字符');

return;

}

const params = {

name: addName,

parentId: treeData.id,

level: 5,

};

ddCategory(params).then(() => {

message.success('添加成功');

setAddName('');

refreshList();

});

};



const popoverContent = (

<div style={{ display: 'flex' }}>

<Input value={addName} size="small" onChange={addNameChange} />

<Button

type="primary"

size="small"

style={{ marginLeft: '16px' }}

onClick={addCategory}

>

确定

</Button>

</div>

);



const finishCallback = () => {

message.success('修改成功');

setCheckedList([]);

setIndeterminate(false);

setCheckAll(false);

setLabelUpdateModalVisible(false);

refreshList();

};



return (

<STreeGraph>

<div className="category-box">

<FolderOutlined style={{ color: '#456CF6', marginRight: '8px' }} />

{treeData.name}

<span className="switch" onClick={() => setIsOpen(!isOpen)}>

{isOpen ? (

<MinusCircleOutlined

style={{ color: '#456CF6', fontSize: '16px' }}

/>

) : (

<PlusCircleOutlined

style={{ color: '#456CF6', fontSize: '16px' }}

/>

)}

</span>

{isEdit && (

<span className="delete" onClick={() => deleteCategory(treeData.id)}>

<CloseCircleOutlined style={{ color: '#456CF6' }} />

</span>

)}

</div>

{isOpen && (

<div className="second-category">

{treeData.childTypes.length > 0 ? (

<Checkbox.Group value={checkedList} onChange={onCheckboxChange}>

{treeData.childTypes.map((childType: any) => (

<div className="item">

<div className="vertical-line" />

<div className="item-second">

{treeData.childTypes.length !== 1 && (

<div className="vertical-line" />

)}

<div className="horizontal-line" />

<div className="category-box">

<FolderOutlined

style={{ color: '#456CF6', marginRight: '8px' }}

/>

{childType.name}

{isEdit && (

<span

className="delete"

onClick={() => deleteCategory(childType.id)}

>

<CloseCircleOutlined style={{ color: '#456CF6' }} />

</span>

)}

{isEdit && (

<Popover

content={popoverContent}

trigger="click"

onVisibleChange={onVisibleChange}

title=""

>

<div className="add-button">

<PlusOutlined

style={{ color: '#456CF6', marginRight: '8px' }}

/>

添加分类

</div>

</Popover>

)}

</div>

{childType.labels.length > 0 && (

<div className="horizontal-line-right" />

)}

</div>

{childType.labels.length > 0 && (

<div className="label-content">

{childType.labels.length !== 1 && (

<div className="vertical-line" />

)}

<div className="label-container">

{childType.labels.map((label: any) => (

<div className="item-label" key={label.labelId}>

<div className="horizontal-line" />

<div className="label-box">

{isEdit ? (

<Checkbox value={String(label.labelId)} />

) : (

<TagOutlined

rotate={270}

style={{ color: '#456CF6', fontSize: '16px' }}

/>

)}

<div className="label-info">

<div>{label.labelName}</div>

<Tooltip title={label.labelDesc}>

<div className="description">

{label.labelDesc}

</div>

</Tooltip>

</div>

{isEdit && (

<div className="label-operation">

{

<span

onClick={() =>

updateCategory([label.labelId])

}

>

修改

</span>

}

{

<>

<Divider

type="vertical"

style={{ color: '#D0CFCF' }}

/>

<span

onClick={() =>

deleteLabel([label.labelId])

}

>

删除

</span>

</>

}

</div>

)}

</div>

</div>

))}

</div>

</div>

)}

</div>

))}

</Checkbox.Group>

) : (

<div>

{isEdit && (

<Popover

content={popoverContent}

trigger="click"

onVisibleChange={onVisibleChange}

title=""

>

<div className="add-button" style={{ margin: '0 0 0 84px' }}>

<PlusOutlined

style={{ color: '#456CF6', marginRight: '8px' }}

/>

添加分类

</div>

</Popover>

)}

</div>

)}

{isEdit && (

<div className="batch-operation">

{plainOptions.length > 0 && (

<div>

<Checkbox

indeterminate={indeterminate}

onChange={onCheckAllChange}

checked={checkAll}

>

全选

</Checkbox>

{

<Button

style={{ marginLeft: 8 }}

disabled={checkedList.length === 0}

onClick={() =>

updateCategory(checkedList.map(item => Number(item)))

}

>

批量修改

</Button>

}

{

<Button

style={{ marginLeft: 8 }}

disabled={checkedList.length === 0}

onClick={() =>

deleteLabel(checkedList.map(item => Number(item)))

}

>

批量删除

</Button>

}

</div>

)}

</div>

)}

</div>

)}

<LabelUpdateModal

visible={labelUpdateModalVisible}

updateList={updateList}

finishCallback={finishCallback}

closeModal={() => setLabelUpdateModalVisible(false)}

/>

</STreeGraph>

);

};



export default TreeGraph;
```
